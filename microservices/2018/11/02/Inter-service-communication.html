<!DOCTYPE html>
<!--suppress ALL -->
<html>
<head>
        <meta charset="utf-8">
    <meta name="description" content="We build innovative solutions with Java and JavaScript. To support this mission, we have several Competence Centers. From within those Competence Centers, we provide coaching to the employee and expert advice towards our customer. In order to keep in sync with the latest technologies and the latest trends, we frequently visit conferences around the globe.
">
    <meta name="keywords" content="Ordina,ORAJ,JWorks,Blog,Java,JavaScript,TypeScript,Angular,DevOps">
    <meta name="author" content="Ordina Belgium">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/img/favicons/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/img/favicons/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/img/favicons/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/favicons/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="/img/favicons/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/img/favicons/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/img/favicons/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/img/favicons/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-128.png" sizes="128x128" />

    

    <!-- Twitter Card data -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Communication in a distributed system with OpenFeign: Tips & Tricks - Kevin Van Houtte">
    <meta name="twitter:description" content="Ordina JWorks Tech Blog">
    <meta name="twitter:image" content="http://ordina-jworks.github.io/img/intercommunication/intercomm_header.jpg"/>

    <!-- Facebook Open Graph -->
    <meta property="og:url" content="http://ordina-jworks.github.io/microservices/2018/11/02/Inter-service-communication.html"/>
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Communication in a distributed system with OpenFeign: Tips & Tricks - Kevin Van Houtte"/>
    <meta property="og:description" content="Ordina JWorks Tech Blog"/>
    <meta property="og:image" content="http://ordina-jworks.github.io/img/intercommunication/intercomm_header.jpg"/>

    
    <title>Communication in a distributed system with OpenFeign: Tips & Tricks - Kevin Van Houtte &mdash; Ordina JWorks Tech Blog</title>
    

        <!-- Styles -->
    <!-- Font awesome CSS -->
    <link href="/css/font-awesome.min.css" rel="stylesheet">
    <!-- Magnific Popup -->
    <link href="/css/magnific-popup.css" rel="stylesheet">
    <!-- Owl carousel -->
    <link href="/css/owl.carousel.css" rel="stylesheet">

    <!-- CSS for this page -->

    <!-- Syntax highlighting -->
    <link href="/css/syntax.css" rel="stylesheet">


    <!--[if lte IE 8]>
    <script src="/js/ie/html5shiv.js"></script><![endif]-->
    <link rel="stylesheet" href="/css/main.css"/>
    <!--[if lte IE 9]>
    <link rel="stylesheet" href="/css/ie9.css"/><![endif]-->
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="/css/ie8.css"/><![endif]-->

    <!-- Custom CSS. Type your CSS code in custom.css file -->
    <link href="/css/custom.css" rel="stylesheet">

    <!-- Vertical timeline -->
	<link rel="stylesheet" href="/css/vertical-timeline/style.css"> <!-- Resource style -->

    <!-- Favicon -->
    <link rel="shortcut icon" href="#">

    <script src="https://use.typekit.net/gzh0mbm.js"></script>
    <script>
        try {
            Typekit.load({async: true});
        } catch (e) {
        }
    </script>
</head>

<body>
<div id="header-image"></div>


<!-- Page Wrapper -->
<div id="page-wrapper">

        <!-- Header -->
    <header id="header">
        <h1>
            <a href="/">
                JWorks Tech Blog
            </a>
        </h1>

        <nav>
            <a href="#menu">Menu</a>
            <form action="/search/" method="get" class="header-search search-form">
                <input type="text" id="search-box-header" name="query" placeholder="Search &hellip;">
            </form>
        </nav>
    </header>

    <!-- Menu -->
    <nav id="menu">
        <div class="inner">
            <h2>Menu</h2>
            <ul class="links">
                <li class="menu-item"><a href="/">Home</a></li>
                <li class="menu-item"><a href="/about">About Us</a></li>
                <li class="menu-item"><a href="/meet-the-team">Meet the team</a></li>
                <li class="menu-item"><a href="/jobs">Jobs</a></li>
                <li class="menu-item"><a href="/search">Search</a></li>
                <li class="menu-item"><a href="/contact">Contact Us</a></li>
            </ul>
            <a href="#" class="close">Close</a>
        </div>
    </nav>

    <section id="banner">
        <header>
            <div class="inner">
                

                <h2>Communication in a distributed system with OpenFeign: Tips & Tricks</h2>
                

                
                    Posted Nov 2, 2018


    in <a href="/categories/microservices/">Microservices</a>



    by
    
        <a href="/author/kevin-van-houtte/">Kevin Van Houtte</a>
        
    



    <br/>
    <i class="fa fa-tags"></i>
    
        <a href="/tags/microservices/">Microservices</a>, 
    
        <a href="/tags/security/">Security</a>, 
    
        <a href="/tags/spring/">Spring</a>, 
    
        <a href="/tags/cloud/">Cloud</a>, 
    
        <a href="/tags/openfeign/">OpenFeign</a>
    

                

                

            </div>
        </header>
    </section>


    <section id="wrapper">
        <div class="inner">
            <section id="one" class="wrapper spotlight style1 post-body">
    <div class="inner" style="text-align: left;">
        <div class="content">
            <p>In contrast to monolithic applications, services in a distributed system are running on multiple machines. 
To let these services interact with each other, we need some kind of inter-process communication mechanism.
With the help of OpenFeign, I will explain how we can fire off synchronous calls to another service.</p>

<h1 id="table-of-contents">Table of contents</h1>
<ol>
  <li><a href="#setup">Setup</a></li>
  <li><a href="#different-kinds-of-http-clients">Different kinds of HTTP clients</a></li>
  <li><a href="#enabling-mutual-ssl">Enabling Mutual SSL</a></li>
  <li><a href="#intercepting-requests">Intercepting requests</a></li>
  <li><a href="#give-it-a-retry">Give it a (re)try</a></li>
  <li><a href="#securing-your-api">Securing your API</a></li>
  <li><a href="#creating-soap-clients">Creating SOAP clients</a></li>
  <li><a href="#handling-errors-with-the-error-decoder">Handling errors with the error decoder</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
</ol>

<h1 id="communication-with-openfeign">Communication with OpenFeign</h1>
<p>To understand the basics of inter-process communication, we need to look at what kind of interactions we can do.
<a href="https://github.com/OpenFeign/feign" target="_blank">OpenFeign</a>, a declarative HTTP client by Netflix simplifies our way of interacting with other services. 
When we decide that it is time to decompose our modulith because of numerous reasons, we would have to look for a way to handle our inter-process communication.</p>

<h1 id="setup">Setup</h1>
<p>To use OpenFeign we need to add it to our classpath</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre></figure>

<p>When we inspect the dependency module, we see that there is a lot coming out-of-the-box with the Spring Cloud Starter.
If you are providing your own resilience or load balancing library you can just add the necessary dependencies you need.
Be aware that the syntax is different between using the Spring wrapper or OpenFeign itself.
To let your Spring context know that it has to search for OpenFeign clients, we just add <code class="language-plaintext highlighter-rouge">@EnableFeignClients</code>. 
You can add this annotation to any class annotated with <code class="language-plaintext highlighter-rouge">@Configuration</code>, <code class="language-plaintext highlighter-rouge">@SpringBootApplication</code> or <code class="language-plaintext highlighter-rouge">@SpringCloudApplication</code>
After weâ€™ve enabled OpenFeign on our classpath, we can start adding OpenFeign clients. 
When defining these clients, we have two solutions you can choose from. 
The OpenFeign library, which provides us with the basics but very customizable OpenFeign clients, and the Spring library, that adds a few extra libraries to it for cloud tooling.</p>

<h2 id="spring">Spring</h2>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@FeignClient</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"auth"</span><span class="o">,</span> <span class="n">fallback</span> <span class="o">=</span> <span class="nc">FallbackAuthClient</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">configuration</span> <span class="o">=</span> <span class="nc">FeignConfig</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AuthClient</span> <span class="o">{</span> 
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s">"checkToken"</span><span class="o">)</span>
    <span class="kt">boolean</span> <span class="nf">isTokenValid</span><span class="o">(</span><span class="nd">@RequestHeader</span><span class="o">(</span><span class="s">"Authorization"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">token</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<ul>
  <li><code class="language-plaintext highlighter-rouge">@FeignClient</code>: is the annotation for Spring to recognize OpenFeign clients, OpenFeign clients have to be interfaces as it is self-declarative.</li>
  <li><code class="language-plaintext highlighter-rouge">value/name</code>: is the name of the Feign client that will be used to create a <a href="https://github.com/Netflix/ribbon" target="_blank">Ribbon</a> load balancer which can then be linked to the target application using service discovery or a fixed list of servers. 
You could also use the url attribute to point your client to the target application when youâ€™re not using Ribbon.</li>
  <li><code class="language-plaintext highlighter-rouge">fallback</code>: if <a href="https://github.com/Netflix/Hystrix" target="_blank">Hystrix</a> is enabled, you can implement a fallback method.</li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FallbackAuthClient</span> <span class="kd">implements</span> <span class="nc">AuthClient</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isTokenValid</span><span class="o">(</span><span class="nd">@RequestHeader</span><span class="o">(</span><span class="s">"Authorization"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<ul>
  <li><code class="language-plaintext highlighter-rouge">configuration</code>: is for extra configuration like logging, interceptors, etcâ€¦ more on that below.</li>
  <li><code class="language-plaintext highlighter-rouge">@RequestMapping</code>: Spring Cloud adds support for Spring MVC annotations and for using the same <code class="language-plaintext highlighter-rouge">HttpMessageConverter's</code> used by default in Spring Web.</li>
</ul>

<h2 id="openfeign">OpenFeign</h2>
<p>To create an OpenFeign client we need an interface and a Feign builder that tells the interface it is an OpenFeign client.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AuthClient</span> <span class="o">{</span>
    <span class="nd">@RequestLine</span><span class="o">(</span><span class="s">"GET /auth"</span><span class="o">)</span>
    <span class="nd">@Headers</span><span class="o">({</span><span class="s">"Authorization: {token}"</span><span class="o">,</span> <span class="s">"Accept: application/hal+json"</span><span class="o">})</span>
    <span class="kt">boolean</span> <span class="nf">isValid</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"token"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">token</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<ul>
  <li><code class="language-plaintext highlighter-rouge">@RequestLine</code>: is defining which verb and which URI path you are communicating to.</li>
  <li><code class="language-plaintext highlighter-rouge">@Headers</code>: is defining the request headers that come with the request.</li>
</ul>

<h1 id="the-builder">The builder</h1>
<p>OpenFeign provides us with a builder-like pattern for our clients.
When we want to customize, we just add our own customization to the builder. 
To see the builder at work, letâ€™s create a bean of our client and return a Feign builder.
Itâ€™s important to let the builder know which interface he has to target for communication. 
The second parameter is most likely the base url where all the requests begin. 
Get your URLs from the yml or properties file with the help of <code class="language-plaintext highlighter-rouge">@Value</code>.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Value</span><span class="o">(</span><span class="s">"${base.url}"</span><span class="o">)</span>
<span class="kd">private</span> <span class="nc">String</span> <span class="n">baseServerUrl</span><span class="o">;</span>

<span class="nd">@Bean</span>
<span class="nc">AuthClient</span> <span class="nf">authClient</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Feign</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">target</span><span class="o">(</span><span class="nc">AuthClient</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">baseServerUrl</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<h1 id="different-kinds-of-http-clients">Different kinds of HTTP clients</h1>
<p>The default HTTP client of OpenFeign uses <code class="language-plaintext highlighter-rouge">HttpUrlConnection</code> to execute its HTTP requests.
You can configure another client (<code class="language-plaintext highlighter-rouge">ApacheHttpClient</code>, <code class="language-plaintext highlighter-rouge">OkHttpClient</code>, â€¦) as follows:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="nc">AuthClient</span> <span class="nf">authClient</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Feign</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">client</span><span class="o">(</span><span class="k">new</span> <span class="nc">ApacheHttpClient</span><span class="o">())</span>
            <span class="o">.</span><span class="na">target</span><span class="o">(</span><span class="nc">AuthClient</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">baseServerUrl</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<h2 id="okhttpclient">OkHttpClient</h2>
<p>OkHttp is an HTTP client thatâ€™s efficient by default:</p>

<ul>
  <li>HTTP/2 support allows all requests to the same host to share a socket.</li>
  <li>Connection pooling reduces request latency (if HTTP/2 isnâ€™t available).</li>
  <li>Transparent GZIP shrinks download sizes.</li>
  <li>Response caching avoids the network completely for repeat requests.</li>
</ul>

<h2 id="apachehttpclient">ApacheHttpClient</h2>
<p>The advantage of using <code class="language-plaintext highlighter-rouge">ApacheHttpClient</code> over the default client is that <code class="language-plaintext highlighter-rouge">ApacheHttpClient</code> sends more headers with the request, eg. <code class="language-plaintext highlighter-rouge">Content-Length</code>, which some servers expect.</p>

<blockquote>
  <p>Aside from these clients, there are a few more to research if you want : <a href="https://github.com/OpenFeign/feign#ribbon" target="_blank">OpenFeign clients</a></p>
</blockquote>

<h1 id="enabling-mutual-ssl">Enabling Mutual SSL</h1>
<p>Mutual SSL is supported in all of these clients.
To achieve this in an <code class="language-plaintext highlighter-rouge">ApacheHttpClient</code>, we have to create an <code class="language-plaintext highlighter-rouge">HttpClient</code> that builds the SSL context.
When the SSL context is valid, we wrap this inside an <code class="language-plaintext highlighter-rouge">ApacheHttpClient</code> for being compliant with OpenFeign.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nc">ApacheHttpClient</span> <span class="nf">createHttpClient</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">SSLException</span> <span class="o">{</span>
    <span class="nc">HttpClient</span> <span class="n">httpClient</span> <span class="o">=</span> <span class="nc">HttpClients</span><span class="o">.</span><span class="na">custom</span><span class="o">()</span>
            <span class="o">.</span><span class="na">setSSLSocketFactory</span><span class="o">(</span><span class="n">createSSLContext</span><span class="o">())</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ApacheHttpClient</span><span class="o">(</span><span class="n">httpClient</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>Add it to the builder.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="nc">AuthClient</span> <span class="nf">authClient</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Feign</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">client</span><span class="o">(</span><span class="n">createHttpClient</span><span class="o">())</span>
            <span class="o">.</span><span class="na">target</span><span class="o">(</span><span class="nc">AuthClient</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">baseServerUrl</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<h1 id="give-it-a-retry">Give it a (re)try</h1>
<p>When we want to build some resilience in our communication, we can setup a retry mechanism in our OpenFeign client. 
If the other service is unreachable, we will try again until it is healthy or until the max attempts you have set in your configuration has been reached. 
When we want to use the retryer of OpenFeign, we got three properties we can set.</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">period</code>: How long it takes before the retry is triggered</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">maxPeriod</code>: Thatâ€™s what the maximum is of how long it can take before a retry is triggered</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">maxAttempts</code>: How many retries may the client trigger before it fails</p>
  </li>
</ul>

<p>Example:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Value</span><span class="o">(</span><span class="s">"${retry.period:3000}"</span><span class="o">)</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">period</span><span class="o">;</span>

<span class="nd">@Value</span><span class="o">(</span><span class="s">"${retry.maxPeriod:30000}"</span><span class="o">)</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">maxPeriod</span><span class="o">;</span>

<span class="nd">@Value</span><span class="o">(</span><span class="s">"${retry.maxAttempts:5}"</span><span class="o">)</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">maxAttempts</span><span class="o">;</span>

<span class="nd">@Bean</span>
<span class="nc">AuthClient</span> <span class="nf">authClient</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Feign</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">retryer</span><span class="o">(</span><span class="k">new</span> <span class="nc">Retryer</span><span class="o">.</span><span class="na">Default</span><span class="o">(</span><span class="n">period</span><span class="o">,</span> <span class="n">maxPeriod</span><span class="o">,</span> <span class="n">maxAttempts</span><span class="o">))</span>
            <span class="o">.</span><span class="na">target</span><span class="o">(</span><span class="nc">AuthClient</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">baseServerUrl</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<h1 id="intercepting-requests">Intercepting requests</h1>
<p>If you need some basic authorization, custom headers or some extra information in every request of the client, we can use interceptors. 
This becomes very useful in situations where every request needs this extra information.
To add an interceptor, we just add an extra method that returns the OpenFeign interceptor.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="nc">RequestInterceptor</span> <span class="nf">requestInterceptor</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">requestTemplate</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">requestTemplate</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span> <span class="n">username</span><span class="o">);</span>
        <span class="n">requestTemplate</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">"password"</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
        <span class="n">requestTemplate</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">"Accept"</span><span class="o">,</span> <span class="nc">ContentType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">.</span><span class="na">getMimeType</span><span class="o">());</span>
    <span class="o">};</span>
<span class="o">}</span></code></pre></figure>

<p>To enable the customization, we add the interceptor to the builder.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="nc">AuthClient</span> <span class="nf">authClient</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Feign</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">requestInterceptor</span><span class="o">(</span><span class="n">requestInterceptor</span><span class="o">())</span>
            <span class="o">.</span><span class="na">target</span><span class="o">(</span><span class="nc">AuthClient</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">baseServerUrl</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<h1 id="securing-your-api">Securing your API</h1>
<p>When we want to add the security layer between our services, there are a couple solutions to look at. 
Here are a few that can be handled by OpenFeign.</p>

<h2 id="basic">Basic</h2>
<p>When you want to send basic credentials you can just add an <a href="#intercepting-requests">interceptor</a> for the OpenFeign client and add the username and password.</p>

<h2 id="bearer">Bearer</h2>
<p>For only Bearer token communication, you can just pass it down in the request header of your method call.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">//Spring</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s">"checkToken"</span><span class="o">)</span>
<span class="kt">boolean</span> <span class="nf">isTokenValid</span><span class="o">(</span><span class="nd">@RequestHeader</span><span class="o">(</span><span class="s">"Authorization"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">token</span><span class="o">);</span>

<span class="c1">//OpenFeign</span>
<span class="nd">@RequestLine</span><span class="o">(</span><span class="s">"GET /auth"</span><span class="o">)</span>
<span class="nd">@Headers</span><span class="o">({</span><span class="s">"Authorization: {token}"</span><span class="o">,</span> <span class="s">"Accept: application/hal+json"</span><span class="o">})</span>
<span class="kt">boolean</span> <span class="nf">isValid</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"token"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">token</span><span class="o">);</span></code></pre></figure>

<h2 id="oauth2">OAuth2</h2>
<p>This link provides a good explanation about the use of OAuth2 with OpenFeign: 
<a href="https://jmnarloch.wordpress.com/2015/10/14/spring-cloud-feign-oauth2-authentication/" target="_blank">OAuth 2 interceptor</a>.</p>

<h1 id="creating-soap-clients">Creating SOAP clients</h1>
<p>Besides JSON encoders and decoders, you can also enable support for XML.
If you ever have to integrate with SOAP third party APIs, OpenFeign supports it.
There is a very detailed explanation on how to use it in the <a href="https://github.com/OpenFeign/feign#jaxb" target="_blank">documentation</a> of OpenFeign.</p>

<h1 id="handling-errors-with-the-error-decoder">Handling errors with the error decoder</h1>
<p>The OpenFeign API provides an <code class="language-plaintext highlighter-rouge">ErrorDecoder</code> to handle erroneous responses from servers.
Since there are many kind of errors we can get, we want a place where we can handle each one of them accordingly. 
An OpenFeign <code class="language-plaintext highlighter-rouge">ErrorDecoder</code> must be added to the configuration of the client object as you can see in the code below.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="nc">MyClient</span> <span class="nf">myClient</span><span class="o">()</span> <span class="o">{</span>
   <span class="k">return</span> <span class="nc">Feign</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
           <span class="o">.</span><span class="na">errorDecoder</span><span class="o">(</span><span class="n">errorDecoder</span><span class="o">())</span>
           <span class="o">.</span><span class="na">target</span><span class="o">(</span><span class="nc">MyClient</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="o">&lt;</span><span class="n">url</span><span class="o">&gt;);</span>
<span class="o">}</span></code></pre></figure>

<p>Rather than throwing an exception in the <code class="language-plaintext highlighter-rouge">decode</code> method of the <code class="language-plaintext highlighter-rouge">ErrorDecoder</code>, you return an exception to Feign and Feign will throw it for you.
The default error decoder <code class="language-plaintext highlighter-rouge">ErrorDecoder.Default</code> always throws a <code class="language-plaintext highlighter-rouge">FeignException</code>.
The problem with ending up with a <code class="language-plaintext highlighter-rouge">FeignException</code> is that it does not contain a lot of structure. 
It is a plain <code class="language-plaintext highlighter-rouge">RuntimeException</code> which only contains a message with a stringified response body. 
No way of interpreting that exception to rethrow a more functional exception eg. <code class="language-plaintext highlighter-rouge">UserNotFoundException</code>.</p>

<h2 id="error-decoder">Error decoder</h2>
<p>To handle the errors, we have to look at the structure of these errors. 
From that structure, we build up our own exception and throw it so the <code class="language-plaintext highlighter-rouge">ControllerAdvice</code> class can handle our exception.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomErrorDecoder</span> <span class="kd">implements</span> <span class="nc">ErrorDecoder</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Exception</span> <span class="nf">decode</span><span class="o">(</span><span class="nc">String</span> <span class="n">methodKey</span><span class="o">,</span> <span class="nc">Response</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">CustomException</span> <span class="n">ex</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">body</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">ex</span> <span class="o">=</span> <span class="n">createException</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Failed to decode CustomException"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">ex</span> <span class="o">=</span> <span class="n">ex</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">ex</span> <span class="o">:</span> <span class="k">new</span> <span class="nc">CustomException</span><span class="o">(</span><span class="s">"Failed to decode CustomException"</span><span class="o">,</span> <span class="n">errorStatus</span><span class="o">(</span><span class="n">methodKey</span><span class="o">,</span> <span class="n">response</span><span class="o">).</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">ex</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="nc">CustomExceptionException</span> <span class="nf">createException</span><span class="o">(</span><span class="nc">Response</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">body</span> <span class="o">=</span> <span class="nc">Util</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">body</span><span class="o">().</span><span class="na">asReader</span><span class="o">());</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ErrorResource</span><span class="o">&gt;</span> <span class="n">errorMessages</span> <span class="o">=</span> <span class="n">createMessage</span><span class="o">(</span><span class="n">body</span><span class="o">);</span>
        <span class="k">return</span> <span class="nf">createCustomException</span><span class="o">(</span><span class="n">body</span><span class="o">,</span> <span class="n">errorMessages</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ErrorResource</span><span class="o">&gt;</span> <span class="nf">createMessage</span><span class="o">(</span><span class="nc">String</span> <span class="n">body</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">read</span><span class="o">(</span><span class="n">body</span><span class="o">,</span> <span class="s">"$.errors"</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="nc">CustomException</span> <span class="nf">createCustomException</span><span class="o">(</span><span class="nc">String</span> <span class="n">body</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ErrorResource</span><span class="o">&gt;</span> <span class="n">errors</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">CustomException</span> <span class="n">ex</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CustomException</span><span class="o">();</span>
        <span class="n">ex</span><span class="o">.</span><span class="na">setErrors</span><span class="o">(</span><span class="n">errors</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">read</span><span class="o">(</span><span class="n">body</span><span class="o">,</span> <span class="s">"$.status"</span><span class="o">);</span>
        <span class="n">ex</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">status</span><span class="o">));</span>
        <span class="n">ex</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="n">read</span><span class="o">(</span><span class="n">body</span><span class="o">,</span> <span class="s">"$.title"</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">ex</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation-circle"></i> <b>Warning:</b> 
Working with checked exceptions and Feign is a bit tricky for several reasons.
Returning a checked exception is possible in the <code class="language-plaintext highlighter-rouge">ErrorDecoder</code>, but to avoid Javaâ€™s <code class="language-plaintext highlighter-rouge">UndeclaredThrowableException</code>, youâ€™ll have to add it to the method signature in the Feign interface. 
Doing this however, causes Sonar to complain because thereâ€™s no actual code which throws that exception.
</div>

<h1 id="conclusion">Conclusion</h1>
<p>These were my experiences with OpenFeign and I like the simplicity of it. 
If you choose for the Spring wrapper or OpenFeign, the client is an advanced tool for enabling inter-service communication.
As of now, they just released a new version that is compliant with Java 11.
So go experiment and learn on the way!</p>

<h1 id="sources">Sources</h1>
<ul>
  <li><a href="https://github.com/OpenFeign/feign" target="_blank">OpenFeign Documentation</a></li>
  <li><a href="http://cloud.spring.io/spring-cloud-static/spring-cloud-openfeign/2.0.1.RELEASE/single/spring-cloud-openfeign.html" target="_blank">Spring Cloud OpenFeign Documentation</a></li>
  <li><a href="https://jmnarloch.wordpress.com/2015/10/14/spring-cloud-feign-oauth2-authentication/" target="_blank">OAuth 2 interceptor</a></li>
  <li><a href="https://github.com/OpenFeign/feign#jaxb" target="_blank">SOAP integration</a></li>
  <li><a href="https://github.com/OpenFeign/feign#ribbon" target="_blank">Other HTTP clients</a></li>
  <li><a href="https://github.com/Netflix/ribbon" target="_blank">Ribbon</a></li>
  <li><a href="https://github.com/Netflix/Hystrix" target="_blank">Hystrix</a></li>
</ul>

        </div>
    </div>
    <div class="share-page" >
        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://ordina-jworks.github.io/microservices/2018/11/02/Inter-service-communication.html&title=Communication in a distributed system with OpenFeign: Tips & Tricks&source=https://ordina-jworks.github.io" rel="nofollow" target="_blank" title="Share on LinkedIN">
            <img src="/img/social-media/LinkedIn.png"
                 alt="Share on LinkedIn" />
        </a>
        <a href="https://twitter.com/intent/tweet?text=Communication in a distributed system with OpenFeign: Tips & Tricks&url=https://ordina-jworks.github.io/microservices/2018/11/02/Inter-service-communication.html&via=lifeatordinabe&related=lifeatordinabe" rel="nofollow" target="_blank" title="Share on Twitter">
            <img src="/img/social-media/Twitter.png"
                 alt="Share on Twitter" />
        </a>
        <a href="https://facebook.com/sharer.php?u=https://ordina-jworks.github.io/microservices/2018/11/02/Inter-service-communication.html" rel="nofollow" target="_blank" title="Share on Facebook">
            <img src="/img/social-media/Facebook.png"
                 alt="Share on Facebook" />
        </a>
    </div>
        
</section>


<section id="two" class="wrapper alt spotlight style2">
    
    <div class="inner">
        <a href="/author/kevin-van-houtte/" class="image spotlight-image" title="">
            <img src="/img/author/kevin-van-houtte.jpg"
                 alt="" class="p-image"/>
        </a>

        <div class="content">
            
            <p><p>Kevin Van Houtte is a Software Engineer at Ordina Belgium. Passionate in the Spring ecosystem, Kevin is eager to discover new and efficient ways to solve problems. He enjoys a good challenge and is interested in cutting edge technologies. Kevin has a strong focus on building cloud native architectures with the right mindset on security and API design.</p>
</p>
            
        </div>
    </div>
    
</section>

        </div>
    </section>
</div>



<footer>
    <div class="contact">
        <div class="address">
            <div class="icon"><i class="fa fa-fw fa-home"></i></div>
            <div class="text">Ordina Belgium<br/>Blarenberglaan 3B,<br/>2800 Mechelen, Belgium</div>
        </div>
        <div class="phone">
            <div class="icon"><i class="fa fa-fw fa-phone"></i></div>
            <div class="text"><a href="tel:003215295858">+32 15 29 58 58</a></div>
        </div>
        <div class="email">
            <div class="icon"><i class="fa fa-fw fa-envelope-o"></i></div>
            <div class="text"><a href="mailto:jworks@ordina.be">jworks@ordina.be</a></div>
        </div>
    </div>
    <ul class="social">
        <li>
            <a href="https://twitter.com/lifeatordinabe" target="_blank">
                <i class="fa fa-fw fa-twitter"></i><span>Twitter</span>
            </a>
        </li>
        <li>
            <a href="https://www.facebook.com/lifeatordinabe" target="_blank">
                <i class=" fa fa-fw fa-facebook"></i><span>Facebook</span>
            </a>
        </li>
        <li>
            <a href="https://www.linkedin.com/company/ordinabelgium" target="_blank">
                <i class=" fa fa-fw fa-linkedin"></i><span>LinkedIn</span>
            </a>
        </li>
        <li>
            <a href="/youtube" target="_blank">
                <i class=" fa fa-fw fa-youtube"></i><span>YouTube</span>
            </a>
        </li>
        <li>
            <a href="/github" target="_blank">
                <i class=" fa fa-fw fa-github"></i><span>GitHub</span>
            </a>
        </li>
        <li>
            <a href="/feed.xml" target="_blank">
                <i class=" fa fa-fw fa-rss"></i><span>RSS Feed</span>
            </a>
        </li>
    </ul>
    <div class="copyright">
        &copy; 2022 Ordina JWorks. All rights reserved.
        <br /> Disclaimer: Opinions expressed on this blog reflect the writer's views and not the position of Ordina
        <img id="analyticsImg" src="" width="1" height="1" style="border: 0px"/>
    </div>
</footer>
<!-- Scripts -->
<script src="/js/jquery.min.js"></script>
<script src="/js/jquery.scrollex.min.js"></script>
<script src="/js/jquery.magnific-popup.min.js"></script>
<script src="/js/owl.carousel.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/skel.min.js"></script>
<script src="/js/jquery.pin.min.js"></script>
<script src="/js/util.js"></script>
<!--[if lte IE 8]>
<script src="/js/ie/respond.min.js"></script><![endif]-->


<script>
    var imageHref = "/img/intercommunication/intercomm_header.jpg";
    $(function () {
        $('body').addClass('toggle');
    });
</script>


<script src="/js/main.js"></script>

<!-- Google Analytics -->
<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o);
        m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m);
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'UA-70040502-1', 'auto');
    ga('send', 'pageview');
</script>
<script type="text/javascript">
    window.addEventListener('load', function () {
        if (window.ga && ga.create) {
            console.log('GA loaded correctly');
        } else {
            console.log('GA is blocked or failed to load - tracking manually...')
            document.getElementById('analyticsImg').src = 'https://jworks-techblog-analytics.cfapps.io/collect?title=' + document.title;
        }
    }, false);
</script>

<!-- Vertical timeline -->
<script src="/js/vertical-timeline/modernizr.js"></script>
<script src="/js/vertical-timeline/main.js"></script>


</body>
</html>
