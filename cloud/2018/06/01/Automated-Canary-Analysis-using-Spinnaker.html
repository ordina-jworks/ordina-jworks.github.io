<!DOCTYPE html>
<!--suppress ALL -->
<html>
<head>
        <meta charset="utf-8">
    <meta name="description" content="We build innovative solutions with Java and JavaScript. To support this mission, we have several Competence Centers. From within those Competence Centers, we provide coaching to the employee and expert advice towards our customer. In order to keep in sync with the latest technologies and the latest trends, we frequently visit conferences around the globe.
">
    <meta name="keywords" content="Ordina,ORAJ,JWorks,Blog,Java,JavaScript,TypeScript,Angular,DevOps">
    <meta name="author" content="Ordina Belgium">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/img/favicons/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/img/favicons/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/img/favicons/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/favicons/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="/img/favicons/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/img/favicons/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/img/favicons/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/img/favicons/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-128.png" sizes="128x128" />

    

    <!-- Twitter Card data -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Automated Canary Analysis using Spinnaker - Codelab - Andreas Evers">
    <meta name="twitter:description" content="Ordina JWorks Tech Blog">
    <meta name="twitter:image" content="http://ordina-jworks.github.io/img/spinnaker/spinnaker-logo.png"/>

    <!-- Facebook Open Graph -->
    <meta property="og:url" content="http://ordina-jworks.github.io/cloud/2018/06/01/Automated-Canary-Analysis-using-Spinnaker.html"/>
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Automated Canary Analysis using Spinnaker - Codelab - Andreas Evers"/>
    <meta property="og:description" content="Ordina JWorks Tech Blog"/>
    <meta property="og:image" content="http://ordina-jworks.github.io/img/spinnaker/spinnaker-logo.png"/>

    
    <title>Automated Canary Analysis using Spinnaker - Codelab - Andreas Evers &mdash; Ordina JWorks Tech Blog</title>
    

        <!-- Styles -->
    <!-- Font awesome CSS -->
    <link href="/css/font-awesome.min.css" rel="stylesheet">
    <!-- Magnific Popup -->
    <link href="/css/magnific-popup.css" rel="stylesheet">
    <!-- Owl carousel -->
    <link href="/css/owl.carousel.css" rel="stylesheet">

    <!-- CSS for this page -->

    <!-- Syntax highlighting -->
    <link href="/css/syntax.css" rel="stylesheet">


    <!--[if lte IE 8]>
    <script src="/js/ie/html5shiv.js"></script><![endif]-->
    <link rel="stylesheet" href="/css/main.css"/>
    <!--[if lte IE 9]>
    <link rel="stylesheet" href="/css/ie9.css"/><![endif]-->
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="/css/ie8.css"/><![endif]-->

    <!-- Custom CSS. Type your CSS code in custom.css file -->
    <link href="/css/custom.css" rel="stylesheet">

    <!-- Vertical timeline -->
	<link rel="stylesheet" href="/css/vertical-timeline/style.css"> <!-- Resource style -->

    <!-- Favicon -->
    <link rel="shortcut icon" href="#">

    <script src="https://use.typekit.net/gzh0mbm.js"></script>
    <script>
        try {
            Typekit.load({async: true});
        } catch (e) {
        }
    </script>
</head>

<body>
<div id="header-image"></div>


<!-- Page Wrapper -->
<div id="page-wrapper">

        <!-- Header -->
    <header id="header">
        <h1>
            <a href="/">
                JWorks Tech Blog
            </a>
        </h1>

        <nav>
            <a href="#menu">Menu</a>
            <form action="/search/" method="get" class="header-search search-form">
                <input type="text" id="search-box-header" name="query" placeholder="Search &hellip;">
            </form>
        </nav>
    </header>

    <!-- Menu -->
    <nav id="menu">
        <div class="inner">
            <h2>Menu</h2>
            <ul class="links">
                <li class="menu-item"><a href="/">Home</a></li>
                <li class="menu-item"><a href="/about">About Us</a></li>
                <li class="menu-item"><a href="/jobs">Jobs</a></li>
                <li class="menu-item"><a href="/launch-your-career">Career</a></li>
                <li class="menu-item"><a href="/tech-radar">Tech Radar</a></li>
                <li class="menu-item"><a href="/search">Search</a></li>
                <li class="menu-item"><a href="/contact">Contact Us</a></li>
            </ul>
            <a href="#" class="close">Close</a>
        </div>
    </nav>

    <section id="banner">
        <header>
            <div class="inner">
                

                <h2>Automated Canary Analysis using Spinnaker - Codelab</h2>
                

                
                    Posted Jun 1, 2018


    in <a href="/categories/cloud/">Cloud</a>



    by
    
        <a href="/author/andreas-evers/">Andreas Evers</a>
        
    



    <br/>
    <i class="fa fa-tags"></i>
    
        <a href="/tags/canary/">Canary</a>, 
    
        <a href="/tags/continuous-delivery/">Continuous-Delivery</a>, 
    
        <a href="/tags/cloud/">Cloud</a>, 
    
        <a href="/tags/microservices/">Microservices</a>, 
    
        <a href="/tags/netflix/">Netflix</a>, 
    
        <a href="/tags/spring/">Spring</a>
    

                

                

            </div>
        </header>
    </section>

    <section id="wrapper">
        <div class="inner">
            <section id="one" class="wrapper spotlight style1 post-body">
    <div class="inner" style="text-align: left;">
        <div class="content">
            <h1 id="intro">Intro</h1>

<p>Spinnaker is a multi-cloud, multi-region automated deployment tool.
Open sourced by Netflix and heavily contributed to by Google, it supports all major cloud providers including Kubernetes.</p>

<p>Last month, <a href="https://github.com/spinnaker/kayenta">Kayenta</a> was open sourced, a canary analysis engine.
Canary analysis is a technique to reduce the risk from deploying a new version of software into production.
A new version of the software, referred to as the canary, is deployed to a small subset of users alongside the stable running version.
Traffic is split between these two versions such that a portion of incoming requests is diverted to the canary.
This approach can quickly uncover any problems with the new version without impacting the majority of users.</p>

<p>The quality of the canary version is assessed by comparing key metrics that describe the behavior of the old and new versions.
If there is a significant degradation in these metrics, the canary is aborted and all of the traffic is routed to the stable version in an effort to minimize the impact of unexpected behavior.</p>

<div class="row" style="margin: 0 auto 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Destroy canary" src="/img/spinnaker/Screen Shot 2018-06-08 at 16.08.27.png" />
    
</figure>

</div>
</div>

<h1 id="preface">Preface</h1>

<p>Ordina helps companies through digital transformation using three main focus areas:</p>

<ul>
  <li>
    <p>Embracing a DevOps culture and corresponding practices allows teams to focus on delivering value for the business, by changing the communication structures of the organization.
Through automation, teams are empowered and capable of delivering applications much faster to production.</p>
  </li>
  <li>
    <p>Having a modular decoupled architecture, our second focus area, fits well with this model.
Making these changes to our architecture in combination with a culture of automation, results in a lot more moving parts in our application landscape.</p>
  </li>
  <li>
    <p>Naturally, the next step is tackling the underlying infrastructure accomodate this new architecture and way of working.
Cloud automation is therefore our final focus area in digital transformations.</p>
  </li>
</ul>

<p>Releasing more often doesn’t only allow new features reaching the user faster, it also fastens the feedback loops, improves reliability and availability, developer productivity and efficiency. Spinnaker plays a crucial part in all of this, as it allows more frequent and faster deployments, without sacrificing safety.</p>

<p>Automated canary analysis, demonstrated in this codelab, is a powerful tool in that sense.</p>

<h1 id="overview">Overview</h1>

<ul>
  <li><a href="#goal">Goal</a></li>
  <li><a href="#prerequisites">Prerequisites</a></li>
  <li><a href="#intro-demo">Introducing our Rick &amp; Morty demo</a></li>
  <li><a href="#installation">Installation</a></li>
  <li><a href="#configuration">Configuration</a></li>
  <li><a href="#running-demo">Running the demo scenario</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
</ul>

<p><a name="goal"></a></p>

<h1 id="goal">Goal</h1>

<p>The purpose of this codelab is to simplify getting up-and-running with automated canary analysis using Spinnaker on Kubernetes.</p>

<p><a name="prerequisites"></a></p>

<h1 id="prerequisites">Prerequisites</h1>

<p>We’re using Google Cloud Platform for this demonstration.
Monitoring and logging will be handled by Stackdriver, which is integrated completely with GCP.</p>

<p>The canary functionality we’re going to use in this setup requires the use of a specific cluster version with full rights:</p>
<ul>
  <li>You must be an Owner of the project containing your cluster.</li>
  <li>You must use Kubernetes v1.10.2-gke.0 or later.</li>
</ul>

<p><a name="intro-demo"></a></p>

<h1 id="introducing-our-rick--morty-demo">Introducing our Rick &amp; Morty demo</h1>

<p>Rick &amp; Morty is a television show following the misadventures of cynical mad scientist Rick Sanchez and his good-hearted but fretful grandson Morty Smith, who split their time between domestic life and interdimensional adventures.</p>
<div class="row" style="margin: 0 35% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Rick and Morty" src="/img/spinnaker/rick-and-morty.jpg" />
    
</figure>

</div>
</div>

<p>Our demo application is a Java Spring Boot application, running on an Apache Tomcat server, packaged inside a docker container.
The docker container runs on Kubernetes managed by Google Cloud Platform (GKE).<br />
The application exposes an endpoint on <code class="highlighter-rouge">http://localhost:8080</code> and can be run locally by executing <code class="highlighter-rouge">./mvnw spring-boot:run</code>, assuming you have a JRE or JDK (v8+) installed.</p>

<p>The endpoint returns an HTML with a background of Pickle Rick.
In season three episode three, Rick turns himself into a pickle in an attempt at escaping family therapy.</p>
<div class="row" style="margin: 0 35% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Pickle Rick" src="/img/spinnaker/pickle-rick.jpeg" />
    
</figure>

</div>
</div>
<p>Pickle Rick will act as our initial <em>green</em> deployment, running stabily on production.
We will try to replace it with a <em>blue</em> deployment.<br />
Mr. Meeseeks, featured in season one episode five, will be the protagonist of that deployment.
Meeseeks are creatures who are created to serve a singular purpose for which they will go to any length to fulfill.
After they serve their purpose, they expire and vanish into the air.
Their motivation to help others comes from the fact that existence is painful to a Meeseeks, and the only way to be removed from existence is to complete the task they were called to perform.<br />
Meeseeks can however summon other Meeseeks to help, which could spiral out of control if the task at hand is unsolvable.</p>
<div class="row" style="margin: 0 35% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Meeseeks" src="/img/spinnaker/meeseeks.png" />
    
</figure>

</div>
</div>
<p>Therefore, Meeseeks are quite dangerous and a good candidate for our misbehaving blue deployment.</p>

<p>Aside from the HTTP endpoint, our demo application also prints out a number of character names from the series.</p>

<h3 id="blue-green-differences">Blue Green Differences</h3>

<p>Aside from the leading character in our two versions, there are two specific differences in the code between both versions.</p>

<p>The following commit shows moving from the green version to the blue version: <a href="https://github.com/andreasevers/spinnaker-demo/commit/24cc45cf4d8ddfe2843e4ea105b5e43bb28c4d41">24cc45cf</a></p>

<p>First of all, the background image changes, which gives a clear visual indication of which version is currently deployed.<br />
Since using Meeseeks could get out of hand quickly, keeping track of how many times the Meeseeks HTTP endpoint has been hit makes a lot of sense.
Hence, the blue version prints an extra <code class="highlighter-rouge">Meeseeks</code> in the logs, for every request to the endpoint.</p>

<p>Using this setup, we should be able to consider logs as a source of information for judging the canary healthiness.</p>

<p>Note that the Github repository can constantly switch between Pickle Rick and Meeseeks.
Before starting a build and making deployments, make sure your fork is aligned with the green version.
If this isn’t the case, switching to green is demonstrated in the following commit: <a href="https://github.com/andreasevers/spinnaker-demo/commit/784e616ae6de881cecf6601831383e2097149c83">784e616a</a></p>

<h3 id="setup-continuous-integration">Setup Continuous Integration</h3>

<p>Making changes to our application will be the trigger for our pipelines.
Therefore, we should have a simple continuous integration flow set up.
We could use Jenkins or any other build server that uses webhooks, but since our entire demo is being deployed on GCP, we can use the build server from GCP instead.</p>

<p>First of all, fork the <a href="https://github.com/andreasevers/spinnaker-demo/commit/24cc45cf4d8ddfe2843e4ea105b5e43bb28c4d41">demo application repository</a>.</p>

<p>In the GCP console, open build triggers underneath the Container Registry (GCR) tab.<br />
Select Github as repository hosting, and select the forked repository to create a trigger for.
Configure the trigger to activate on any branch, using a <code class="highlighter-rouge">cloudbuild.yaml</code> file located in the root of the repository.</p>
<div class="row" style="margin: 0 35% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="CI " src="/img/spinnaker/Screen Shot 2018-06-01 at 16.54.36.png" />
    
</figure>

</div>
</div>

<p>This will run a maven build and docker build, and push the created docker image into the GCR.</p>

<p><a name="installation"></a></p>

<h1 id="installation">Installation</h1>

<blockquote>
  <p>Throughout this guide we refer to the official documentation for individual parts of the installation already covered by the Spinnaker team.
However, as reference we also compiled an exhaustive list of commands to execute based on the commands found in those articles.
This means you could skip the official documentation and simply execute those commands.
However, we still recommend going through the docs to get more context.
The list of commands to execute can be found <a href="#commands">at the end of this chapter</a>.</p>
</blockquote>

<p>Follow the guide on Spinnaker’s website: <a href="https://www.spinnaker.io/setup/quickstart/halyard-gke">https://www.spinnaker.io/setup/quickstart/halyard-gke</a></p>

<p>Create a cluster as mentioned here: <a href="https://cloud.google.com/monitoring/kubernetes-engine/installing">https://cloud.google.com/monitoring/kubernetes-engine/installing</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcloud components update

gcloud auth login
gcloud config <span class="nb">set </span>project &lt;PROJECT_NAME&gt;
</code></pre></div></div>

<p>Find out the latest supported cluster version with the following command:
<code class="highlighter-rouge">gcloud container get-server-config --zone=$ZONE</code></p>

<p>Create a cluster for your specific zone (e.g. europe-west1-d) and preferred cluster version (v1.10.2-gke.0 or later):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">CLUSTER_VERSION</span><span class="o">=</span>1.10.2-gke.1
<span class="nv">GCP_PROJECT</span><span class="o">=</span><span class="k">$(</span>gcloud info <span class="nt">--format</span><span class="o">=</span><span class="s1">'value(config.project)'</span><span class="k">)</span>
<span class="nv">ZONE</span><span class="o">=</span>europe-west1-d

<span class="nv">CLOUDSDK_CONTAINER_USE_V1_API</span><span class="o">=</span><span class="nb">false
</span><span class="nv">CLOUDSDK_API_CLIENT_OVERRIDES_CONTAINER</span><span class="o">=</span>v1beta1

gcloud beta container clusters create spinnaker <span class="se">\</span>
  <span class="nt">--zone</span><span class="o">=</span><span class="nv">$ZONE</span> <span class="se">\</span>
  <span class="nt">--project</span><span class="o">=</span><span class="nv">$GCP_PROJECT</span> <span class="se">\</span>
  <span class="nt">--cluster-version</span><span class="o">=</span><span class="nv">$CLUSTER_VERSION</span> <span class="se">\</span>
  <span class="nt">--enable-stackdriver-kubernetes</span> <span class="se">\</span>
  <span class="nt">--enable-legacy-authorization</span>
</code></pre></div></div>
<p>Make sure <code class="highlighter-rouge">--enable-stackdriver-kubernetes</code> and <code class="highlighter-rouge">--enable-legacy-authorization</code> are passed.</p>

<h3 id="enable-apis">Enable APIs</h3>

<p>Navigate to the Google Cloud Console and enable the following APIs:</p>
<ul>
  <li><a href="https://console.developers.google.com/apis/api/iam.googleapis.com/overview">Google Identity and Access Management (IAM) API</a></li>
  <li><a href="https://console.developers.google.com/apis/api/cloudresourcemanager.googleapis.com/overview">Google Cloud Resource Manager API</a></li>
</ul>

<h3 id="halyard-setup">Halyard setup</h3>

<p>This section complements official documentation with some recommendations and extras.
Postpone running the <code class="highlighter-rouge">hal deploy apply</code> command until the end of this chapter.</p>

<h4 id="basic-spinnaker">Basic Spinnaker</h4>

<p>During the <a href="https://www.spinnaker.io/setup/quickstart/halyard-gke">Halyard on GKE guide on Spinnaker’s website</a>, remember to use the right zone when creating the Halyard VM.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcloud compute instances create <span class="nv">$HALYARD_HOST</span> <span class="se">\</span>
    <span class="nt">--project</span><span class="o">=</span><span class="nv">$GCP_PROJECT</span> <span class="se">\</span>
    <span class="nt">--zone</span><span class="o">=</span><span class="nv">$ZONE</span> <span class="se">\</span>
    <span class="nt">--scopes</span><span class="o">=</span>cloud-platform <span class="se">\</span>
    <span class="nt">--service-account</span><span class="o">=</span><span class="nv">$HALYARD_SA_EMAIL</span> <span class="se">\</span>
    <span class="nt">--image-project</span><span class="o">=</span>ubuntu-os-cloud <span class="se">\</span>
    <span class="nt">--image-family</span><span class="o">=</span>ubuntu-1404-lts <span class="se">\</span>
    <span class="nt">--machine-type</span><span class="o">=</span>n1-standard-4
</code></pre></div></div>

<p>When SSH’ing into the Halyard VM, also remember to use the right zone.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcloud compute ssh <span class="nv">$HALYARD_HOST</span> <span class="se">\</span>
    <span class="nt">--project</span><span class="o">=</span><span class="nv">$GCP_PROJECT</span> <span class="se">\</span>
    <span class="nt">--zone</span><span class="o">=</span><span class="nv">$ZONE</span> <span class="se">\</span>
    <span class="nt">--ssh-flag</span><span class="o">=</span><span class="s2">"-L 9000:localhost:9000"</span> <span class="se">\</span>
    <span class="nt">--ssh-flag</span><span class="o">=</span><span class="s2">"-L 8084:localhost:8084"</span>
</code></pre></div></div>

<p>Before you perform <code class="highlighter-rouge">hal deploy apply</code>, add the Docker registry corresponding to your region. In case your project is located in Europe, add the eu.gcr.io registry as illustrated below.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hal config provider docker-registry account add gcr-eu <span class="se">\</span>
    <span class="nt">--address</span> eu.gcr.io <span class="se">\</span>
    <span class="nt">--password-file</span> ~/.gcp/gcp.json <span class="se">\</span>
    <span class="nt">--username</span> _json_key

hal config provider kubernetes account edit my-k8s-account <span class="nt">--docker-registries</span> my-gcr-account gcr-eu
</code></pre></div></div>

<h4 id="iam-configuration">IAM Configuration</h4>

<p>Enable Stackdriver access for Spinnaker in <a href="https://console.cloud.google.com/iam-admin/iam">GCP’s IAM settings</a>.</p>

<p>Add the following roles to the member with name <code class="highlighter-rouge">gcs-service-account</code>:</p>
<ul>
  <li>Logging Admin</li>
  <li>Monitoring Admin</li>
</ul>

<h4 id="automated-canary-analysis">Automated Canary Analysis</h4>

<p>Before you perform <code class="highlighter-rouge">hal deploy apply</code>, enable automated canary analysis.
Follow the guide further down, but first of all, set some variables while still SSH’d in the Halyard VM.
One of these variables is the Spinnaker bucket automatically created when installing Halyard.
Look for the right bucket identifier in the GCP GKE buckets dashboard.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">PROJECT_ID</span><span class="o">=</span><span class="k">$(</span>gcloud info <span class="nt">--format</span><span class="o">=</span><span class="s1">'value(config.project)'</span><span class="k">)</span>
<span class="nv">JSON_PATH</span><span class="o">=</span>~/.gcp/gcp.json
<span class="nv">MY_SPINNAKER_BUCKET</span><span class="o">=</span>spin-48b89b5e-dd67-446a-ad9f-66e8783e9822
</code></pre></div></div>

<p>Follow the <a href="https://www.spinnaker.io/setup/canary/#quick-start">official canary quickstart documentation</a>.</p>

<p>Configure the default metrics store.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hal config canary edit <span class="nt">--default-metrics-store</span> stackdriver
</code></pre></div></div>

<p>And finally execute the rollout.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hal deploy apply
</code></pre></div></div>

<h3 id="troubleshooting">Troubleshooting</h3>

<h4 id="authentication">Authentication</h4>
<p>Sometimes an issue might occur with credentials on the Halyard VM:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>! ERROR Unable to communicate with your Kubernetes cluster: Failure
  executing: GET at: https://35.205.113.166/api/v1/namespaces. Message: Forbidden!
  User gke_spinnaker-demo-184310_europe-west1-d_spinnaker-alpha doesn't have
  permission. namespaces is forbidden: User "client" cannot list namespaces at the
  cluster scope: Unknown user "client"..
? Unable to authenticate with your Kubernetes cluster. Try using
  kubectl to verify your credentials.
</code></pre></div></div>

<p>In this case, enable legacy authentication in the GKE UI for the cluster.</p>

<h4 id="cluster-debugging">Cluster Debugging</h4>
<p>You can monitor deployment locally on your own PC by running <code class="highlighter-rouge">kubectl get pods -w --all-namespaces</code>.
For this to work, kubectl needs permissions to talk to the cluster.
You can use gcloud to populate your kubeconfig file with credentials to access the cluster.
This can help you to look into specific logs of each Spinnaker pod or follow up on deployments handled by Spinnaker.</p>

<h4 id="audit-logging">Audit Logging</h4>

<p>You can find out which commands are sent to GCP by enabling audit logging.
Turn on audit logging: https://cloud.google.com/monitoring/audit-logging &amp; https://cloud.google.com/logging/docs/audit/configure-data-access#example</p>

<p><a name="commands"></a></p>

<h3 id="comprehensive-list-of-commands">Comprehensive list of commands</h3>

<p>These are all the commands we have executed in order to get everything set up.
Fill in the <code class="highlighter-rouge">&lt;PLACEHOLDER&gt;</code> placeholders according to your preferences.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">ZONE</span><span class="o">=</span>&lt;ZONE_NAME&gt;
<span class="nv">CLUSTER_VERSION</span><span class="o">=</span>&lt;CLUSTER_VERSION&gt;
<span class="nv">GCP_PROJECT</span><span class="o">=</span>&lt;PROJECT_NAME&gt;

gcloud components update

gcloud auth login
gcloud config <span class="nb">set </span>project <span class="nv">$PROJECT_NAME</span>

gcloud container get-server-config <span class="nt">--zone</span><span class="o">=</span><span class="nv">$ZONE</span>

<span class="nv">CLOUDSDK_CONTAINER_USE_V1_API</span><span class="o">=</span><span class="nb">false
</span><span class="nv">CLOUDSDK_API_CLIENT_OVERRIDES_CONTAINER</span><span class="o">=</span>v1beta1

gcloud beta container clusters create spinnaker <span class="se">\</span>
  <span class="nt">--zone</span><span class="o">=</span><span class="nv">$ZONE</span> <span class="se">\</span>
  <span class="nt">--project</span><span class="o">=</span><span class="nv">$GCP_PROJECT</span> <span class="se">\</span>
  <span class="nt">--cluster-version</span><span class="o">=</span><span class="nv">$CLUSTER_VERSION</span> <span class="se">\</span>
  <span class="nt">--enable-stackdriver-kubernetes</span> <span class="se">\</span>
  <span class="nt">--enable-legacy-authorization</span>

<span class="nv">HALYARD_SA</span><span class="o">=</span>halyard-service-account

gcloud iam service-accounts create <span class="nv">$HALYARD_SA</span> <span class="se">\</span>
    <span class="nt">--project</span><span class="o">=</span><span class="nv">$GCP_PROJECT</span> <span class="se">\</span>
    <span class="nt">--display-name</span> <span class="nv">$HALYARD_SA</span>

<span class="nv">HALYARD_SA_EMAIL</span><span class="o">=</span><span class="k">$(</span>gcloud iam service-accounts list <span class="se">\</span>
    <span class="nt">--project</span><span class="o">=</span><span class="nv">$GCP_PROJECT</span> <span class="se">\</span>
    <span class="nt">--filter</span><span class="o">=</span><span class="s2">"displayName:</span><span class="nv">$HALYARD_SA</span><span class="s2">"</span> <span class="se">\</span>
    <span class="nt">--format</span><span class="o">=</span><span class="s1">'value(email)'</span><span class="k">)</span>

gcloud projects add-iam-policy-binding <span class="nv">$GCP_PROJECT</span> <span class="se">\</span>
    <span class="nt">--role</span> roles/iam.serviceAccountKeyAdmin <span class="se">\</span>
    <span class="nt">--member</span> serviceAccount:<span class="nv">$HALYARD_SA_EMAIL</span>

gcloud projects add-iam-policy-binding <span class="nv">$GCP_PROJECT</span> <span class="se">\</span>
    <span class="nt">--role</span> roles/container.admin <span class="se">\</span>
    <span class="nt">--member</span> serviceAccount:<span class="nv">$HALYARD_SA_EMAIL</span>

<span class="nv">GCS_SA</span><span class="o">=</span>gcs-service-account

gcloud iam service-accounts create <span class="nv">$GCS_SA</span> <span class="se">\</span>
    <span class="nt">--project</span><span class="o">=</span><span class="nv">$GCP_PROJECT</span> <span class="se">\</span>
    <span class="nt">--display-name</span> <span class="nv">$GCS_SA</span>

<span class="nv">GCS_SA_EMAIL</span><span class="o">=</span><span class="k">$(</span>gcloud iam service-accounts list <span class="se">\</span>
    <span class="nt">--project</span><span class="o">=</span><span class="nv">$GCP_PROJECT</span> <span class="se">\</span>
    <span class="nt">--filter</span><span class="o">=</span><span class="s2">"displayName:</span><span class="nv">$GCS_SA</span><span class="s2">"</span> <span class="se">\</span>
    <span class="nt">--format</span><span class="o">=</span><span class="s1">'value(email)'</span><span class="k">)</span>

gcloud projects add-iam-policy-binding <span class="nv">$GCP_PROJECT</span> <span class="se">\</span>
    <span class="nt">--role</span> roles/storage.admin <span class="se">\</span>
    <span class="nt">--member</span> serviceAccount:<span class="nv">$GCS_SA_EMAIL</span>

gcloud projects add-iam-policy-binding <span class="nv">$GCP_PROJECT</span> <span class="se">\</span>
    <span class="nt">--member</span> serviceAccount:<span class="nv">$GCS_SA_EMAIL</span> <span class="se">\</span>
    <span class="nt">--role</span> roles/browser

<span class="nv">HALYARD_HOST</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$USER</span><span class="nt">-halyard-</span><span class="sb">`</span><span class="nb">date</span> +%m%d<span class="sb">`</span> | <span class="nb">tr</span> <span class="s1">'_.'</span> <span class="s1">'-'</span><span class="k">)</span>

gcloud compute instances create <span class="nv">$HALYARD_HOST</span> <span class="se">\</span>
    <span class="nt">--project</span><span class="o">=</span><span class="nv">$GCP_PROJECT</span> <span class="se">\</span>
    <span class="nt">--zone</span><span class="o">=</span><span class="nv">$ZONE</span> <span class="se">\</span>
    <span class="nt">--scopes</span><span class="o">=</span>cloud-platform <span class="se">\</span>
    <span class="nt">--service-account</span><span class="o">=</span><span class="nv">$HALYARD_SA_EMAIL</span> <span class="se">\</span>
    <span class="nt">--image-project</span><span class="o">=</span>ubuntu-os-cloud <span class="se">\</span>
    <span class="nt">--image-family</span><span class="o">=</span>ubuntu-1404-lts <span class="se">\</span>
    <span class="nt">--machine-type</span><span class="o">=</span>n1-standard-4

gcloud compute ssh <span class="nv">$HALYARD_HOST</span> <span class="se">\</span>
    <span class="nt">--project</span><span class="o">=</span><span class="nv">$GCP_PROJECT</span> <span class="se">\</span>
    <span class="nt">--zone</span><span class="o">=</span><span class="nv">$ZONE</span> <span class="se">\</span>
    <span class="nt">--ssh-flag</span><span class="o">=</span><span class="s2">"-L 9000:localhost:9000"</span> <span class="se">\</span>
    <span class="nt">--ssh-flag</span><span class="o">=</span><span class="s2">"-L 8084:localhost:8084"</span>
</code></pre></div></div>

<p>Inside the Halyard VM:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">KUBECTL_LATEST</span><span class="o">=</span><span class="k">$(</span>curl <span class="nt">-s</span> https://storage.googleapis.com/kubernetes-release/release/stable.txt<span class="k">)</span>
curl <span class="nt">-LO</span> https://storage.googleapis.com/kubernetes-release/release/<span class="nv">$KUBECTL_LATEST</span>/bin/linux/amd64/kubectl
<span class="nb">chmod</span> +x kubectl
<span class="nb">sudo mv </span>kubectl /usr/local/bin/kubectl
curl <span class="nt">-O</span> https://raw.githubusercontent.com/spinnaker/halyard/master/install/debian/InstallHalyard.sh
<span class="nb">sudo </span>bash InstallHalyard.sh
<span class="nb">.</span> ~/.bashrc

<span class="nv">GKE_CLUSTER_NAME</span><span class="o">=</span>spinnaker
<span class="nv">GKE_CLUSTER_ZONE</span><span class="o">=</span>europe-west1-d
<span class="nv">PROJECT_ID</span><span class="o">=</span><span class="k">$(</span>gcloud info <span class="nt">--format</span><span class="o">=</span><span class="s1">'value(config.project)'</span><span class="k">)</span>

gcloud config <span class="nb">set </span>container/use_client_certificate <span class="nb">true
</span>gcloud container clusters get-credentials <span class="nv">$GKE_CLUSTER_NAME</span> <span class="se">\</span>
    <span class="nt">--zone</span><span class="o">=</span><span class="nv">$GKE_CLUSTER_ZONE</span>

<span class="nv">GCS_SA</span><span class="o">=</span>gcs-service-account
<span class="nv">GCS_SA_DEST</span><span class="o">=</span>~/.gcp/gcp.json
<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="k">$(</span><span class="nb">dirname</span> <span class="nv">$GCS_SA_DEST</span><span class="k">)</span>
<span class="nv">GCS_SA_EMAIL</span><span class="o">=</span><span class="k">$(</span>gcloud iam service-accounts list <span class="se">\</span>
    <span class="nt">--filter</span><span class="o">=</span><span class="s2">"displayName:</span><span class="nv">$GCS_SA</span><span class="s2">"</span> <span class="se">\</span>
    <span class="nt">--format</span><span class="o">=</span><span class="s1">'value(email)'</span><span class="k">)</span>
gcloud iam service-accounts keys create <span class="nv">$GCS_SA_DEST</span> <span class="se">\</span>
    <span class="nt">--iam-account</span> <span class="nv">$GCS_SA_EMAIL</span>

hal config version edit <span class="nt">--version</span> <span class="k">$(</span>hal version latest <span class="nt">-q</span><span class="k">)</span>
hal config storage gcs edit <span class="se">\</span>
    <span class="nt">--project</span> <span class="nv">$PROJECT_ID</span> <span class="se">\</span>
    <span class="nt">--json-path</span> <span class="nv">$GCS_SA_DEST</span>
hal config storage edit <span class="nt">--type</span> gcs
hal config provider docker-registry <span class="nb">enable
</span>hal config provider docker-registry account add my-gcr-account <span class="se">\</span>
    <span class="nt">--address</span> gcr.io <span class="se">\</span>
    <span class="nt">--password-file</span> <span class="nv">$GCS_SA_DEST</span> <span class="se">\</span>
    <span class="nt">--username</span> _json_key
hal config provider kubernetes <span class="nb">enable
</span>hal config provider kubernetes account add my-k8s-account <span class="se">\</span>
    <span class="nt">--docker-registries</span> my-gcr-account <span class="se">\</span>
    <span class="nt">--context</span> <span class="k">$(</span>kubectl config current-context<span class="k">)</span>

<span class="c"># Only required in case you want to use eu.gcr.io</span>
hal config provider docker-registry account add gcr-eu <span class="se">\</span>
    <span class="nt">--address</span> eu.gcr.io <span class="se">\</span>
    <span class="nt">--password-file</span> <span class="nv">$GCS_SA_DEST</span> <span class="se">\</span>
    <span class="nt">--username</span> _json_key
hal config provider kubernetes account edit my-k8s-account <span class="nt">--docker-registries</span> my-gcr-account gcr-eu

hal config deploy edit <span class="nt">--account-name</span> my-k8s-account
hal config deploy edit <span class="nt">--type</span> distributed

<span class="nv">MY_SPINNAKER_BUCKET</span><span class="o">=</span>&lt;SPINNAKER_BUCKET_ID&gt;

hal config canary <span class="nb">enable
</span>hal config canary google <span class="nb">enable
</span>hal config canary google account add my-google-account <span class="se">\</span>
  <span class="nt">--project</span> <span class="nv">$PROJECT_ID</span> <span class="se">\</span>
  <span class="nt">--json-path</span> <span class="nv">$GCS_SA_DEST</span> <span class="se">\</span>
  <span class="nt">--bucket</span> <span class="nv">$MY_SPINNAKER_BUCKET</span>
hal config canary google edit <span class="nt">--gcs-enabled</span> <span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--stackdriver-enabled</span> <span class="nb">true
</span>hal config canary edit <span class="nt">--default-metrics-store</span> stackdriver
hal deploy apply
hal deploy connect
</code></pre></div></div>

<p><a name="configuration"></a></p>

<h1 id="configuration">Configuration</h1>

<h3 id="application-configuration">Application Configuration</h3>

<p>This guide uses the Kubernetes V1 provider, but you can use V2 just as well.<br />
Follow the <a href="https://www.spinnaker.io/setup/install/providers/kubernetes-v2/#adding-an-account">official documentation</a> to enable the V2 provider.</p>

<p>Visit <a href="http://localhost:9000">localhost:9000</a> to open the Spinnaker UI.<br />
In the applications page, create a new application:</p>
<div class="row" style="margin: 0 25% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="New application" src="/img/spinnaker/Screen Shot 2018-05-28 at 10.58.43.png" />
    
</figure>

</div>
</div>

<p>Under Infrastructure, the Clusters view should normally be opened automatically.
Click the Config link on the top right and enable Canary for this project.</p>
<div class="row" style="margin: 0 auto 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Features" src="/img/spinnaker/Screen Shot 2018-05-28 at 11.02.31.png" />
    
</figure>

</div>
</div>

<p>This should enable Canary Analysis for the project.
The result should be that the Spinnaker menu for this project should be changed.
Pipelines are now nested underneath Delivery, which also now boasts Canary Configs and Canary Reports.<br />
In case this is not visualised directly, you can refresh the cache by clicking on the Spinnaker logo on the top left of the page, and clicking the Refresh all caches link in the Actions drop down.</p>
<div class="row" style="margin: 0 25% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Top menu" src="/img/spinnaker/Screen Shot 2018-05-28 at 16.08.20.png" />
    
</figure>

</div>
</div>

<h3 id="initial-provisioning">Initial Provisioning</h3>

<p>Under Infrastructure, switch to the Load Balancers view and create a load balancer.<br />
Fill in the stack, port, target port and type <code class="highlighter-rouge">LoadBalancer</code>.</p>
<div class="row" style="margin: 0 auto 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Load balancer" src="/img/spinnaker/Screen Shot 2018-05-28 at 11.12.53.png" />
    
</figure>

</div>
</div>

<p>Under Infrastructure, switch to the Clusters view and create a Server Group.</p>
<div class="row" style="margin: 0 25% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Server group 1" src="/img/spinnaker/Screen Shot 2018-05-28 at 11.06.00.png" />
    
</figure>

</div>
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Server group 2" src="/img/spinnaker/Screen Shot 2018-05-28 at 11.06.37.png" />
    
</figure>

</div>
</div>

<p>Once the server group is created, it will show up like this:</p>
<div class="row" style="margin: 0 25% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Chicklet" src="/img/spinnaker/Screen Shot 2018-05-28 at 11.09.45.png" />
    
</figure>

</div>
</div>

<p>By clicking on the little load balancer icon on the right-hand side, we can now visit the Ingress IP through the load balancer view on the side of the page.</p>
<div class="row" style="margin: 0 65% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Ingress" src="/img/spinnaker/Screen Shot 2018-05-28 at 11.14.39.png" />
    
</figure>

</div>
</div>

<p>Back in the server group section, clicking on the little green chicklet will display container information on the side of the page, including logs of the application.</p>

<p>Let’s do this for PROD as well.<br />
Follow exactly the same steps as for DEV, except use <code class="highlighter-rouge">prod</code> as Stack instead of <code class="highlighter-rouge">dev</code>.</p>

<p>Once the PROD load balancer and server group are deployed, we’d like to make sure we never have downtime on PROD.<br />
We can set up a Traffic Guard, responsible for making sure our production cluster always has active instances.<br />
Go to the Config link on the top right of the page, and add a Traffic Guard.</p>
<div class="row" style="margin: 0 auto 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Traffic guards" src="/img/spinnaker/Screen Shot 2018-05-28 at 15.47.35.png" />
    
</figure>

</div>
</div>

<h3 id="staging-pipeline">Staging Pipeline</h3>

<p>Now that we’ve deployed a single version of our application to DEV and PROD, it’s time to create a pipeline.
This will enable us to continuously deploy new versions of our application without having to manually create new server groups every time.<br />
Head over to the pipelines view and create a new pipeline called Deploy to DEV.<br />
Under the first “Configuration” stage, configure an automated trigger.</p>
<div class="row" style="margin: 0 15% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Trigger DEV" src="/img/spinnaker/Screen Shot 2018-05-28 at 11.20.11.png" />
    
</figure>

</div>
</div>

<p>Now add a stage to deploy our application.</p>
<div class="row" style="margin: 0 15% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Template DEV" src="/img/spinnaker/Screen Shot 2018-05-28 at 11.23.39.png" />
    
</figure>

</div>
</div>

<p>We now have to add a server group as deployment configuration.
We can reuse the existing deployment as a template.</p>
<div class="row" style="margin: 0 auto 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Deploy DEV" src="/img/spinnaker/Screen Shot 2018-05-28 at 11.22.30.png" />
    
</figure>

</div>
</div>

<p>Change the strategy to <code class="highlighter-rouge">Highlander</code>.</p>

<p>It’s important to change the image being deployed, otherwise, we’d always deploy the image of our existing server group.<br />
Go down to the Container section and select the Image from Trigger.</p>
<div class="row" style="margin: 0 25% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Image from trigger DEV" src="/img/spinnaker/Screen Shot 2018-05-28 at 11.24.45.png" />
    
</figure>

</div>
</div>

<p>This will automatically change the container image at the top of the dialog box under Basic Settings.</p>
<div class="row" style="margin: 0 25% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Deploy basic DEV" src="/img/spinnaker/Screen Shot 2018-05-28 at 11.27.00.png" />
    
</figure>

</div>
</div>

<p>Keep all other settings as they are.<br />
Save the server group configuration, and save the pipeline.</p>

<p>When we now select the pipelines view, we can see the newly created Deploy to DEV pipeline.<br />
We can test this by either starting a manual execution, or committing a change to our application GIT repository.</p>

<h3 id="production-pipeline">Production Pipeline</h3>

<p>Create new pipeline Deploy to PROD.</p>
<div class="row" style="margin: 0 15% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Trigger PROD" src="/img/spinnaker/Screen Shot 2018-05-28 at 11.33.58.png" />
    
</figure>

</div>
</div>

<p>Add a new Find Image from Cluster stage.
This stage will allow us to look for the image we deployed to DEV, and pass that information on to upcoming stages.</p>
<div class="row" style="margin: 0 15% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Find Image PROD" src="/img/spinnaker/Screen Shot 2018-05-28 at 11.35.51.png" />
    
</figure>

</div>
</div>

<p>Add a new Deploy stage to deploy the new DEV version into production.<br />
Under deploy configuration, add a server group based on the one in DEV.<br />
Make sure to set the right load balancer, i.e. <code class="highlighter-rouge">spinnakedemo-prod</code>.</p>
<div class="row" style="margin: 0 25% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Deploy lb PROD" src="/img/spinnaker/Screen Shot 2018-05-28 at 11.42.31.png" />
    
</figure>

</div>
</div>

<p>Scrolling down to the Container section, select the image found in DEV by the Find Image stage.</p>
<div class="row" style="margin: 0 25% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Deploy container PROD" src="/img/spinnaker/Screen Shot 2018-05-28 at 11.40.12.png" />
    
</figure>

</div>
</div>

<p>Since this is a new version we’d like to push to production, it would be a good idea to build in some safety measures to protect us from unexpected failure.
Using a canary release strategy allows us to limit the blast radius of potential issues that might arrise.<br />
In the Basic Settings section, set the stack as <code class="highlighter-rouge">prod</code> and the detail as <code class="highlighter-rouge">canary</code> to indicate that this deployment is our canary deployment. Also use the <code class="highlighter-rouge">None</code> strategy, since we just want to deploy this canary server group next to the one already active in production.</p>
<div class="row" style="margin: 0 25% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Deploy basic PROD" src="/img/spinnaker/Screen Shot 2018-05-28 at 11.41.03.png" />
    
</figure>

</div>
</div>

<p>Now let’s test this out.<br />
Change the application to respond with PickleRicks if that’s not already the case.
Otherwise, make an insignificant change to the application and push the changes to GIT (master branch).<br />
This should trigger a build, which should push a docker image to the GCR.<br />
That on its turn should trigger the deployment to DEV, which - if successful - should trigger a deployment to PROD.<br />
Once that’s done, your cluster view should look like this:</p>
<div class="row" style="margin: 0 15% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Infra view" src="/img/spinnaker/Screen Shot 2018-05-28 at 15.44.18.png" />
    
</figure>

</div>
</div>
<p>Notice the <code class="highlighter-rouge">V001</code> on DEV, it has replaced the existing manual server group deployment using the highlander strategy.</p>

<p>Currently our canary is registered under the same load balancer as our production cluster. This means traffic is split between the canary and production.<br />
We could test the canary manually by going to the ingress endpoint of the load balancer as we did on DEV.
This could be sufficient for your needs, but Spinnaker offers automated canary analysis (aka. ACA), capable of automatically investigating traffic sent to the canary.<br />
The ACA engine Kayenta will compare certain metrics between the currently running production version, and the newly deployed canary version.<br />
Since comparing a fresh deployment with an old, potentially degraded deployment, could produce unwanted results, it’s advised to deploy both a canary and a current production instance labelled baseline, next to each other.</p>

<p>In the Deploy to PROD pipeline configure screen, add a stage in parallel with Find Image from DEV by clicking on the outer-left Configuration stage, and adding a new stage from that point on.</p>
<div class="row" style="margin: 0 auto 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Find Image PROD" src="/img/spinnaker/Screen Shot 2018-05-28 at 15.57.42.png" />
    
</figure>

</div>
</div>

<p>From that point forward, add another Deploy stage, with the prod server group as template.</p>
<div class="row" style="margin: 0 15% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Template PROD" src="/img/spinnaker/Screen Shot 2018-05-28 at 15.58.51.png" />
    
</figure>

</div>
</div>

<p>At the bottom of the Deployment Cluster Configuration, switch the Container Image to the Find Image result for prod.</p>
<div class="row" style="margin: 0 25% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Deploy container baseline PROD" src="/img/spinnaker/Screen Shot 2018-05-28 at 16.00.03.png" />
    
</figure>

</div>
</div>

<p>Add <code class="highlighter-rouge">baseline</code> as detail, and keep the strategy as <code class="highlighter-rouge">None</code>.</p>
<div class="row" style="margin: 0 25% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Deploy basic baseline PROD" src="/img/spinnaker/Screen Shot 2018-05-28 at 16.01.30.png" />
    
</figure>

</div>
</div>

<p>Save the pipeline.</p>

<p>We now have our basic setup of both a baseline and canary server group to perform canary analysis.</p>

<h3 id="canary-analysis">Canary Analysis</h3>

<p>Our specific demo scenario uses Meeseeks from Rick and Morty as the new version to deploy.<br />
As people who watched the series probably will know, Meeseeks can quickly become a threat to our way of living if we let nature run its course.
Therefore, when switching to Meeseeks, we also write Meeseeks in the logs to keep track of them.</p>

<p>GCP uses Stackdriver for logging and monitoring, so if we’d like to use the logs as a source of information for canary analysis, we should make a Stackdriver metric using the Meeseeks logs.<br />
In the GCP left-hand menu, under the Stackdriver section, you can find Logging and drill down to Logs-based metrics.<br />
Add a new metric using the following filter, replacing the location and project_id by the zone name and project id from earlier in this guide:
<code class="highlighter-rouge">(resource.labels.cluster_name="spinnaker" AND resource.labels.location="europe-west1-d" AND resource.labels.namespace_name="default" AND resource.labels.project_id="spinnaker-demo-184310" AND textPayload:"Meeseeks”)</code></p>

<div class="row" style="margin: 0 65% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Meeseeks log metric" src="/img/spinnaker/Screen Shot 2018-05-28 at 16.34.16.png" />
    
</figure>

</div>
</div>
<div class="row" style="margin: 0 auto 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="User-defined metrics" src="/img/spinnaker/Screen Shot 2018-05-28 at 16.36.00.png" />
    
</figure>

</div>
</div>

<p>Back in Spinnaker, head over to the Canary Configs view under Delivery.<br />
Create a new Canary Config called Demo-config, and add a filter template.<br />
The template will filter based on the replication controller of the server group:<br />
<code class="highlighter-rouge">resource.labels.pod_name:"${scope}"</code></p>
<div class="row" style="margin: 0 25% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Filter template" src="/img/spinnaker/Screen Shot 2018-05-28 at 16.17.57.png" />
    
</figure>

</div>
</div>

<p>Now we can add actual metrics to analyse.<br />
Create a new Metrics Group called Meeseeks, with one metric underneath.</p>
<div class="row" style="margin: 0 25% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Meeseeks metric" src="/img/spinnaker/Screen Shot 2018-05-28 at 16.37.01.png" />
    
</figure>

</div>
</div>

<p>Since we’d also like to know whether our CPU or memory consumption has increased, let’s add some system metrics as well.
We can investigate which filters we can construct by using the <a href="https://cloud.google.com/monitoring/api/ref_v3/rest/v3/projects.timeSeries/list">GCP REST API</a>.<br />
Add a new group called Boring System Metrics, and add the following two metrics.</p>
<div class="row" style="margin: 0 25% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="CPU metric" src="/img/spinnaker/Screen Shot 2018-05-28 at 19.26.55.png" />
    
</figure>


<figure>
    <img class="center-block image fit" alt="RAM metric" src="/img/spinnaker/Screen Shot 2018-05-28 at 19.27.34.png" />
    
</figure>

</div>
</div>

<p>The only thing left to do for this Canary Config, is to configure thresholds for the Metric Groups.<br />
The marginal is treated as a lower bound.
If an interval analysis fails to reach the marginal limit, the entire canary release will be halted and no further intervals will be analysed.
The pass limit is the upper bound, qualifying the analysis as a success.
Anything in between will be recorded and next intervals will be analysed.</p>
<div class="row" style="margin: 0 15% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Thresholds" src="/img/spinnaker/Screen Shot 2018-05-28 at 16.43.21.png" />
    
</figure>

</div>
</div>

<p>Save the Canary Config, and go back to the Deploy to PROD pipeline configuration.</p>

<p>Join both canary and baseline deployments into the Canary Analysis stage, by using the Depends On configuration.</p>
<div class="row" style="margin: 0 auto 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="ACA stage" src="/img/spinnaker/Screen Shot 2018-05-28 at 16.03.21.png" />
    
</figure>

</div>
</div>

<p>Configure the canary analysis stage as follows.</p>
<div class="row" style="margin: 0 15% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Canary config 1" src="/img/spinnaker/Screen Shot 2018-05-28 at 19.09.07.png" />
    
</figure>

</div>
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Canary config 2" src="/img/spinnaker/Screen Shot 2018-05-28 at 19.09.57.png" />
    
</figure>

</div>
</div>

<h3 id="rollout-or-rollback">Rollout or Rollback</h3>

<p>After the Canary Analysis has run, the new version can safely replace the existing production server group.<br />
Add a stage called Deploy to PROD, copying the production server group as template, and use the red/black (aka. blue/green) deployment strategy to avoid any downtime.</p>
<div class="row" style="margin: 0 15% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Template PROD" src="/img/spinnaker/Screen Shot 2018-05-28 at 15.58.51.png" />
    
</figure>

</div>
</div>

<p>At the bottom of the Deployment Cluster Configuration, switch the Container Image to the Find Image result for DEV.</p>
<div class="row" style="margin: 0 25% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Deploy container PROD" src="/img/spinnaker/Screen Shot 2018-05-28 at 11.40.12.png" />
    
</figure>

</div>
</div>

<div class="row" style="margin: 0 25% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Deploy basic PROD" src="/img/spinnaker/Screen Shot 2018-05-28 at 17.03.46.png" />
    
</figure>

</div>
</div>

<p>Regardless whether this pipeline actually succeeds or not, we need to make sure to clean up afterwards.
Add a new pipeline called Tear Down Canary, with the following trigger.</p>
<div class="row" style="margin: 0 15% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Trigger Cleanup" src="/img/spinnaker/Screen Shot 2018-05-28 at 16.51.42.png" />
    
</figure>

</div>
</div>

<p>Add two Destroy Server Group stages in parallel.</p>
<div class="row" style="margin: 0 auto 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Pipeline Cleanup" src="/img/spinnaker/Screen Shot 2018-05-28 at 16.53.56.png" />
    
</figure>

</div>
</div>

<p>Configure the first one to destroy our baseline server group.</p>
<div class="row" style="margin: 0 15% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Destroy baseline" src="/img/spinnaker/Screen Shot 2018-05-28 at 16.54.22.png" />
    
</figure>

</div>
</div>

<p>And finally also destroy the canary server group.</p>
<div class="row" style="margin: 0 15% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Destroy canary" src="/img/spinnaker/Screen Shot 2018-05-28 at 16.54.08.png" />
    
</figure>

</div>
</div>

<p><a name="running-demo"></a></p>

<h1 id="running-the-demo-scenario">Running the demo scenario</h1>

<p>As explained in the <a href="#intro-demo">introduction of the demo application</a>, we have two versions of our application.
As long as we keep deploying green versions with minor changes to other parts of the application (not impacting Meeseeks logs), the whole pipeline should pass, including the canary analysis.</p>

<p>For a canary test to be successful, we need data.
The more data our test can gather, the more informed the decision will be.
In our demo scenario, we can continuously refresh the page to generate more load and more Meeseeks in the logs, but we can also use a script for that.
In the root of the demo repository, a script called <code class="highlighter-rouge">randomload.sh</code> can be used to generate calls to the PROD ingress endpoint at a random interval.<br />
The script uses <a href="https://httpie.org/">HTTPie</a> to make calls, but you can also replace it with <code class="highlighter-rouge">curl</code> commands.
Also, make sure you change the IP address in your forked repository’s file.</p>

<h3 id="success">Success</h3>

<p>A successful canary release would look like this.</p>
<div class="row" style="margin: 0 15% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Success" src="/img/spinnaker/Screen Shot 2018-06-01 at 18.16.10.png" />
    
</figure>

</div>
</div>
<p>Meeseeks logs should occur at a similar rate in the canary and the baseline server group.</p>
<div class="row" style="margin: 0 15% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Success Meeseeks" src="/img/spinnaker/Screen Shot 2018-06-01 at 18.53.45.png" />
    
</figure>

</div>
</div>

<p>CPU and RAM metrics are also part of the comparison.
In the example below, the canary CPU metrics deviated too much from the baseline, resulting in a failure for that metric group.
However, the weight of those metrics were not high enough to fail the verdict, but it did cause the outcome to be labeled <em>marginal</em>.</p>
<div class="row" style="margin: 0 15% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Success RAM" src="/img/spinnaker/Screen Shot 2018-06-01 at 18.37.33.png" />
    
</figure>


<figure>
    <img class="center-block image fit" alt="Success CPU" src="/img/spinnaker/Screen Shot 2018-06-01 at 18.38.06.png" />
    
</figure>

</div>
</div>

<h3 id="failure">Failure</h3>

<p>When switching to the blue Meeseeks version, the initial DEV deploy would succeed, but our canary analysis should fail after one or two intervals.</p>

<p>A failed canary release would look like this.</p>
<div class="row" style="margin: 0 15% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Failed" src="/img/spinnaker/Screen Shot 2018-06-01 at 19.08.12.png" />
    
</figure>

</div>
</div>
<p>The canary server group generated a noticeable higher amount of Meeseeks than our baseline server group, resulting in a failed analysis.</p>
<div class="row" style="margin: 0 15% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Failed Meeseeks" src="/img/spinnaker/Screen Shot 2018-06-01 at 19.09.31.png" />
    
</figure>

</div>
</div>

<p>Even though canary CPU and RAM metrics were quite in sync with the baseline, our Meeseeks metrics were enough to fail the entire pipeline.</p>
<div class="row" style="margin: 0 15% 0 auto;">
<div class="col-md-offset-3 col-md-6">

<figure>
    <img class="center-block image fit" alt="Failed RAM" src="/img/spinnaker/Screen Shot 2018-06-01 at 19.10.09.png" />
    
</figure>


<figure>
    <img class="center-block image fit" alt="Failed CPU" src="/img/spinnaker/Screen Shot 2018-06-01 at 19.08.57.png" />
    
</figure>

</div>
</div>

<p><a name="conclusion"></a></p>

<h1 id="conclusion">Conclusion</h1>

<p>Pickle Rick and Mr. Meeseeks have shown us the power of automated canary analysis using Spinnaker.
There are still a few considerations we have to take into account, such as the importance of choosing the right metrics and filters and iterating on those after each canary release.
Yet, having a tool like this at our disposal allows us to release more often to production, without compromising safety or quality.
By reducing manual and ad hoc analysis only the most stable releases are deployed to production in a highly automated way.</p>

        </div>
    </div>
    <div class="share-page" >
        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://ordina-jworks.github.io/cloud/2018/06/01/Automated-Canary-Analysis-using-Spinnaker.html&title=Automated Canary Analysis using Spinnaker - Codelab&source=https://ordina-jworks.github.io" rel="nofollow" target="_blank" title="Share on LinkedIN">
            <img src="/img/social-media/LinkedIn.png"
                 alt="Share on LinkedIn" />
        </a>
        <a href="https://twitter.com/intent/tweet?text=Automated Canary Analysis using Spinnaker - Codelab&url=https://ordina-jworks.github.io/cloud/2018/06/01/Automated-Canary-Analysis-using-Spinnaker.html&via=lifeatordinabe&related=lifeatordinabe" rel="nofollow" target="_blank" title="Share on Twitter">
            <img src="/img/social-media/Twitter.png"
                 alt="Share on Twitter" />
        </a>
        <a href="https://facebook.com/sharer.php?u=https://ordina-jworks.github.io/cloud/2018/06/01/Automated-Canary-Analysis-using-Spinnaker.html" rel="nofollow" target="_blank" title="Share on Facebook">
            <img src="/img/social-media/Facebook.png"
                 alt="Share on Facebook" />
        </a>
    </div>
        
</section>


<section id="two" class="wrapper alt spotlight style2">
    
    <div class="inner">
        <a href="/author/andreas-evers/" class="image spotlight-image" title="">
            <img src="/img/author/andreas-evers.jpg"
                 alt="" class="p-image"/>
        </a>

        <div class="content">
            
            <p><p>Andreas is a Principal Java consultant at Ordina, passionate about the Spring ecosystem, microservices, REST, clean code and best practices in general. An avid open source enthusiast and Spring contributor. Helps fellow developers as Competence Center leader for architecture and best practices by giving workshops, talks and courses about the newest technologies.</p>
</p>
            
        </div>
    </div>
    
</section>

        </div>
    </section>
</div>



<footer>
    <div class="contact">
        <div class="address">
            <div class="icon"><i class="fa fa-fw fa-home"></i></div>
            <div class="text">Ordina Belgium<br/>Blarenberglaan 3B,<br/>2800 Mechelen, Belgium</div>
        </div>
        <div class="phone">
            <div class="icon"><i class="fa fa-fw fa-phone"></i></div>
            <div class="text"><a href="tel:003215295858">+32 15 29 58 58</a></div>
        </div>
        <div class="email">
            <div class="icon"><i class="fa fa-fw fa-envelope-o"></i></div>
            <div class="text"><a href="mailto:jworks@ordina.be">jworks@ordina.be</a></div>
        </div>
    </div>
    <ul class="social">
        <li>
            <a href="https://twitter.com/lifeatordinabe" target="_blank">
                <i class="fa fa-fw fa-twitter"></i><span>Twitter</span>
            </a>
        </li>
        <li>
            <a href="https://www.facebook.com/lifeatordinabe" target="_blank">
                <i class=" fa fa-fw fa-facebook"></i><span>Facebook</span>
            </a>
        </li>
        <li>
            <a href="https://www.linkedin.com/company/ordina-belgium" target="_blank">
                <i class=" fa fa-fw fa-linkedin"></i><span>LinkedIn</span>
            </a>
        </li>
        <li>
            <a href="https://plus.google.com/113222464071666722451" target="_blank">
                <i class=" fa fa-fw fa-google-plus"></i><span>Google+</span>
            </a>
        </li>
        <li>
            <a href="/youtube" target="_blank">
                <i class=" fa fa-fw fa-youtube"></i><span>YouTube</span>
            </a>
        </li>
        <li>
            <a href="/github" target="_blank">
                <i class=" fa fa-fw fa-github"></i><span>GitHub</span>
            </a>
        </li>
        <li>
            <a href="/feed.xml" target="_blank">
                <i class=" fa fa-fw fa-rss"></i><span>RSS Feed</span>
            </a>
        </li>
    </ul>
    <div class="copyright">
        &copy; 2019 Ordina JWorks. All rights reserved.
        <br /> Disclaimer: Opinions expressed on this blog reflect the writer's views and not the position of Ordina
        <img id="analyticsImg" src="" width="1" height="1" style="border: 0px"/>
    </div>
</footer>
<!-- Scripts -->
<script src="/js/jquery.min.js"></script>
<script src="/js/jquery.scrollex.min.js"></script>
<script src="/js/jquery.magnific-popup.min.js"></script>
<script src="/js/owl.carousel.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/skel.min.js"></script>
<script src="/js/jquery.pin.min.js"></script>
<script src="/js/util.js"></script>
<!--[if lte IE 8]>
<script src="/js/ie/respond.min.js"></script><![endif]-->


<script>
    var imageHref = "/img/spinnaker/spinnaker-logo.png";
    $(function () {
        $('body').addClass('toggle');
    });
</script>


<script src="/js/main.js"></script>

<!-- Google Analytics -->
<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o);
        m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m);
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'UA-70040502-1', 'auto');
    ga('send', 'pageview');
</script>
<script type="text/javascript">
    window.addEventListener('load', function () {
        if (window.ga && ga.create) {
            console.log('GA loaded correctly');
        } else {
            console.log('GA is blocked or failed to load - tracking manually...')
            document.getElementById('analyticsImg').src = 'https://jworks-techblog-analytics.cfapps.io/collect?title=' + document.title;
        }
    }, false);
</script>

<!-- Vertical timeline -->
<script src="/js/vertical-timeline/modernizr.js"></script>
<script src="/js/vertical-timeline/main.js"></script>


</body>
</html>
