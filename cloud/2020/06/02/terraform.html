<!DOCTYPE html>
<!--suppress ALL -->
<html>
<head>
        <meta charset="utf-8">
    <meta name="description" content="We build innovative solutions with Java and JavaScript. To support this mission, we have several Competence Centers. From within those Competence Centers, we provide coaching to the employee and expert advice towards our customer. In order to keep in sync with the latest technologies and the latest trends, we frequently visit conferences around the globe.
">
    <meta name="keywords" content="Ordina,ORAJ,JWorks,Blog,Java,JavaScript,TypeScript,Angular,DevOps">
    <meta name="author" content="Ordina Belgium">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/img/favicons/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/img/favicons/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/img/favicons/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/favicons/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="/img/favicons/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/img/favicons/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/img/favicons/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/img/favicons/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-128.png" sizes="128x128" />

    

    <!-- Twitter Card data -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="From 6 weeks to 90 minutes: let Terraform do your work - Pieter Vincken">
    <meta name="twitter:description" content="Ordina JWorks Tech Blog">
    <meta name="twitter:image" content="http://ordina-jworks.github.io/img/2020-05-30-terraform/terraform.png"/>

    <!-- Facebook Open Graph -->
    <meta property="og:url" content="http://ordina-jworks.github.io/cloud/2020/06/02/terraform.html"/>
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="From 6 weeks to 90 minutes: let Terraform do your work - Pieter Vincken"/>
    <meta property="og:description" content="Ordina JWorks Tech Blog"/>
    <meta property="og:image" content="http://ordina-jworks.github.io/img/2020-05-30-terraform/terraform.png"/>

    
    <title>From 6 weeks to 90 minutes: let Terraform do your work - Pieter Vincken &mdash; Ordina JWorks Tech Blog</title>
    

        <!-- Styles -->
    <!-- Font awesome CSS -->
    <link href="/css/font-awesome.min.css" rel="stylesheet">
    <!-- Magnific Popup -->
    <link href="/css/magnific-popup.css" rel="stylesheet">
    <!-- Owl carousel -->
    <link href="/css/owl.carousel.css" rel="stylesheet">

    <!-- CSS for this page -->

    <!-- Syntax highlighting -->
    <link href="/css/syntax.css" rel="stylesheet">


    <!--[if lte IE 8]>
    <script src="/js/ie/html5shiv.js"></script><![endif]-->
    <link rel="stylesheet" href="/css/main.css"/>
    <!--[if lte IE 9]>
    <link rel="stylesheet" href="/css/ie9.css"/><![endif]-->
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="/css/ie8.css"/><![endif]-->

    <!-- Custom CSS. Type your CSS code in custom.css file -->
    <link href="/css/custom.css" rel="stylesheet">

    <!-- Vertical timeline -->
	<link rel="stylesheet" href="/css/vertical-timeline/style.css"> <!-- Resource style -->

    <!-- Favicon -->
    <link rel="shortcut icon" href="#">

    <script src="https://use.typekit.net/gzh0mbm.js"></script>
    <script>
        try {
            Typekit.load({async: true});
        } catch (e) {
        }
    </script>
</head>

<body>
<div id="header-image"></div>


<!-- Page Wrapper -->
<div id="page-wrapper">

        <!-- Header -->
    <header id="header">
        <h1>
            <a href="/">
                JWorks Tech Blog
            </a>
        </h1>

        <nav>
            <a href="#menu">Menu</a>
            <form action="/search/" method="get" class="header-search search-form">
                <input type="text" id="search-box-header" name="query" placeholder="Search &hellip;">
            </form>
        </nav>
    </header>

    <!-- Menu -->
    <nav id="menu">
        <div class="inner">
            <h2>Menu</h2>
            <ul class="links">
                <li class="menu-item"><a href="/">Home</a></li>
                <li class="menu-item"><a href="/about">About Us</a></li>
                <li class="menu-item"><a href="/meet-the-team">Meet the team</a></li>
                <li class="menu-item"><a href="/jobs">Jobs</a></li>
                <li class="menu-item"><a href="/search">Search</a></li>
                <li class="menu-item"><a href="https://join.ordina-jworks.io/">JOIN</a></li>
                <li class="menu-item"><a href="/contact">Contact Us</a></li>
            </ul>
            <a href="#" class="close">Close</a>
        </div>
    </nav>

    <section id="banner">
        <header>
            <div class="inner">
                

                <h2>From 6 weeks to 90 minutes: let Terraform do your work</h2>
                

                
                    Posted Jun 2, 2020


    in <a href="/categories/cloud/">Cloud</a>



    by
    
        <a href="/author/pieter_vincken/">Pieter Vincken</a>
        
    



    <br/>
    <i class="fa fa-tags"></i>
    
        <a href="/tags/terraform/">Terraform</a>, 
    
        <a href="/tags/configuration-management/">Configuration Management</a>, 
    
        <a href="/tags/infrastructure-as-code/">Infrastructure-as-code</a>, 
    
        <a href="/tags/cloud/">Cloud</a>
    

                

                

            </div>
        </header>
    </section>


    <section id="wrapper">
        <div class="inner">
            <section id="one" class="wrapper spotlight style1 post-body">
    <div class="inner" style="text-align: left;">
        <div class="content">
            <h3 id="reading-time-7-minutes-and-2-seconds">Reading time: 7 minutes and 2 seconds</h3>

<h1 id="table-of-contents">Table of contents</h1>

<ul>
  <li><a href="#how-much-infrastructure-can-you-get-in-6-weeks-time">How much infrastructure can you get in 6 weeks time</a></li>
  <li><a href="#why-use-terraform-to-supercharge-infrastructure-provisioning">Why use Terraform to supercharge infrastructure provisioning</a></li>
  <li><a href="#how-to-structure-terraform-to-allow-for-a-two-second-tire-change">How to structure Terraform to allow for a two second tire change</a></li>
  <li><a href="#how-can-you-beat-us">How can you beat us</a></li>
  <li><a href="#where-to-draw-a-line-everything-in-terraform">Where to draw a line, everything in terraform</a></li>
  <li><a href="#finally-two-golden-tips-when-using-terraform">Finally, two golden tips when using Terraform</a></li>
</ul>

<h2 id="how-much-infrastructure-can-you-get-in-6-weeks-time">How much infrastructure can you get in 6 weeks time</h2>

<p>The landscape discussed in this post is used to host a set of applications for a large corporation to assist one of their core products.
The end-goal of this platform is to support their target market across Europe.</p>

<p>A single environment consists of a namespace on a shared OpenShift cluster, a database and a reverse proxy.
In order to spin up a new environment to onboard a new development team the following steps need to be executed:</p>

<ol>
  <li>Order resources on the shared OpenShift cluster: ticket 1 for the OpenShift team</li>
  <li>Order a reverse proxy: ticket 2 for reverse proxy team</li>
  <li>Order a database: ticket 3 for the database team</li>
  <li>Order a DNS record for the environment to point to OpenShift routers: ticket 4 for the DNS team</li>
  <li>Create a new environment in environment repository</li>
  <li>Run a Jenkins job to create certificates for the environment</li>
  <li>Update the credentials for the new database in online tooling</li>
  <li>Update the credentials for the new database in offline password storage</li>
  <li>Git-encrypt the database credentials and put them in the environment repository</li>
  <li>Update the database connection details in environment repository</li>
  <li>Run an Ansible playbook to create a new namespace in OpenShift and set up the base configuration for the namespace (Docker registry credentials, custom service accounts, â€¦)</li>
  <li>Sync OpenShift service account credentials into Jenkins credential store</li>
  <li>Roll out Jenkins to add the new credentials by starting a Jenkins job executing an Ansible playbook</li>
  <li>Create reverse proxy configuration in reverse proxy repository</li>
  <li>Use a self-service portal to request access for Jenkins to update the configuration on the reverse proxy</li>
  <li>Roll out the reverse proxy configuration using a Jenkins job</li>
  <li>Roll out the environment configuration and application landscape to the new namespace through a Jenkins job that runs OC process and OC applies using the configuration</li>
</ol>

<p>This sums up the best-case scenario.
Since it requires multiple teams to perform disconnected tasks at different times, errors are frequent and slow to resolve.
Next to that, there is a lot of manual work.
This work includes copy and pasting configuration from different sources into different repositories and systems.
Since any manual action, especially involving copying data between locations, is prone to errors, this introduces even more failure points.
Combining the time it takes for tickets to be executed, copying the manual configuration to the correct locations and the debugging involved in getting the environment online results in lead times expressed in weeks.
On one occasion the lead time to set up a single environment for a new team escalated to 6 weeks.
Due to the high lead times at least 1 or 2 spare environments are provisioned in order to provide teams with at least a minimal environment to start working with.
This of course introduces additional cost.</p>

<p>High lead times, human errors and unnecessary operational costs were the main issues of this manual process.
Since the decision was made to migrate to the public cloud, timing was perfect.
Moving to a different infrastructure provided the perfect opportunity to optimize and automate this process.
The expectation was to reduce the lead times to hours, minimize human errors, and minimize capital and operational costs when providing a development team with a new environment.</p>

<h2 id="why-use-terraform-to-supercharge-infrastructure-provisioning">Why use Terraform to supercharge infrastructure provisioning</h2>

<p>As mentioned, one of the main triggers to revisit our infrastructure setup and look into automation was the move to public cloud.
We selected Azure as the cloud provider.
The reasons why Azure was selected are beyond the scope of this blog post.
We might discuss this in a future blog post though.</p>

<p>The logical choice for automating the infrastructure provisioning would be ARM templates, since this is the native provided way for infrastructure as code in Azure.
Together with an external ARM expert, we attempted to set up the target infrastructure using this template technology.
Unfortunately, multiple walls were hit due to the nature of the corporate setup on Azure.
One of the limitations that were hit, was the inability for ARM to make changes to resources that were provided by a central team.
More specifically, using a VNET that wasnâ€™t managed by ARM to deploy an Azure Kubernetes Service proved to be difficult or even impossible.</p>

<p>Using the CLI and scripts to create the setup was attempted as well, but this didnâ€™t fit the vision of a declarative setup for provisioning infrastructure.
Re-applying the same scripts either broke the setup or created additional, unneeded resources.
A clear no-go.</p>

<p>As a third option, Terraform was investigated.
It adhered to the vision of declarative definitions and all the components required by the landscape were available in the Azure Terraform provider.
Some basic setups were created and it showed great potential for the required setup.
Terraform roll outs proved to be more stable and the import mechanism properly supports using components which arenâ€™t fully managed by Terraform.
So Terraform to the rescue!</p>

<h2 id="how-to-structure-terraform-to-allow-for-a-two-second-tire-change">How to structure Terraform to allow for a two second tire change</h2>

<p>One of the challenges of creating a Terraform setup is to determine a way to structure the code.
Looking online provided more questions than answers.
A lot of documentation can be found about how to structure a specific module or how to create modules, but almost no resources discuss how to structure the modules into logical, reusable components.</p>

<p>The setup was divided into two different categories: managed services wrappers and standardized setup modules.</p>

<p>The first category is quite straight forward.
For every managed service that is being used, a module is created.
This module includes all the required Terraform resources for that service to operate.
For example, the key vault module contains the Azure Key Vault Terraform resource, but also the role assignments for the different Active Directory groups that require access to that key vault.
Another example is the container registry module.
It contains the Azure Container Registry (ACR) Terraform resource, some role assignments and the Azure Monitoring Diagnostics Settings for making sure the ACR logs are shipped into the correct logs analytics bucket.
This abstraction allows for opinionated grouping of resources that are required for a managed service to operate.</p>

<p>The second category is a grouping of modules of the first category in order to provide a complete package of features.
This set of modules are the ones that are actually provisioned during a deployment.
Currently, only two of these modules exist: a cluster module and a namespace module.</p>

<p>The cluster module contains all modules required to set up the shared resources for all environments with a similar purpose.
For example, all resources shared by all development environments.
This module contains the Kubernetes cluster module, multiple resource group modules, a key vault module, networking modules and modules that configure identity and role management.
This module is used once per cluster, meaning once for development, acceptance and production respectively.</p>

<p>The second module is used to set up a namespace for a specific purpose: an environment for a development team, a specific testing environment or a rock-solid production environment.
This module contains the DNS zone configuration, an API gateway module, another key vault module and a database module.</p>

<p>These cluster and namespace modules are then used in a single Terraform module per cluster: meaning a single module for the development cluster together with all namespaces in that cluster.
This makes making changes to the infrastructure as easy as running a single Jenkins job executing that module.
We decided to version the modules and created specific modules for development, acceptance and production.
This separation, in combination with the versioning, has allowed us to test module updates and upgrades of the configuration upfront.
Similar to deploying application code to an acceptance or test environment before rolling it into production.</p>

<h2 id="where-to-draw-a-line-everything-in-terraform">Where to draw a line, everything in terraform</h2>

<p>When we first started using Terraform, we were tempted to configure the entire landscape using it.
A good example was the API manager setup we were using.
The Terraform setup included detailed configuration of the application it was hosting.
Another example was a Kubernetes Terraform module we created, that beside infrastructure related setup for storage classes, was also creating service accounts for operators we were running.
This leakage of concerns made it hard to maintain, but it also introduced duplication of configuration towards the application deployment.</p>

<p>We decided to take a stricter approach, and consider two main responsibilities: orchestration and provisioning.
Orchestration could be translated to an engineer that would take a screwdriver and set up all the required infrastructure.
The outcome of this work would be the minimum needed setup to start using the services and configure them for actual use.</p>

<p>Provisioning is the work that comes after this, and doesnâ€™t require a screwdriver, or being near the box.
We decided that the orchestration part, setting up the infrastructure, is where we use Terraform exclusively.
The provisioning part, where we start to configure the infrastructure to work with our application, is where we use tools that are native to the application deployment.</p>

<p>We didnâ€™t get there immediately though.
In early iterations, we had split it into two Terraform runs: an orchestration run and a configuration run.
In later iterations we were able to replace the configuration runs with components that were closer to the application landscape, which was a combination of privileged Kustomize deployment runs and building our own Kubernetes operators.</p>

<p>A good rule of thumb is; if you can tie the component you are configuring to something that has meaning in the application domain, it should be managed in the application landscape.
Another good indication that the application domain leaked into the infrastructure domain is when you have to re-orchestrate your infrastructure together with application changes.</p>

<h2 id="how-can-you-beat-us">How can you beat us</h2>

<p>With this setup, lead-time for provisioning an environment went down from 6 weeks of ticketing magic to just a 90 minute Jenkins run.
The decision to adopt Terraform helped us to minimize human errors, and has enabled us to deploy new environments by a single push of a button.
Infrastructure upgrades have become more and more stable over the adoption period and the different modules have matured to the point where they barely change anymore.</p>

<p>The work being done by the Azure Terraform provider community has helped tremendously.
They release new versions of the provider every week.
They arenâ€™t at feature parity with ARM, not by a long shot, but at the pace they are adding support for features, they will catch up very fast.
The provider is also very stable and if an issue occurs (like <a href="https://github.com/terraform-providers/terraform-provider-azurerm/issues/6525" target="_blank" rel="noopener noreferrer">this</a> AKS bug) itâ€™s fixed within the next release.</p>

<h2 id="finally-two-golden-tips-when-using-terraform">Finally, two golden tips when using Terraform</h2>

<p>The first is to start using remote state storage as soon as possible when using Terraform.
It provides an easy way to get an accurate Terraform plan which in turn provides an accurate overview of the actions Terraform will execute during the roll-out.</p>

<p>The second one is to roll out the modules often and validate their effects by running tests against them.
Test either outcome, not just the configuration.
The further up the application stack these tests run, the better.
In our current setup, the infrastructure runs are part of a nightly test which performs the following steps:</p>

<ol>
  <li>Completely trash the test infrastructure</li>
  <li>Deploy the infrastructure based on the latest configuration</li>
  <li>Deploy the application landscape on top of it</li>
  <li>Run the application landscape end-to-end tests against that freshly created setup</li>
</ol>

<p>Every morning the team smiles when the build is green or (less often now) starts figuring out which component broke and fix it immediately.</p>

<p>Special thanks to the amazing Unicorn team for creating this setup and to <a href="https://twitter.com/joyrex2001" target="_blank" rel="noopener noreferrer">Vincent van Dam</a> for co-writing this post!</p>

        </div>
    </div>
    <div class="share-page" >
        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://ordina-jworks.github.io/cloud/2020/06/02/terraform.html&title=From 6 weeks to 90 minutes: let Terraform do your work&source=https://ordina-jworks.github.io" rel="nofollow" target="_blank" title="Share on LinkedIN">
            <img src="/img/social-media/LinkedIn.png"
                 alt="Share on LinkedIn" />
        </a>
        <a href="https://twitter.com/intent/tweet?text=From 6 weeks to 90 minutes: let Terraform do your work&url=https://ordina-jworks.github.io/cloud/2020/06/02/terraform.html&via=lifeatordinabe&related=lifeatordinabe" rel="nofollow" target="_blank" title="Share on Twitter">
            <img src="/img/social-media/Twitter.png"
                 alt="Share on Twitter" />
        </a>
        <a href="https://facebook.com/sharer.php?u=https://ordina-jworks.github.io/cloud/2020/06/02/terraform.html" rel="nofollow" target="_blank" title="Share on Facebook">
            <img src="/img/social-media/Facebook.png"
                 alt="Share on Facebook" />
        </a>
    </div>
        
</section>


<section id="two" class="wrapper alt spotlight style2">
    
    <div class="inner">
        <a href="/author/pieter_vincken/" class="image spotlight-image" title="">
            <img src="/img/author/pieter-vincken.jpeg"
                 alt="" class="p-image"/>
        </a>

        <div class="content">
            
            <p><p>Pieter Vincken is a Cloud Automation Engineer with a strong interest in anything related to Cloud Native. He likes to optimize development workflows, from Ideation until code running in production, by enabling CI/CD to be fully automated. Any solutions he creates, will have started as an architectural drawing.</p>
</p>
            
        </div>
    </div>
    
</section>

        </div>
    </section>
</div>



<footer>
    <div class="contact">
        <div class="address">
            <div class="icon"><i class="fa fa-fw fa-home"></i></div>
            <div class="text">Ordina Belgium<br/>Blarenberglaan 3B,<br/>2800 Mechelen, Belgium</div>
        </div>
        <div class="phone">
            <div class="icon"><i class="fa fa-fw fa-phone"></i></div>
            <div class="text"><a href="tel:003215295858">+32 15 29 58 58</a></div>
        </div>
        <div class="email">
            <div class="icon"><i class="fa fa-fw fa-envelope-o"></i></div>
            <div class="text"><a href="mailto:jworks@ordina.be">jworks@ordina.be</a></div>
        </div>
    </div>
    <ul class="social">
        <li>
            <a href="https://twitter.com/lifeatordinabe" target="_blank">
                <i class="fa fa-fw fa-twitter"></i><span>Twitter</span>
            </a>
        </li>
        <li>
            <a href="https://www.facebook.com/lifeatordinabe" target="_blank">
                <i class=" fa fa-fw fa-facebook"></i><span>Facebook</span>
            </a>
        </li>
        <li>
            <a href="https://www.linkedin.com/company/ordinabelgium" target="_blank">
                <i class=" fa fa-fw fa-linkedin"></i><span>LinkedIn</span>
            </a>
        </li>
        <li>
            <a href="/youtube" target="_blank">
                <i class=" fa fa-fw fa-youtube"></i><span>YouTube</span>
            </a>
        </li>
        <li>
            <a href="/github" target="_blank">
                <i class=" fa fa-fw fa-github"></i><span>GitHub</span>
            </a>
        </li>
        <li>
            <a href="/feed.xml" target="_blank">
                <i class=" fa fa-fw fa-rss"></i><span>RSS Feed</span>
            </a>
        </li>
    </ul>
    <div class="copyright">
        &copy; 2022 Ordina JWorks. All rights reserved.
        <br /> Disclaimer: Opinions expressed on this blog reflect the writer's views and not the position of Ordina
        <img id="analyticsImg" src="" width="1" height="1" style="border: 0px"/>
    </div>
</footer>
<!-- Scripts -->
<script src="/js/jquery.min.js"></script>
<script src="/js/jquery.scrollex.min.js"></script>
<script src="/js/jquery.magnific-popup.min.js"></script>
<script src="/js/owl.carousel.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/skel.min.js"></script>
<script src="/js/jquery.pin.min.js"></script>
<script src="/js/util.js"></script>
<!--[if lte IE 8]>
<script src="/js/ie/respond.min.js"></script><![endif]-->


<script>
    var imageHref = "/img/2020-05-30-terraform/terraform.png";
    $(function () {
        $('body').addClass('toggle');
    });
</script>


<script src="/js/main.js"></script>

<!-- Google Analytics -->
<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o);
        m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m);
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'UA-70040502-1', 'auto');
    ga('send', 'pageview');
</script>
<script type="text/javascript">
    window.addEventListener('load', function () {
        if (window.ga && ga.create) {
            console.log('GA loaded correctly');
        } else {
            console.log('GA is blocked or failed to load - tracking manually...')
            document.getElementById('analyticsImg').src = 'https://jworks-techblog-analytics.cfapps.io/collect?title=' + document.title;
        }
    }, false);
</script>

<!-- Vertical timeline -->
<script src="/js/vertical-timeline/modernizr.js"></script>
<script src="/js/vertical-timeline/main.js"></script>


</body>
</html>
