<!DOCTYPE html>
<!--suppress ALL -->
<html>
<head>
        <meta charset="utf-8">
    <meta name="description" content="We build innovative solutions with Java and JavaScript. To support this mission, we have several Competence Centers. From within those Competence Centers, we provide coaching to the employee and expert advice towards our customer. In order to keep in sync with the latest technologies and the latest trends, we frequently visit conferences around the globe.
">
    <meta name="keywords" content="Ordina,ORAJ,JWorks,Blog,Java,JavaScript,TypeScript,Angular,DevOps">
    <meta name="author" content="Ordina Belgium">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/img/favicons/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/img/favicons/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/img/favicons/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/favicons/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="/img/favicons/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/img/favicons/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/img/favicons/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/img/favicons/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-128.png" sizes="128x128" />

    

    <!-- Twitter Card data -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Digitally signing your JSON documents - Tim Ysewyn">
    <meta name="twitter:description" content="Ordina JWorks Tech Blog">
    <meta name="twitter:image" content="http://ordina-jworks.github.io/img/digitally-signing-your-json-documents.png"/>

    <!-- Facebook Open Graph -->
    <meta property="og:url" content="http://ordina-jworks.github.io/security/2016/03/12/Digitally-signing-your-JSON-documents.html"/>
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Digitally signing your JSON documents - Tim Ysewyn"/>
    <meta property="og:description" content="Ordina JWorks Tech Blog"/>
    <meta property="og:image" content="http://ordina-jworks.github.io/img/digitally-signing-your-json-documents.png"/>

    
    <title>Digitally signing your JSON documents - Tim Ysewyn &mdash; Ordina JWorks Tech Blog</title>
    

        <!-- Styles -->
    <!-- Font awesome CSS -->
    <link href="/css/font-awesome.min.css" rel="stylesheet">
    <!-- Magnific Popup -->
    <link href="/css/magnific-popup.css" rel="stylesheet">
    <!-- Owl carousel -->
    <link href="/css/owl.carousel.css" rel="stylesheet">

    <!-- CSS for this page -->

    <!-- Syntax highlighting -->
    <link href="/css/syntax.css" rel="stylesheet">


    <!--[if lte IE 8]>
    <script src="/js/ie/html5shiv.js"></script><![endif]-->
    <link rel="stylesheet" href="/css/main.css"/>
    <!--[if lte IE 9]>
    <link rel="stylesheet" href="/css/ie9.css"/><![endif]-->
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="/css/ie8.css"/><![endif]-->

    <!-- Custom CSS. Type your CSS code in custom.css file -->
    <link href="/css/custom.css" rel="stylesheet">

    <!-- Vertical timeline -->
	<link rel="stylesheet" href="/css/vertical-timeline/style.css"> <!-- Resource style -->

    <!-- Favicon -->
    <link rel="shortcut icon" href="#">

    <script src="https://use.typekit.net/gzh0mbm.js"></script>
    <script>
        try {
            Typekit.load({async: true});
        } catch (e) {
        }
    </script>
</head>

<body>
<div id="header-image"></div>


<!-- Page Wrapper -->
<div id="page-wrapper">

        <!-- Header -->
    <header id="header">
        <h1>
            <a href="/">
                JWorks Tech Blog
            </a>
        </h1>

        <nav>
            <a href="#menu">Menu</a>
            <form action="/search/" method="get" class="header-search search-form">
                <input type="text" id="search-box-header" name="query" placeholder="Search &hellip;">
            </form>
        </nav>
    </header>

    <!-- Menu -->
    <nav id="menu">
        <div class="inner">
            <h2>Menu</h2>
            <ul class="links">
                <li class="menu-item"><a href="/">Home</a></li>
                <li class="menu-item"><a href="/about">About Us</a></li>
                <li class="menu-item"><a href="/meet-the-team">Meet the team</a></li>
                <li class="menu-item"><a href="/jobs">Jobs</a></li>
                <li class="menu-item"><a href="/search">Search</a></li>
                <li class="menu-item"><a href="https://join.ordina-jworks.io/">JOIN</a></li>
                <li class="menu-item"><a href="/contact">Contact Us</a></li>
            </ul>
            <a href="#" class="close">Close</a>
        </div>
    </nav>

    <section id="banner">
        <header>
            <div class="inner">
                

                <h2>Digitally signing your JSON documents</h2>
                

                
                    Posted Mar 12, 2016


    in <a href="/categories/security/">Security</a>



    by
    
        <a href="/author/tim-ysewyn/">Tim Ysewyn</a>
        
    



    <br/>
    <i class="fa fa-tags"></i>
    
        <a href="/tags/security/">Security</a>, 
    
        <a href="/tags/jose/">JOSE</a>, 
    
        <a href="/tags/jws/">JWS</a>, 
    
        <a href="/tags/json-web-signature/">JSON Web Signature</a>
    

                

                

            </div>
        </header>
    </section>


    <section id="wrapper">
        <div class="inner">
            <section id="one" class="wrapper spotlight style1 post-body">
    <div class="inner" style="text-align: left;">
        <div class="content">
            <h2 id="what-is-a-digital-signature">What is a digital signature?</h2>

<p>A digital signature is a mathematical scheme for demonstrating the authenticity of a digital message or documents.
A valid digital signature gives a recipient reason to believe that the message was created by a known sender, that the sender cannot deny having sent the message (<strong>authentication</strong> and <strong>non-repudiation</strong>), and that the message was not altered in transit (<strong>integrity</strong>).</p>

<p>Digital signatures are a standard element of most cryptographic protocol suites.
They are commonly used for software distribution, financial transactions, and in other cases where it is important to detect forgery or tampering.</p>

<p>Non-repudiation refers to a state of affairs where the author of a statement will not be able to successfully challenge the authorship of the statement or validity of an associated contract.
The term is often seen in a legal setting wherein the authenticity of a signature is being challenged.
In such an instance, the authenticity is being “repudiated”.</p>

<p><br /></p>

<h2 id="meet-jose">Meet JOSE</h2>

<p><a href="https://www.iana.org/assignments/jose/jose.xhtml">JOSE</a> is a framework intended to provide a method to securely transfer claims (such as authorisation information) between parties.
The JOSE framework consists of several specifications to serve this purpose:</p>

<ul>
  <li><a href="#jwk">JWK</a> – JSON Web Key, describes format and handling of cryptographic keys in JOSE</li>
  <li><a href="#jws">JWS</a> – JSON Web Signature, describes producing and handling signed messages</li>
  <li><a href="#jwe">JWE</a> – JSON Web Encryption, describes producing and handling encrypted messages</li>
  <li><a href="#jwa">JWA</a> – JSON Web Algorithms, describes cryptographic algorithms used in JOSE</li>
  <li><a href="#jwt">JWT</a> – JSON Web Token, describes representation of claims encoded in JSON and protected by JWS or JWE</li>
</ul>

<p><br /></p>

<h2 id="jwk">JWK</h2>

<p>A JSON Web Key (<a href="https://tools.ietf.org/html/rfc7517">RFC7517</a>) is a JavaScript Object Notation (JSON) data structure that represents a cryptographic key.</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="w">    </span><span class="p">{</span><span class="w"> 
        </span><span class="nl">"kty"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EC"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"crv"</span><span class="p">:</span><span class="w"> </span><span class="s2">"P-256"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"x"</span><span class="p">:</span><span class="w"> </span><span class="s2">"f83OJ3D2xF1Bg8vub9tLe1gHMzV76e8Tus9uPHvRVEU"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"y"</span><span class="p">:</span><span class="w"> </span><span class="s2">"x_FEzRu9m36HLN_tue659LNpXW6pCyStikYjKIWI5a0"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"use"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sig"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"kid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Public key used to sign our messages"</span><span class="w">
    </span><span class="p">}</span></code></pre></figure>

<p>In this example you can see a couple of parameters.
The first of them “kty” defines the key type, which is a mandatory field.
Depending on the type you’ve chosen other parameters can be set, like you see above.
As our type is EC, or Elliptic Curve, we want to specify the type of curve and our point.
Next to these parameters we also have the optional “use” to denote intended usage of the key and “kid” as key ID.
At the time of writing there are three supported key types: “EC”, “RSA” and “oct”.
While “EC” and “RSA” are used for asymmetric encryption, “oct” is used for symmetric encryption</p>

<p><br /></p>

<h2 id="jws">JWS</h2>

<p>The JSON Web Signature (<a href="https://tools.ietf.org/html/rfc7515">RFC7515</a>) standard describes the process of creation and validation of a data structure representing a signed payload.
Assume someone wants to transfer an amount of money to his savings account.
This action could be represented like the following JSON:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="w">    </span><span class="p">{</span><span class="w"> 
        </span><span class="nl">"from"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Tim Ysewyn"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"account"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Checking account"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"to"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Tim Ysewyn"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"account"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Savings account"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"amount"</span><span class="p">:</span><span class="w"> </span><span class="mi">250</span><span class="p">,</span><span class="w">
        </span><span class="nl">"currency"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EUR"</span><span class="w">
    </span><span class="p">}</span></code></pre></figure>

<p>In this example we are using a JSON document, but this is not relevant for the signing procedure.
Before we can sign this we need to convert this to base64url encoding, which will be our payload.
So actually we might be using any type of data!
The result of the base64url encoding of above transaction is:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">eyAKICAgICAgICAiZnJvbSI6ewogICAgICAgICAgICAibmFtZSI6ICJUaW0gWXNld3luIiwKICAgICAgICAgICAgImFjY291bnQiOiAiQ2hlY2tpbmcgYWNjb3VudCIKICAgICAgICB9LAogICAgICAgICJ0byI6ewogICAgICAgICAgICAibmFtZSI6ICJUaW0gWXNld3luIiwKICAgICAgICAgICAgImFjY291bnQiOiAiU2F2aW5ncyBhY2NvdW50IgogICAgICAgIH0sCiAgICAgICAgImFtb3VudCI6IDI1MAogICAgICAgICJjdXJyZW5jeSI6ICJFVVIiCiAgICB9</code></pre></figure>

<p>Additional parameters are associated with each payload.
One of those is the required “alg” parameter, which indicates what algorithm needs to be used to generate a signature.
Here we can also specify “none” to send unprotected messages.
All parameters are included in the final JWS.
These can either be sent as a protected or unprotected header.
The data in the unprotected header is human readable associated data, whereas data in the protected header is integrity protected and base64url encoded.
Assume we want to sign our payload using a key like we generated in the previous section.
Our data structure would look like this:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="w">    </span><span class="p">{</span><span class="w"> 
        </span><span class="nl">"alg"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ES256"</span><span class="w">
    </span><span class="p">}</span></code></pre></figure>

<p>and base64url encoded this would be:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">eyAKICAgICAgICAiYWxnIjogIlJTMjU2IgogICAgfQ==</code></pre></figure>

<p>The base64url encoded payload and protected header are concatenated with a ‘.’ to form raw data, which is fed to the signature algorithm to produce the final signature.
Finally all of this output will be serialized using one the JSON or Compact serialisations.
Compact serialisation is simple concatenation of dot separated base64url encoded protected header, payload and signature.
JSON serialisation is a human readable JSON object, which for the example in this section would look like this:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="w">    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"payload"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eyAKICAgICAgICAiZnJvbSI6ewogICAgICAgICAgICAibmFtZSI6ICJUaW0gWXNld3luIiwKICAgICAgICAgICAgImFjY291bnQiOiAiQ2hlY2tpbmcgYWNjb3VudCIKICAgICAgICB9LAogICAgICAgICJ0byI6ewogICAgICAgICAgICAibmFtZSI6ICJUaW0gWXNld3luIiwKICAgICAgICAgICAgImFjY291bnQiOiAiU2F2aW5ncyBhY2NvdW50IgogICAgICAgIH0sCiAgICAgICAgImFtb3VudCI6IDI1MAogICAgICAgICJjdXJyZW5jeSI6ICJFVVIiCiAgICB9"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"protected"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eyAKICAgICAgICAiYWxnIjogIlJTMjU2IgogICAgfQ=="</span><span class="p">,</span><span class="w">
      </span><span class="nl">"header"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"kid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"e9bc097a-ce51-4036-9562-d2ade882db0d"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"signature"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DtEhU3ljbEg8L38VWAfUAqOyKAM6-Xx-F4GawxaepmXFCgfTjDxw5djxLa8ISlSApmWQxfKTUJqPP3-Kg6NU01Q"</span><span class="w">
    </span><span class="p">}</span></code></pre></figure>

<p>Before we conclude this section, there is one more thing I would like to share with you.
Because we want to sign and protect our messages, we always want to use asymmetric encryption.
But, once our private key has been captured, anyone who has this can forge transactions.
One way that <strong>COULD</strong> counter this is to generate a new key pair every session, or even per transaction.
Including the public key in the <strong>protected</strong> header would not only give the server the ability the validate the signature, we will also be sure that it is the correct one since the protected header is integrity protected!</p>

<p><br /></p>

<h2 id="jwe">JWE</h2>

<p>JSON Web Encryption (<a href="https://tools.ietf.org/html/rfc7516">RFC7516</a>) follows the same logic as JWS with a few differences:</p>

<ul>
  <li>by default, for each message a new content encryption key (CEK) should be generated.
This key is used to encrypt the plaintext and is attached to the final message.
Public key of recipient or a shared key is used only to encrypt the CEK (unless direct encryption is used).</li>
  <li>only AEAD (Authenticated Encryption with Associated Data) algorithms are defined in the standard, so users do not have to think about how to combine JWE with JWS.</li>
</ul>

<p>To keep it short: While JWS can be read by everyone because of the simple base64url encoding, we could use JWE to encrypt some or all of our fields.</p>

<p><br /></p>

<h2 id="jwa">JWA</h2>

<p>JSON Web Algorithms (<a href="https://tools.ietf.org/html/rfc7518">RFC7518</a>) defines algorithms and their identifiers to be used in JWS and JWE.
The three parameters that specify algorithms are “alg” for JWS, “alg” and “enc” for JWE.
Visit following links to view the list of supported algorithms for <a href="https://tools.ietf.org/html/rfc7518#section-3">JWS</a> and <a href="https://tools.ietf.org/html/rfc7518#section-5">JWE</a></p>

<p><br /></p>

<h2 id="jwt">JWT</h2>

<p>JSON Web Token (<a href="https://tools.ietf.org/html/rfc7519">RFC7519</a>) is used for passing claims between parties in a web application environment.
Because the tokens are designed to be compact and URL-safe they are especially usable in a web browser <a href="https://en.wikipedia.org/wiki/Single_sign-on">single sign-on</a> (SSO) context.
JWT claims can be typically used to pass the identity of authenticated users between an <a href="https://en.wikipedia.org/wiki/Identity_provider">identity provider</a> and a <a href="https://en.wikipedia.org/wiki/Service_provider">service provider</a>.
JWT relies on all previously mentioned JSON standards.</p>

<p>The JWT standard defines claims - key/value pairs asserting information about a subject.
The claims include</p>

<ul>
  <li>“iss” identifies the principal that issued the token</li>
  <li>“sub” identifies the principal that is the subject of the token</li>
  <li>“aud” (audience) identifies the intended recipients</li>
  <li>“exp” identifies the expiration time on or after which the token <strong>MUST NOT</strong> be accepted for processing</li>
  <li>“nbf” (not before) identifies the time before which the token <strong>MUST NOT</strong> be accepted for processing</li>
  <li>“iat” (issued at) identifies the time at which the token was issued</li>
  <li>“jti” (JWT ID) provides a unique identifier for the token</li>
</ul>

<p>These claims are not mandatory to be used or implement in all cases, but they rather provide a starting point for a set of useful, interoperable claims.</p>

<p><br /></p>

<h2 id="so-how-do-we-sign-this-json-document-in-code">So, how do we sign this JSON document in code?</h2>

<p>Ranging from Java and .NET to Node.js, there are already a lot of libraries available on the <a href="https://jwt.io/#libraries-io">internet</a>.
And even JavaScript has its own implementation of the standard!</p>

<p>Because of its fluent API, we are using the Java JWT implementation in this post.
Since not all algorithms are implemented in Java, we are also going to use Bouncy Castle as our <a href="https://en.wikipedia.org/wiki/Java_Cryptography_Architecture">JCA</a> provider.</p>

<p>In our maven configuration we just add following two dependencies:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml">    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>io.jsonwebtoken<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>jjwt<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>0.6.0<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.bouncycastle<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>bcprov-jdk15on<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.54<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span></code></pre></figure>

<p>If you are working with a gradle project it would be:</p>

<figure class="highlight"><pre><code class="language-gradle" data-lang="gradle">    <span class="n">runtime</span> <span class="s1">'io.jsonwebtoken:jjwt:0.6.0'</span><span class="o">,</span>
            <span class="s1">'org.bouncycastle:bcprov-jdk15on:1.54'</span></code></pre></figure>

<p>If we were to implement the examples from the previous sections, we would start of with generating a new public-private key pair.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java">    <span class="nc">KeyPair</span> <span class="n">keyPair</span> <span class="o">=</span> <span class="nc">EllipticCurveProvider</span><span class="o">.</span><span class="na">generateKeyPair</span><span class="o">(</span><span class="nc">SignatureAlgorithm</span><span class="o">.</span><span class="na">ES256</span><span class="o">);</span></code></pre></figure>

<p>It’s as easy as that!
We want to have a key of type “EC” so we use the <code class="language-plaintext highlighter-rouge">EllipticCurveProvider</code>, and by specifying <code class="language-plaintext highlighter-rouge">SignatureAlgorithm.ES256</code> we use the P-256 bit curve with SHA-256 hashing.</p>

<p>Next we want to sign our base64url encoded payload</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java">    <span class="nc">Jwts</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">setPayload</span><span class="o">(</span><span class="s">"eyAKICAgICAgICAiZnJvbSI6ewogICAgICAgICAgICAibmFtZSI6ICJUaW0gWXNld3luIiwKICAgICAgICAgICAgImFjY291bnQiOiAiQ2hlY2tpbmcgYWNjb3VudCIKICAgICAgICB9LAogICAgICAgICJ0byI6ewogICAgICAgICAgICAibmFtZSI6ICJUaW0gWXNld3luIiwKICAgICAgICAgICAgImFjY291bnQiOiAiU2F2aW5ncyBhY2NvdW50IgogICAgICAgIH0sCiAgICAgICAgImFtb3VudCI6IDI1MAogICAgICAgICJjdXJyZW5jeSI6ICJFVVIiCiAgICB9"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">signWith</span><span class="o">(</span><span class="nc">SignatureAlgorithm</span><span class="o">.</span><span class="na">ES256</span><span class="o">,</span> <span class="n">keyPair</span><span class="o">.</span><span class="na">getPrivate</span><span class="o">())</span>
                <span class="o">.</span><span class="na">compact</span><span class="o">();</span></code></pre></figure>

<p>Since we already encoded our original message in the <a href="#jws">JWS section</a>, I’m not getting here into detail again.
<code class="language-plaintext highlighter-rouge">signWith(SignatureAlgorithm.ES256, keyPair.getPrivate())</code> does a couple of things.
First it is going the create a header if not already present and it will add the “alg” key with the value of “ES256”.
After that it will base64url encode that header and will append this with a ‘.’ and the encoded payload.
This whole blob of data will then be signed using the private key of the previously generated key pair.
Last, but not least, is the <code class="language-plaintext highlighter-rouge">compact</code> method.
This will just output the base64url encoded header and payload with the generated signature, and all parts are separated with a dot.
An outcome would be something like:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">eyJhbGciOiJFUzI1NiJ9
.
ZXlBS0lDQWdJQ0FnSUNBaVpuSnZiU0k2ZXdvZ0lDQWdJQ0FnSUNBZ0lDQWlibUZ0WlNJNklDSlVhVzBnV1hObGQzbHVJaXdLSUNBZ0lDQWdJQ0FnSUNBZ0ltRmpZMjkxYm5RaU9pQWlRMmhsWTJ0cGJtY2dZV05qYjNWdWRDSUtJQ0FnSUNBZ0lDQjlMQW9nSUNBZ0lDQWdJQ0owYnlJNmV3b2dJQ0FnSUNBZ0lDQWdJQ0FpYm1GdFpTSTZJQ0pVYVcwZ1dYTmxkM2x1SWl3S0lDQWdJQ0FnSUNBZ0lDQWdJbUZqWTI5MWJuUWlPaUFpVTJGMmFXNW5jeUJoWTJOdmRXNTBJZ29nSUNBZ0lDQWdJSDBzQ2lBZ0lDQWdJQ0FnSW1GdGIzVnVkQ0k2SURJMU1Bb2dJQ0FnSUNBZ0lDSmpkWEp5Wlc1amVTSTZJQ0pGVlZJaUNpQWdJQ0I5
.
MEYCIQCcwunLBiuHu2z_SlDVJyZuQv0NU8X4VYoOFN1EuIvObQIhAJeZuTeZw9k5uhpBc60iT13s3yb01ItSB2MhEd5pUSqC</code></pre></figure>

<p>We split the three parts for better visualisation, the JWS would be one large <code class="language-plaintext highlighter-rouge">String</code></p>

<p><br /></p>

<h2 id="validating-the-signature">Validating the signature</h2>

<p>First we will check if the JWS was actually signed.
This can be accomplished by executing following line of code.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java">    <span class="nc">Jwts</span><span class="o">.</span><span class="na">parser</span><span class="o">().</span><span class="na">isSigned</span><span class="o">(</span><span class="n">jws</span><span class="o">);</span></code></pre></figure>

<p>To parse the JWS, we use the <code class="language-plaintext highlighter-rouge">parse()</code> method.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java">    <span class="nc">Jwts</span><span class="o">.</span><span class="na">parser</span><span class="o">()</span>
        <span class="o">.</span><span class="na">setSigningKey</span><span class="o">(</span><span class="n">publicKey</span><span class="o">)</span>
        <span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">jws</span><span class="o">);</span></code></pre></figure>

<p>Depending wether it is signed or not we might need to set the key for validation.
In our case we need to specify the public key of our asymmetric key pair.
If we would try to parse the JWS without a key an <code class="language-plaintext highlighter-rouge">IllegalArgumentException</code> will be thrown.
Should a wrong public key have been provided a <code class="language-plaintext highlighter-rouge">SignatureException</code> would be thrown, telling us to <strong>not</strong> trust this JWS.</p>

<p>If we were to pass our public key in the protected header like we said in the <a href="#jws">JWS section</a>, we should use the <code class="language-plaintext highlighter-rouge">setSigningKeyResolver()</code> method.
This custom resolver would read out the “jwk” field from the protected header and return a public key based on the data that was provided.</p>

<p>Our own <code class="language-plaintext highlighter-rouge">SigningKeyResolver</code> implementation could look like this:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ECPublicSigningKeyResolver</span> <span class="kd">implements</span> <span class="nc">SigningKeyResolver</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="nc">Key</span> <span class="nf">resolveSigningKey</span><span class="o">(</span><span class="nc">JwsHeader</span> <span class="n">header</span><span class="o">,</span> <span class="nc">Claims</span> <span class="n">claims</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">getPublicKey</span><span class="o">(</span><span class="n">header</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">Key</span> <span class="nf">resolveSigningKey</span><span class="o">(</span><span class="nc">JwsHeader</span> <span class="n">header</span><span class="o">,</span> <span class="nc">String</span> <span class="n">plaintext</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">getPublicKey</span><span class="o">(</span><span class="n">header</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="nc">Key</span> <span class="nf">getPublicKey</span><span class="o">(</span><span class="nc">JwsHeader</span> <span class="n">header</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">jwk</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectMapper</span><span class="o">().</span><span class="na">readValue</span><span class="o">(</span><span class="n">header</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"jwk"</span><span class="o">).</span><span class="na">toString</span><span class="o">(),</span> <span class="nc">HashMap</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            
                <span class="nc">String</span> <span class="n">curve</span> <span class="o">=</span> <span class="n">jwk</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"crv"</span><span class="o">);</span>
                <span class="nc">BigInteger</span> <span class="n">x</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigInteger</span><span class="o">(</span><span class="n">jwk</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"x"</span><span class="o">),</span> <span class="mi">16</span><span class="o">);</span>
                <span class="nc">BigInteger</span> <span class="n">y</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigInteger</span><span class="o">(</span><span class="n">jwk</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"y"</span><span class="o">),</span> <span class="mi">16</span><span class="o">);</span>
                <span class="nc">String</span> <span class="n">keyType</span> <span class="o">=</span> <span class="n">jwk</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"kty"</span><span class="o">);</span>

                <span class="nc">ECNamedCurveParameterSpec</span> <span class="n">ecNamedCurveParameterSpec</span> <span class="o">=</span> <span class="nc">ECNamedCurveTable</span><span class="o">.</span><span class="na">getParameterSpec</span><span class="o">(</span><span class="n">crv</span><span class="o">);</span>
            
                <span class="nc">ECCurve</span> <span class="n">curve</span> <span class="o">=</span> <span class="n">ecNamedCurveParameterSpec</span><span class="o">.</span><span class="na">getCurve</span><span class="o">();</span>
                <span class="nc">ECPoint</span> <span class="n">g</span> <span class="o">=</span> <span class="n">ecNamedCurveParameterSpec</span><span class="o">.</span><span class="na">getG</span><span class="o">();</span>
                <span class="nc">BigInteger</span> <span class="n">n</span> <span class="o">=</span> <span class="n">ecNamedCurveParameterSpec</span><span class="o">.</span><span class="na">getN</span><span class="o">();</span>
                <span class="nc">BigInteger</span> <span class="n">h</span> <span class="o">=</span> <span class="n">ecNamedCurveParameterSpec</span><span class="o">.</span><span class="na">getH</span><span class="o">();</span>

                <span class="nc">ECParameterSpec</span> <span class="n">ecParameterSpec</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ECParameterSpec</span><span class="o">(</span><span class="n">curve</span><span class="o">,</span> <span class="n">g</span><span class="o">,</span> <span class="n">n</span><span class="o">,</span> <span class="n">h</span><span class="o">);</span>
                <span class="nc">ECPoint</span> <span class="n">ecPoint</span> <span class="o">=</span> <span class="n">curve</span><span class="o">.</span><span class="na">createPoint</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">);</span>

                <span class="nc">ECPublicKeySpec</span> <span class="n">ecPublicKeySpec</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ECPublicKeySpec</span><span class="o">(</span><span class="n">ecPoint</span><span class="o">,</span> <span class="n">ecParameterSpec</span><span class="o">);</span>

                <span class="nc">KeyFactory</span> <span class="n">keyFactory</span> <span class="o">=</span> <span class="nc">KeyFactory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">kty</span><span class="o">);</span>

                <span class="k">return</span> <span class="n">keyFactory</span><span class="o">.</span><span class="na">generatePublic</span><span class="o">(</span><span class="n">ecPublicKeySpec</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchAlgorithmException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InvalidKeySpecException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre></figure>

<p>First we read all our data from the “jwk” field.
Next we retrieve the <code class="language-plaintext highlighter-rouge">ECNamedCurveParameterSpec</code> based on the “crv” field and assemble a new <code class="language-plaintext highlighter-rouge">ECParameterSpec</code>.
After that we create a new <code class="language-plaintext highlighter-rouge">ECPublicKeySpec</code> with the <code class="language-plaintext highlighter-rouge">ECParameterSpec</code> and an <code class="language-plaintext highlighter-rouge">ECPoint</code> out of the x and y coordinates.
Finally we get a <code class="language-plaintext highlighter-rouge">KeyFactory</code> instance for our key type “kty” and generate the public key with our <code class="language-plaintext highlighter-rouge">ECPublicKeySpec</code>.</p>

<p><br /></p>

<h2 id="conclusion">Conclusion</h2>

<p>JOSE is a simple, compact and lightweight framework to sign and encrypt your payload messages.
Because of the combination of base64url encoded messages and JSON data structures it is web friendly.
With the wide range of libraries this can be used across platforms with native and hybrid applications, even web applications can use this!
One particular disadvantage with the use of the compact dot notation is that you can’t send unprotected header data anymore.</p>

<p><br /></p>

<h2 id="final-note">Final note</h2>

<p>Above examples should only be used as reference. In a production environment we need to use both JWS and JWE.
One could embed a public key of an asymmetric key pair in the application.
During login a new symmetric key will be generated, encrypted with that public key and sent to the server.
This symmetric key can only be decrypted by the server with the private key, and should then be stored in the session.
Every time we need to sign a JSON document, we would use the symmetric key to encrypt the JWS using JWE.</p>

<p>It doesn’t matter how you encrypt your messages, and which algorithms you use.
Once your application has been hacked, the whole system is vulnerable.</p>

        </div>
    </div>
    <div class="share-page" >
        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://ordina-jworks.github.io/security/2016/03/12/Digitally-signing-your-JSON-documents.html&title=Digitally signing your JSON documents&source=https://ordina-jworks.github.io" rel="nofollow" target="_blank" title="Share on LinkedIN">
            <img src="/img/social-media/LinkedIn.png"
                 alt="Share on LinkedIn" />
        </a>
        <a href="https://twitter.com/intent/tweet?text=Digitally signing your JSON documents&url=https://ordina-jworks.github.io/security/2016/03/12/Digitally-signing-your-JSON-documents.html&via=lifeatordinabe&related=lifeatordinabe" rel="nofollow" target="_blank" title="Share on Twitter">
            <img src="/img/social-media/Twitter.png"
                 alt="Share on Twitter" />
        </a>
        <a href="https://facebook.com/sharer.php?u=https://ordina-jworks.github.io/security/2016/03/12/Digitally-signing-your-JSON-documents.html" rel="nofollow" target="_blank" title="Share on Facebook">
            <img src="/img/social-media/Facebook.png"
                 alt="Share on Facebook" />
        </a>
    </div>
        
</section>


<section id="two" class="wrapper alt spotlight style2">
    
    <div class="inner">
        <a href="/author/tim-ysewyn/" class="image spotlight-image" title="">
            <img src="/img/author/tim-ysewyn.png"
                 alt="" class="p-image"/>
        </a>

        <div class="content">
            
            <p><p>Tim is a Principal Consultant at Ordina, where he helps fellow developers discovering top-notch technologies and methodologies as a Competence Leader for API &amp; Microservices. You can also find him working on various parts of the <a href="https://www.spring.io" target="_blank">Spring</a> framework or helping out at <a href="https://ng-be.org" target="_blank">NG-BE</a>. When you can't get a hold of him, he will probably be under water since he is also an underwater photographer &amp; rescue diver.</p>
</p>
            
        </div>
    </div>
    
</section>

        </div>
    </section>
</div>



<footer>
    <div class="contact">
        <div class="address">
            <div class="icon"><i class="fa fa-fw fa-home"></i></div>
            <div class="text">Ordina Belgium<br/>Blarenberglaan 3B,<br/>2800 Mechelen, Belgium</div>
        </div>
        <div class="phone">
            <div class="icon"><i class="fa fa-fw fa-phone"></i></div>
            <div class="text"><a href="tel:003215295858">+32 15 29 58 58</a></div>
        </div>
        <div class="email">
            <div class="icon"><i class="fa fa-fw fa-envelope-o"></i></div>
            <div class="text"><a href="mailto:jworks@ordina.be">jworks@ordina.be</a></div>
        </div>
    </div>
    <ul class="social">
        <li>
            <a href="https://twitter.com/lifeatordinabe" target="_blank">
                <i class="fa fa-fw fa-twitter"></i><span>Twitter</span>
            </a>
        </li>
        <li>
            <a href="https://www.facebook.com/lifeatordinabe" target="_blank">
                <i class=" fa fa-fw fa-facebook"></i><span>Facebook</span>
            </a>
        </li>
        <li>
            <a href="https://www.linkedin.com/company/ordinabelgium" target="_blank">
                <i class=" fa fa-fw fa-linkedin"></i><span>LinkedIn</span>
            </a>
        </li>
        <li>
            <a href="/youtube" target="_blank">
                <i class=" fa fa-fw fa-youtube"></i><span>YouTube</span>
            </a>
        </li>
        <li>
            <a href="/github" target="_blank">
                <i class=" fa fa-fw fa-github"></i><span>GitHub</span>
            </a>
        </li>
        <li>
            <a href="/feed.xml" target="_blank">
                <i class=" fa fa-fw fa-rss"></i><span>RSS Feed</span>
            </a>
        </li>
    </ul>
    <div class="copyright">
        &copy; 2023 Ordina JWorks. All rights reserved.
        <br /> Disclaimer: Opinions expressed on this blog reflect the writer's views and not the position of Ordina
        <img id="analyticsImg" src="" width="1" height="1" style="border: 0px"/>
    </div>
</footer>
<!-- Scripts -->
<script src="/js/jquery.min.js"></script>
<script src="/js/jquery.scrollex.min.js"></script>
<script src="/js/jquery.magnific-popup.min.js"></script>
<script src="/js/owl.carousel.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/skel.min.js"></script>
<script src="/js/jquery.pin.min.js"></script>
<script src="/js/util.js"></script>
<!--[if lte IE 8]>
<script src="/js/ie/respond.min.js"></script><![endif]-->


<script>
    var imageHref = "/img/digitally-signing-your-json-documents.png";
    $(function () {
        $('body').addClass('toggle');
    });
</script>


<script src="/js/main.js"></script>

<!-- Google Analytics -->
<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o);
        m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m);
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'UA-70040502-1', 'auto');
    ga('send', 'pageview');
</script>
<script type="text/javascript">
    window.addEventListener('load', function () {
        if (window.ga && ga.create) {
            console.log('GA loaded correctly');
        } else {
            console.log('GA is blocked or failed to load - tracking manually...')
            document.getElementById('analyticsImg').src = 'https://jworks-techblog-analytics.cfapps.io/collect?title=' + document.title;
        }
    }, false);
</script>

<!-- Vertical timeline -->
<script src="/js/vertical-timeline/modernizr.js"></script>
<script src="/js/vertical-timeline/main.js"></script>


</body>
</html>
