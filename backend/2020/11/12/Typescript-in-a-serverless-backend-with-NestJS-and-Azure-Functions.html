<!DOCTYPE html>
<!--suppress ALL -->
<html>
<head>
        <meta charset="utf-8">
    <meta name="description" content="We build innovative solutions with Java and JavaScript. To support this mission, we have several Competence Centers. From within those Competence Centers, we provide coaching to the employee and expert advice towards our customer. In order to keep in sync with the latest technologies and the latest trends, we frequently visit conferences around the globe.
">
    <meta name="keywords" content="Ordina,ORAJ,JWorks,Blog,Java,JavaScript,TypeScript,Angular,DevOps">
    <meta name="author" content="Ordina Belgium">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/img/favicons/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/img/favicons/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/img/favicons/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/favicons/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="/img/favicons/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/img/favicons/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/img/favicons/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/img/favicons/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-128.png" sizes="128x128" />

    

    <!-- Twitter Card data -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="TypeScript in a serverless backend with NestJS and Azure Functions - Jasper Rosiers">
    <meta name="twitter:description" content="Ordina JWorks Tech Blog">
    <meta name="twitter:image" content="http://ordina-jworks.github.io/img/2020-11-12-Typescript-in-the-backend-with-NestJS-and-Azure-Functions/banner.png"/>

    <!-- Facebook Open Graph -->
    <meta property="og:url" content="http://ordina-jworks.github.io/backend/2020/11/12/Typescript-in-a-serverless-backend-with-NestJS-and-Azure-Functions.html"/>
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="TypeScript in a serverless backend with NestJS and Azure Functions - Jasper Rosiers"/>
    <meta property="og:description" content="Ordina JWorks Tech Blog"/>
    <meta property="og:image" content="http://ordina-jworks.github.io/img/2020-11-12-Typescript-in-the-backend-with-NestJS-and-Azure-Functions/banner.png"/>

    
    <title>TypeScript in a serverless backend with NestJS and Azure Functions - Jasper Rosiers &mdash; Ordina JWorks Tech Blog</title>
    

        <!-- Styles -->
    <!-- Font awesome CSS -->
    <link href="/css/font-awesome.min.css" rel="stylesheet">
    <!-- Magnific Popup -->
    <link href="/css/magnific-popup.css" rel="stylesheet">
    <!-- Owl carousel -->
    <link href="/css/owl.carousel.css" rel="stylesheet">

    <!-- CSS for this page -->

    <!-- Syntax highlighting -->
    <link href="/css/syntax.css" rel="stylesheet">


    <!--[if lte IE 8]>
    <script src="/js/ie/html5shiv.js"></script><![endif]-->
    <link rel="stylesheet" href="/css/main.css"/>
    <!--[if lte IE 9]>
    <link rel="stylesheet" href="/css/ie9.css"/><![endif]-->
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="/css/ie8.css"/><![endif]-->

    <!-- Custom CSS. Type your CSS code in custom.css file -->
    <link href="/css/custom.css" rel="stylesheet">

    <!-- Vertical timeline -->
	<link rel="stylesheet" href="/css/vertical-timeline/style.css"> <!-- Resource style -->

    <!-- Favicon -->
    <link rel="shortcut icon" href="#">

    <script src="https://use.typekit.net/gzh0mbm.js"></script>
    <script>
        try {
            Typekit.load({async: true});
        } catch (e) {
        }
    </script>
</head>

<body>
<div id="header-image"></div>


<!-- Page Wrapper -->
<div id="page-wrapper">

        <!-- Header -->
    <header id="header">
        <h1>
            <a href="/">
                JWorks Tech Blog
            </a>
        </h1>

        <nav>
            <a href="#menu">Menu</a>
            <form action="/search/" method="get" class="header-search search-form">
                <input type="text" id="search-box-header" name="query" placeholder="Search &hellip;">
            </form>
        </nav>
    </header>

    <!-- Menu -->
    <nav id="menu">
        <div class="inner">
            <h2>Menu</h2>
            <ul class="links">
                <li class="menu-item"><a href="/">Home</a></li>
                <li class="menu-item"><a href="/about">About Us</a></li>
                <li class="menu-item"><a href="/meet-the-team">Meet the team</a></li>
                <li class="menu-item"><a href="/jobs">Jobs</a></li>
                <li class="menu-item"><a href="/launch-your-career">Career</a></li>
                <li class="menu-item"><a href="/search">Search</a></li>
                <li class="menu-item"><a href="/contact">Contact Us</a></li>
            </ul>
            <a href="#" class="close">Close</a>
        </div>
    </nav>

    <section id="banner">
        <header>
            <div class="inner">
                

                <h2>TypeScript in a serverless backend with NestJS and Azure Functions</h2>
                

                
                    Posted Nov 12, 2020


    in <a href="/categories/backend/">Backend</a>



    by
    
        <a href="/author/jasper-rosiers/">Jasper Rosiers</a>
        
    



    <br/>
    <i class="fa fa-tags"></i>
    
        <a href="/tags/typescript/">TypeScript</a>, 
    
        <a href="/tags/backend/">Backend</a>, 
    
        <a href="/tags/nestjs/">NestJS</a>, 
    
        <a href="/tags/azure/">Azure</a>, 
    
        <a href="/tags/serverless/">Serverless</a>
    

                

                

            </div>
        </header>
    </section>


    <section id="wrapper">
        <div class="inner">
            <section id="one" class="wrapper spotlight style1 post-body">
    <div class="inner" style="text-align: left;">
        <div class="content">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.9.0/css/lightbox.css" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-grid-only@1.0.0/bootstrap.css" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.9.0/js/lightbox.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap-grid-only@1.0.0/index.min.js"></script>

<h2 id="table-of-contents">Table of Contents</h2>

<ol>
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#setup">Setup</a></li>
  <li><a href="#parametersmodule">ParametersModule</a></li>
  <li><a href="#authorization-guards">Authorization Guards</a></li>
  <li><a href="#azure-function-and-cosmosdb">Azure Function and CosmosDB</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
  <li><a href="#resources">Resources</a></li>
</ol>

<h2 id="introduction">Introduction</h2>

<p>When I asked a colleague to validate my code structure for this blog, he asked me “Why would one use TypeScript in the backend at all?”. 
He’s a Java programmer and didn’t know TypeScript’s properties very well. 
An introduction: TypeScript is an asynchronous, functional programming language which compiles down to plain JavaScript. 
It supports interfaces, classes and access modifiers like private, protected and public.</p>

<p>When first using TypeScript, it felt less easy than using Spring Boot, which I had used prior during Java programming.
This is where NestJS comes in, a NodeJS framework built for the backend with Object Oriented Programming in mind.
If you have worked with a framework like Spring before, NestJS will be quite easy for you to understand.
It requires a modular way of working, which makes sure the application stays well organised.</p>

<p>In this blog, we take a dive into using NestJS in a serverless application hosted in an Azure Function and connect it with a CosmosDB.
Of course, NestJS can be integrated with other serverless services like <a href="https://blog.theodo.com/2019/06/deploy-a-nestjs-app-in-5-minutes-with-serverless-framework/" target="_blank" rel="noopener noreferrer">AWS Lambda</a> and <a href="https://jacob-do.medium.com/token-validation-with-aws-cognito-and-nestjs-6f9e4088393c" target="_blank" rel="noopener noreferrer">Cognito</a>.
However, I found the process of converting this application to a serverless function to be a very smooth solution requiring only one(!) command.</p>

<h2 id="setup">Setup</h2>

<p>I made a little application which can save and return three parameters of your body: weight, fat percentage and muscle percentage.
The app is automatically deployed to an Azure function using Azure Pipelines and saves those parameters to a CosmosDB.
I made the code available on <a href="https://github.com/jasperrosiers/body-parameter-tracker" target="_blank" rel="noopener noreferrer">GitHub</a> for you to learn from, as we won’t touch on everything in the repository in this blog post.</p>

<p>The user can send new data to the application, which will keep the history of the three parameters in a CosmosDB.
Apart from the main <code class="language-plaintext highlighter-rouge">AppModule</code>, I only added two modules, the <code class="language-plaintext highlighter-rouge">ParametersModule</code> and the <code class="language-plaintext highlighter-rouge">LoggerModule</code> to the application.
This blog post won’t explain building the <code class="language-plaintext highlighter-rouge">LoggerModule</code>, as it only serves to create a custom logger.
The <a href="https://docs.nestjs.com/techniques/logger" target="_blank" rel="noopener noreferrer">NestJS documentation</a> provides a very clear explanation of how to use a custom logger.</p>

<p>The application has two (basic) guards set up for the HTTP calls, one for authorization and one for role-based access. 
For this guard, we use a simple bearer token, however, integration with eg. Cognito or JWT tokens is available.</p>

<h2 id="parametersmodule">ParametersModule</h2>

<p>A Module in NestJS provides a clear way of organizing the project and enabling clear dependency injection.
There are four important things you can mark within a module:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">controllers</code>: classes which capture incoming HTTP calls</li>
  <li><code class="language-plaintext highlighter-rouge">providers</code>: classes marked with NestJS’s <code class="language-plaintext highlighter-rouge">@Injectable()</code>, made available for dependency injection</li>
  <li><code class="language-plaintext highlighter-rouge">imports</code>: modules that need to be imported, again for dependency injection</li>
  <li><code class="language-plaintext highlighter-rouge">exports</code>: subset of the providers that need to be exported for use in other modules</li>
</ul>

<p>The <code class="language-plaintext highlighter-rouge">ParametersModule</code> imports three other modules: the previously explained <code class="language-plaintext highlighter-rouge">LoggerModule</code>, the <code class="language-plaintext highlighter-rouge">ConfigModule</code> and the <code class="language-plaintext highlighter-rouge">AzureCosmosDBModule</code>.
The <code class="language-plaintext highlighter-rouge">ConfigModule</code> is used to be able to access environment variables from a <code class="language-plaintext highlighter-rouge">.env</code> file or from the configuration of the Azure Function. 
Note that this is also possible with a package such as <code class="language-plaintext highlighter-rouge">dotenv</code>, however this isn’t very ideal as we would have to access <code class="language-plaintext highlighter-rouge">process.env</code> directly every time.
Of course, pushing those environment files to Git is bad practice. 
You can find a <code class="language-plaintext highlighter-rouge">.env-sample</code> file in the repository, which is used to show which variables need to be filled in the <code class="language-plaintext highlighter-rouge">.env</code> file.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">Module</span><span class="p">({</span>
  <span class="na">controllers</span><span class="p">:</span> <span class="p">[</span><span class="nx">ParametersController</span><span class="p">],</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span>
      <span class="nx">ParametersService</span><span class="p">,</span> 
      <span class="nx">ParametersRepository</span><span class="p">,</span>
      <span class="p">{</span>
        <span class="na">provide</span><span class="p">:</span> <span class="nx">APP_GUARD</span><span class="p">,</span>
        <span class="na">useClass</span><span class="p">:</span> <span class="nx">RolesGuard</span><span class="p">,</span>
      <span class="p">},</span>
  <span class="p">],</span>
  <span class="na">imports</span><span class="p">:</span> <span class="p">[</span>
      <span class="nx">LoggerModule</span><span class="p">,</span>
      <span class="nx">ConfigModule</span><span class="p">,</span>
      <span class="nx">AzureCosmosDbModule</span><span class="p">.</span><span class="nx">forFeature</span><span class="p">([{</span><span class="na">dto</span><span class="p">:</span> <span class="nx">ParametersEntity</span><span class="p">}])</span>
  <span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ParametersModule</span> <span class="p">{}</span>
</code></pre></div></div>

<p>The first step when receiving an HTTP request to the application is the <code class="language-plaintext highlighter-rouge">ParametersController</code> as shown below.
This controller will catch all requests on the ‘parameters’ endpoint.
Using annotations, you can:</p>
<ul>
  <li>Make a check for the type of incoming request and divide the traffic accordingly. This is similar to the way annotations work in the Spring Framework (eg. <code class="language-plaintext highlighter-rouge">@PostMapping</code>).</li>
  <li>Customise which HTTP code you want to return on successful calls, as I did with the <code class="language-plaintext highlighter-rouge">createParameters</code> method.</li>
  <li>Use the <code class="language-plaintext highlighter-rouge">@Res()</code> from <code class="language-plaintext highlighter-rouge">express</code> to send a completely customised response, however I did not use that here.</li>
  <li>Execute Guards before being able to activate the method</li>
</ul>

<p>Let’s focus on the <code class="language-plaintext highlighter-rouge">Post()</code> method. 
It first asks the <code class="language-plaintext highlighter-rouge">parametersService</code> to check if there is an object with the given <code class="language-plaintext highlighter-rouge">userName</code> present in the database.
We could ask the <code class="language-plaintext highlighter-rouge">parametersRepository</code> for this information directly, however, having this layer of abstraction is essential for having cleaner code.
If there is no object present yet, it will create a new one, otherwise, it will update the existing one. 
For this update, it will map the new info to the existing object. 
Again, we use the <code class="language-plaintext highlighter-rouge">parametersService</code> for its abstraction layer, the controller should only be used for methods capturing HTTP calls.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">Controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">parameters</span><span class="dl">'</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ParametersController</span> <span class="p">{</span>
    <span class="kd">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">readonly</span> <span class="nx">parametersService</span><span class="p">:</span> <span class="nx">ParametersService</span><span class="p">,</span> <span class="kr">private</span> <span class="nx">readonly</span> <span class="nx">loggerSerivce</span><span class="p">:</span> <span class="nx">LoggerService</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">loggerService</span><span class="p">.</span><span class="nx">setContext</span><span class="p">(</span><span class="dl">'</span><span class="s1">ParametersController</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="p">@</span><span class="nd">Post</span><span class="p">()</span>
    <span class="p">@</span><span class="nd">HttpCode</span><span class="p">(</span><span class="nx">HttpStatus</span><span class="p">.</span><span class="nx">CREATED</span><span class="p">)</span>
    <span class="p">@</span><span class="nd">UseGuards</span><span class="p">(</span><span class="nx">AuthGuard</span><span class="p">)</span>
    <span class="k">async</span> <span class="nx">createParameters</span><span class="p">(@</span><span class="nd">Body</span><span class="p">()</span> <span class="nx">parametersDto</span><span class="p">:</span> <span class="nx">ParametersDto</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ParametersEntity</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">parametersDto</span> <span class="o">||</span> <span class="nx">parametersDto</span><span class="p">.</span><span class="nx">userName</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="nx">parametersDto</span><span class="p">.</span><span class="nx">bodyWeight</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">parametersDto</span><span class="p">.</span><span class="nx">fatPercentage</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">parametersDto</span><span class="p">.</span><span class="nx">musclePercentage</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// could implement @Res() from express to send a proper response to say it should at least contain one of the parameters or a userName</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">const</span> <span class="na">existingParams</span><span class="p">:</span> <span class="nx">ParametersEntity</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">parametersService</span><span class="p">.</span><span class="nx">getParametersEntityByUserName</span><span class="p">(</span><span class="nx">parametersDto</span><span class="p">.</span><span class="nx">userName</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">existingParams</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="na">updatedParams</span><span class="p">:</span> <span class="nx">ParametersEntity</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parametersService</span><span class="p">.</span><span class="nx">mapDtoToEntity</span><span class="p">(</span><span class="nx">parametersDto</span><span class="p">,</span> <span class="nx">existingParams</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">parametersService</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">updatedParams</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">parametersService</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">parametersDto</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="p">@</span><span class="nd">Get</span><span class="p">(</span><span class="dl">'</span><span class="s1">:id</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">@</span><span class="nd">UseGuards</span><span class="p">(</span><span class="nx">AuthGuard</span><span class="p">)</span>
    <span class="p">@</span><span class="nd">Roles</span><span class="p">(</span><span class="dl">'</span><span class="s1">user</span><span class="dl">'</span><span class="p">)</span>
    <span class="k">async</span> <span class="nx">findOne</span><span class="p">(@</span><span class="nd">Param</span><span class="p">(</span><span class="dl">'</span><span class="s1">userName</span><span class="dl">'</span><span class="p">)</span> <span class="nx">userName</span><span class="p">:</span> <span class="nx">string</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ParametersEntity</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">parametersService</span><span class="p">.</span><span class="nx">getParametersEntityByUserName</span><span class="p">(</span><span class="nx">userName</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="p">@</span><span class="nd">Get</span><span class="p">()</span>
    <span class="p">@</span><span class="nd">UseGuards</span><span class="p">(</span><span class="nx">AuthGuard</span><span class="p">)</span>
    <span class="p">@</span><span class="nd">Roles</span><span class="p">(</span><span class="dl">'</span><span class="s1">admin</span><span class="dl">'</span><span class="p">)</span>
    <span class="k">async</span> <span class="nx">findAll</span><span class="p">():</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ParametersEntity</span><span class="p">[]</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">parametersService</span><span class="p">.</span><span class="nx">getAll</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Moving on to the <code class="language-plaintext highlighter-rouge">ParametersService</code>, we’ll only take a glance at the <code class="language-plaintext highlighter-rouge">create()</code> function.
When receiving an HTTP call, it will contain values for at least one of our three parameters.
In this method, we just check the values and add them to the respective array. 
The <code class="language-plaintext highlighter-rouge">update</code> field contains the moment that the value gets updated to track the user’s progress over time.
The parameters will then be put into a <code class="language-plaintext highlighter-rouge">ParametersEntity</code> (Discussed in <a href="#azure-function-and-cosmosdb">Azure Function and CosmosDB</a>) and added to the database using the <code class="language-plaintext highlighter-rouge">parametersRepository</code>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ParametersService</span> <span class="p">{</span>
    <span class="kd">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">readonly</span> <span class="nx">parametersRepository</span><span class="p">:</span> <span class="nx">ParametersRepository</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">async</span> <span class="nx">create</span><span class="p">(</span><span class="nx">parametersDto</span><span class="p">:</span> <span class="nx">ParametersDto</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ParametersEntity</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="na">bodyweight</span><span class="p">:</span> <span class="nx">BodyweightDto</span><span class="p">;</span>
        <span class="kd">let</span> <span class="na">fatPercentage</span><span class="p">:</span> <span class="nx">PercentageDto</span><span class="p">;</span>
        <span class="kd">let</span> <span class="na">musclePercentage</span><span class="p">:</span> <span class="nx">PercentageDto</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">parametersDto</span><span class="p">.</span><span class="nx">bodyWeight</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">bodyweight</span> <span class="o">=</span> <span class="p">{</span>
                <span class="na">weight</span><span class="p">:</span> <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">([</span><span class="nx">parametersDto</span><span class="p">.</span><span class="nx">bodyWeight</span><span class="p">]),</span>
                <span class="na">update</span><span class="p">:</span> <span class="p">[</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()]</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">parametersDto</span><span class="p">.</span><span class="nx">fatPercentage</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">fatPercentage</span> <span class="o">=</span> <span class="p">{</span>
                <span class="na">percentage</span><span class="p">:</span> <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">([</span><span class="nx">parametersDto</span><span class="p">.</span><span class="nx">fatPercentage</span><span class="p">]),</span>
                <span class="na">update</span><span class="p">:</span> <span class="p">[</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()]</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">parametersDto</span><span class="p">.</span><span class="nx">musclePercentage</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">musclePercentage</span> <span class="o">=</span> <span class="p">{</span>
                <span class="na">percentage</span><span class="p">:</span> <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">([</span><span class="nx">parametersDto</span><span class="p">.</span><span class="nx">musclePercentage</span><span class="p">]),</span>
                <span class="na">update</span><span class="p">:</span> <span class="p">[</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()]</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">parametersRepository</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="k">new</span> <span class="nx">ParametersEntity</span><span class="p">(</span><span class="nx">parametersDto</span><span class="p">.</span><span class="nx">userName</span><span class="p">,</span> <span class="nx">bodyweight</span><span class="p">,</span> <span class="nx">fatPercentage</span><span class="p">,</span> <span class="nx">musclePercentage</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="c1">// More code</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">create()</code> function in the <code class="language-plaintext highlighter-rouge">ParametersRepository</code> adds the date the object was created and adds it to the database.
We see a good example of the <code class="language-plaintext highlighter-rouge">loggerService</code> here too.
First, we set the context to ‘ParametersRepository’, so that, when it logs something, it will show that the log came from this class.
This way, logs can easily be retraced to its origin.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ParametersRepository</span> <span class="p">{</span>

    <span class="kd">constructor</span><span class="p">(@</span><span class="nd">InjectModel</span><span class="p">(</span><span class="nx">ParametersEntity</span><span class="p">)</span> <span class="kr">private</span> <span class="nx">readonly</span> <span class="nx">container</span><span class="p">:</span> <span class="nx">Container</span><span class="p">,</span> <span class="kr">private</span> <span class="nx">loggerService</span><span class="p">:</span> <span class="nx">LoggerService</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">loggerService</span><span class="p">.</span><span class="nx">setContext</span><span class="p">(</span><span class="dl">'</span><span class="s1">ParametersRepository</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">async</span> <span class="nx">create</span><span class="p">(</span><span class="nx">item</span><span class="p">:</span> <span class="nx">ParametersEntity</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ParametersEntity</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="nx">item</span><span class="p">.</span><span class="nx">createdAt</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
        <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">container</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">loggerService</span><span class="p">.</span><span class="nx">verbose</span><span class="p">(</span><span class="s2">`Create RUs: </span><span class="p">${</span><span class="nx">response</span><span class="p">.</span><span class="nx">requestCharge</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">resource</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<h2 id="authorization-guards">Authorization Guards</h2>

<p>The project uses two guards, an <code class="language-plaintext highlighter-rouge">AuthGuard</code> for the authorization, and a <code class="language-plaintext highlighter-rouge">RolesGuard</code> to check which roles can access certain resources.
A good explanation of both can be found in the <a href="https://docs.nestjs.com/guards" target="_blank" rel="noopener noreferrer">NestJS documentation</a>.
The <code class="language-plaintext highlighter-rouge">RolesGuard</code> is almost an exact copy from the documentation, so let’s take a look at the <code class="language-plaintext highlighter-rouge">AuthGuard</code> which doesn’t need to be provided from a module.</p>

<p>The <code class="language-plaintext highlighter-rouge">canActivate()</code> method is called before executing the method in the controller.
It needs to return <code class="language-plaintext highlighter-rouge">true</code>, or the method won’t execute and the application will return a 401 Unauthorized code.
In this case, we check if the authorization header has the correct value as configured in the environment variables.
Other setups, like OAuth, Cognito or JWT tokens are also possible.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">AuthGuard</span> <span class="kr">implements</span> <span class="nx">CanActivate</span> <span class="p">{</span>
    <span class="kd">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">readonly</span> <span class="nx">configService</span><span class="p">:</span> <span class="nx">ConfigService</span><span class="p">)</span> <span class="p">{}</span>

    <span class="k">async</span> <span class="nx">canActivate</span><span class="p">(</span><span class="nx">context</span><span class="p">:</span> <span class="nx">ExecutionContext</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">boolean</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">switchToHttp</span><span class="p">().</span><span class="nx">getRequest</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1"> </span><span class="dl">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">Bearer</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">HttpException</span><span class="p">(</span><span class="dl">'</span><span class="s1">Invalid token</span><span class="dl">'</span><span class="p">,</span> <span class="nx">HttpStatus</span><span class="p">.</span><span class="nx">FORBIDDEN</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1"> </span><span class="dl">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>

        <span class="k">return</span> <span class="nx">token</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">configService</span><span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">string</span><span class="o">&gt;</span><span class="p">(</span><span class="dl">'</span><span class="s1">BEARER_TOKEN</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="azure-function-and-cosmosdb">Azure Function and CosmosDB</h2>

<p>To convert this app into an Azure Function and make it serverless, we only need a single command:</p>

<p><code class="language-plaintext highlighter-rouge">nest add @nestjs/azure-func-http</code></p>

<p>This will add some files and folders, including a <code class="language-plaintext highlighter-rouge">main.azure.ts</code> through which your app can be started.
It will set a global prefix ‘api’ to all your controllers, the standard for Azure Functions.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nx">createApp</span><span class="p">():</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">INestApplication</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">NestFactory</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">AppModule</span><span class="p">,</span> <span class="k">new</span> <span class="nx">AzureHttpRouter</span><span class="p">());</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">setGlobalPrefix</span><span class="p">(</span><span class="dl">'</span><span class="s1">api</span><span class="dl">'</span><span class="p">);</span>

  <span class="k">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span>
  <span class="k">return</span> <span class="nx">app</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now, you can choose to either run your app as a normal Web App or a serverless Azure Function.
The only thing left to do is <a href="https://portal.azure.com/#create/Microsoft.FunctionApp" target="_blank" rel="noopener noreferrer">create an Azure Function</a> in the Portal and set up a pipeline, which is also an automatic process (on Azure DevOps).
This will generate an <code class="language-plaintext highlighter-rouge">azure-pipelines.yml</code> file containing all necessary information and connect it with the function automatically.
On every push to the master branch (pull request), it will automatically start a build and deploy process.
For the environment variables, they need to be set up within the ‘configuration’ tab of your function, and then, you’re all set.’</p>

<p><img alt="Azure Function Creation" src="/img/2020-11-12-Typescript-in-the-backend-with-NestJS-and-Azure-Functions/Azure-pipeline.png" width="auto" height="auto" target="_blank" class="image fit" /></p>

<p>Congratulations! 
You converted your app to a serverless Function!
Quite an easy conversion, wasn’t it?</p>

<p>The database connection is just as easy.
Again, in the portal, you can <a href="https://portal.azure.com/#create/Microsoft.DocumentDB" target="_blank" rel="noopener noreferrer">create a CosmosDB Account</a>.
In that account, go to ‘Data Explorer’ and create a new database and add the necessary variables to the configuration of the Function.</p>

<p>In the end, your <code class="language-plaintext highlighter-rouge">app.module.ts</code> should look like this.
Notice that we can’t use the <code class="language-plaintext highlighter-rouge">ConfigService</code> in this <code class="language-plaintext highlighter-rouge">@Module()</code>, as it needs to be initialised before usage.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">Module</span><span class="p">({</span>
  <span class="na">imports</span><span class="p">:</span> <span class="p">[</span>
      <span class="nx">ConfigModule</span><span class="p">.</span><span class="nx">forRoot</span><span class="p">(),</span>
      <span class="nx">ParametersModule</span><span class="p">,</span>
      <span class="nx">LoggerModule</span><span class="p">,</span>
      <span class="nx">AzureCosmosDbModule</span><span class="p">.</span><span class="nx">forRoot</span><span class="p">({</span>
          <span class="na">dbName</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DATABASE_NAME</span><span class="p">,</span>
          <span class="na">endpoint</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DATABASE_ENDPOINT</span><span class="p">,</span>
          <span class="na">key</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DATABASE_KEY</span><span class="p">,</span>
      <span class="p">})</span>
  <span class="p">],</span>
  <span class="na">controllers</span><span class="p">:</span> <span class="p">[</span>
      <span class="nx">AppController</span>
  <span class="p">],</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span>
      <span class="nx">AppService</span><span class="p">,</span>
  <span class="p">],</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">AppModule</span> <span class="p">{}</span>
</code></pre></div></div>

<p>That’s it!
Your app is now fully functional!</p>

<h2 id="conclusion">Conclusion</h2>

<p>In this blog post, we made a small application to discover how NestJS can be used in the backend with some of its neat features.
Of course, this was a very basic program to show some of the possibilities.
For more information on NestJS and its features, check out the very thorough <a href="https://docs.nestjs.com/" target="_blank" rel="noopener noreferrer">documentation</a>.</p>

<h2 id="resources">Resources</h2>

<ul>
  <li><a href="https://github.com/jasperrosiers/body-parameter-tracker" target="_blank" rel="noopener noreferrer">The body parameter tracker project</a></li>
  <li><a href="https://docs.nestjs.com/" target="_blank" rel="noopener noreferrer">NestJS docs</a></li>
  <li><a href="https://blog.theodo.com/2019/06/deploy-a-nestjs-app-in-5-minutes-with-serverless-framework/" target="_blank" rel="noopener noreferrer">AWS Lambda integration</a></li>
  <li><a href="https://jacob-do.medium.com/token-validation-with-aws-cognito-and-nestjs-6f9e4088393c" target="_blank" rel="noopener noreferrer">AWS Cognito integration</a></li>
</ul>

        </div>
    </div>
    <div class="share-page" >
        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://ordina-jworks.github.io/backend/2020/11/12/Typescript-in-a-serverless-backend-with-NestJS-and-Azure-Functions.html&title=TypeScript in a serverless backend with NestJS and Azure Functions&source=https://ordina-jworks.github.io" rel="nofollow" target="_blank" title="Share on LinkedIN">
            <img src="/img/social-media/LinkedIn.png"
                 alt="Share on LinkedIn" />
        </a>
        <a href="https://twitter.com/intent/tweet?text=TypeScript in a serverless backend with NestJS and Azure Functions&url=https://ordina-jworks.github.io/backend/2020/11/12/Typescript-in-a-serverless-backend-with-NestJS-and-Azure-Functions.html&via=lifeatordinabe&related=lifeatordinabe" rel="nofollow" target="_blank" title="Share on Twitter">
            <img src="/img/social-media/Twitter.png"
                 alt="Share on Twitter" />
        </a>
        <a href="https://facebook.com/sharer.php?u=https://ordina-jworks.github.io/backend/2020/11/12/Typescript-in-a-serverless-backend-with-NestJS-and-Azure-Functions.html" rel="nofollow" target="_blank" title="Share on Facebook">
            <img src="/img/social-media/Facebook.png"
                 alt="Share on Facebook" />
        </a>
    </div>
        
</section>


<section id="two" class="wrapper alt spotlight style2">
    
    <div class="inner">
        <a href="/author/jasper-rosiers/" class="image spotlight-image" title="">
            <img src="/img/author/jasper-rosiers.png"
                 alt="" class="p-image"/>
        </a>

        <div class="content">
            
            <p><p>Jasper is a Java Developer with a love for IoT and innovative tech. He has a lot of experience in building chatbots using various platforms and coupling them to different chat clients. He also has a passion for the Agile way of working, Scrum and communication, both inside and outside the team.</p>
</p>
            
        </div>
    </div>
    
</section>

        </div>
    </section>
</div>



<footer>
    <div class="contact">
        <div class="address">
            <div class="icon"><i class="fa fa-fw fa-home"></i></div>
            <div class="text">Ordina Belgium<br/>Blarenberglaan 3B,<br/>2800 Mechelen, Belgium</div>
        </div>
        <div class="phone">
            <div class="icon"><i class="fa fa-fw fa-phone"></i></div>
            <div class="text"><a href="tel:003215295858">+32 15 29 58 58</a></div>
        </div>
        <div class="email">
            <div class="icon"><i class="fa fa-fw fa-envelope-o"></i></div>
            <div class="text"><a href="mailto:jworks@ordina.be">jworks@ordina.be</a></div>
        </div>
    </div>
    <ul class="social">
        <li>
            <a href="https://twitter.com/lifeatordinabe" target="_blank">
                <i class="fa fa-fw fa-twitter"></i><span>Twitter</span>
            </a>
        </li>
        <li>
            <a href="https://www.facebook.com/lifeatordinabe" target="_blank">
                <i class=" fa fa-fw fa-facebook"></i><span>Facebook</span>
            </a>
        </li>
        <li>
            <a href="https://www.linkedin.com/company/ordinabelgium" target="_blank">
                <i class=" fa fa-fw fa-linkedin"></i><span>LinkedIn</span>
            </a>
        </li>
        <li>
            <a href="/youtube" target="_blank">
                <i class=" fa fa-fw fa-youtube"></i><span>YouTube</span>
            </a>
        </li>
        <li>
            <a href="/github" target="_blank">
                <i class=" fa fa-fw fa-github"></i><span>GitHub</span>
            </a>
        </li>
        <li>
            <a href="/feed.xml" target="_blank">
                <i class=" fa fa-fw fa-rss"></i><span>RSS Feed</span>
            </a>
        </li>
    </ul>
    <div class="copyright">
        &copy; 2022 Ordina JWorks. All rights reserved.
        <br /> Disclaimer: Opinions expressed on this blog reflect the writer's views and not the position of Ordina
        <img id="analyticsImg" src="" width="1" height="1" style="border: 0px"/>
    </div>
</footer>
<!-- Scripts -->
<script src="/js/jquery.min.js"></script>
<script src="/js/jquery.scrollex.min.js"></script>
<script src="/js/jquery.magnific-popup.min.js"></script>
<script src="/js/owl.carousel.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/skel.min.js"></script>
<script src="/js/jquery.pin.min.js"></script>
<script src="/js/util.js"></script>
<!--[if lte IE 8]>
<script src="/js/ie/respond.min.js"></script><![endif]-->


<script>
    var imageHref = "/img/2020-11-12-Typescript-in-the-backend-with-NestJS-and-Azure-Functions/banner.png";
    $(function () {
        $('body').addClass('toggle');
    });
</script>


<script src="/js/main.js"></script>

<!-- Google Analytics -->
<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o);
        m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m);
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'UA-70040502-1', 'auto');
    ga('send', 'pageview');
</script>
<script type="text/javascript">
    window.addEventListener('load', function () {
        if (window.ga && ga.create) {
            console.log('GA loaded correctly');
        } else {
            console.log('GA is blocked or failed to load - tracking manually...')
            document.getElementById('analyticsImg').src = 'https://jworks-techblog-analytics.cfapps.io/collect?title=' + document.title;
        }
    }, false);
</script>

<!-- Vertical timeline -->
<script src="/js/vertical-timeline/modernizr.js"></script>
<script src="/js/vertical-timeline/main.js"></script>


</body>
</html>
