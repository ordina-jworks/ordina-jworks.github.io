<!DOCTYPE html>
<!--suppress ALL -->
<html>
<head>
        <meta charset="utf-8">
    <meta name="description" content="We build innovative solutions with Java and JavaScript. To support this mission, we have several Competence Centers. From within those Competence Centers, we provide coaching to the employee and expert advice towards our customer. In order to keep in sync with the latest technologies and the latest trends, we frequently visit conferences around the globe.
">
    <meta name="keywords" content="Ordina,ORAJ,JWorks,Blog,Java,JavaScript,TypeScript,Angular,DevOps">
    <meta name="author" content="Ordina Belgium">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/img/favicons/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/img/favicons/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/img/favicons/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/favicons/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="/img/favicons/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/img/favicons/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/img/favicons/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/img/favicons/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-128.png" sizes="128x128" />

    

    <!-- Twitter Card data -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Switching from RestTemplate to WebClient: A Reactive Tale - Lowie Cuypers">
    <meta name="twitter:description" content="Ordina JWorks Tech Blog">
    <meta name="twitter:image" content="http://ordina-jworks.github.io/img/2020-09-11-resttemplate-vs-webclient/banner.jpg"/>

    <!-- Facebook Open Graph -->
    <meta property="og:url" content="http://ordina-jworks.github.io/rest/2020/10/12/RestTemplate-vs-WebClient.html"/>
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Switching from RestTemplate to WebClient: A Reactive Tale - Lowie Cuypers"/>
    <meta property="og:description" content="Ordina JWorks Tech Blog"/>
    <meta property="og:image" content="http://ordina-jworks.github.io/img/2020-09-11-resttemplate-vs-webclient/banner.jpg"/>

    
    <title>Switching from RestTemplate to WebClient: A Reactive Tale - Lowie Cuypers &mdash; Ordina JWorks Tech Blog</title>
    

        <!-- Styles -->
    <!-- Font awesome CSS -->
    <link href="/css/font-awesome.min.css" rel="stylesheet">
    <!-- Magnific Popup -->
    <link href="/css/magnific-popup.css" rel="stylesheet">
    <!-- Owl carousel -->
    <link href="/css/owl.carousel.css" rel="stylesheet">

    <!-- CSS for this page -->

    <!-- Syntax highlighting -->
    <link href="/css/syntax.css" rel="stylesheet">


    <!--[if lte IE 8]>
    <script src="/js/ie/html5shiv.js"></script><![endif]-->
    <link rel="stylesheet" href="/css/main.css"/>
    <!--[if lte IE 9]>
    <link rel="stylesheet" href="/css/ie9.css"/><![endif]-->
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="/css/ie8.css"/><![endif]-->

    <!-- Custom CSS. Type your CSS code in custom.css file -->
    <link href="/css/custom.css" rel="stylesheet">

    <!-- Vertical timeline -->
	<link rel="stylesheet" href="/css/vertical-timeline/style.css"> <!-- Resource style -->

    <!-- Favicon -->
    <link rel="shortcut icon" href="#">

    <script src="https://use.typekit.net/gzh0mbm.js"></script>
    <script>
        try {
            Typekit.load({async: true});
        } catch (e) {
        }
    </script>
</head>

<body>
<div id="header-image"></div>


<!-- Page Wrapper -->
<div id="page-wrapper">

        <!-- Header -->
    <header id="header">
        <h1>
            <a href="/">
                JWorks Tech Blog
            </a>
        </h1>

        <nav>
            <a href="#menu">Menu</a>
            <form action="/search/" method="get" class="header-search search-form">
                <input type="text" id="search-box-header" name="query" placeholder="Search &hellip;">
            </form>
        </nav>
    </header>

    <!-- Menu -->
    <nav id="menu">
        <div class="inner">
            <h2>Menu</h2>
            <ul class="links">
                <li class="menu-item"><a href="/">Home</a></li>
                <li class="menu-item"><a href="/about">About Us</a></li>
                <li class="menu-item"><a href="/meet-the-team">Meet the team</a></li>
                <li class="menu-item"><a href="/jobs">Jobs</a></li>
                <li class="menu-item"><a href="/search">Search</a></li>
                <li class="menu-item"><a href="/contact">Contact Us</a></li>
            </ul>
            <a href="#" class="close">Close</a>
        </div>
    </nav>

    <section id="banner">
        <header>
            <div class="inner">
                

                <h2>Switching from RestTemplate to WebClient: A Reactive Tale</h2>
                

                
                    Posted Oct 12, 2020


    in <a href="/categories/rest/">Rest</a>



    by
    
        <a href="/author/lowie_cuypers">Lowie Cuypers</a>
        
    



    <br/>
    <i class="fa fa-tags"></i>
    
        <a href="/tags/spring/">Spring</a>, 
    
        <a href="/tags/resttemplate/">RestTemplate</a>, 
    
        <a href="/tags/webclient/">WebClient</a>, 
    
        <a href="/tags/reactive/">Reactive</a>
    

                

                

            </div>
        </header>
    </section>


    <section id="wrapper">
        <div class="inner">
            <section id="one" class="wrapper spotlight style1 post-body">
    <div class="inner" style="text-align: left;">
        <div class="content">
            <h2 id="table-of-contents">Table of Contents</h2>

<ul>
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#comparison-of-resttemplate-and-webclient">Comparison of RestTemplate and WebClient</a>
    <ul>
      <li><a href="#resttemplate">RestTemplate</a></li>
      <li><a href="#webclient">WebClient</a></li>
      <li><a href="#comparison-conclusion">Comparison Conclusion</a>
        <ul>
          <li><a href="#resttemplate-summary">RestTemplate Summary</a></li>
          <li><a href="#webclient-summary">WebClient Summary</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#reactive-approach-with-webclient">Reactive Approach with WebClient</a>
    <ul>
      <li><a href="#introduction-to-reactive-streams">Introduction to Reactive Streams</a></li>
      <li><a href="#legacy-services-in-your-reactive-environment">Legacy Services in your Reactive Environment</a></li>
      <li><a href="#reactive-database-connections">Reactive Database Connections</a></li>
      <li><a href="#r2dbc-2-steps-forward-1-step-back">R2DBC: 2 steps forward 1 step back</a></li>
    </ul>
  </li>
  <li><a href="#end-to-end-reactive-example">End-to-end Reactive example</a>
    <ul>
      <li><a href="#recipe-service-reactive-r2dbc">Recipe Service (Reactive R2DBC)</a></li>
      <li><a href="#ingredient-service-reactive-r2dbc">Ingredient Service (Reactive R2DBC)</a></li>
      <li><a href="#bestmenuevergenerator-service-reactive-rest">BestMenuEverGenerator Service (Reactive Rest)</a></li>
      <li><a href="#angular-webapp-consumer">Angular Webapp Consumer</a></li>
    </ul>
  </li>
  <li><a href="#conclusion">Conclusion</a></li>
</ul>

<h2 id="introduction">Introduction</h2>

<p>Since the REST era, most developers have become used to working with Spring’s traditional <code class="language-plaintext highlighter-rouge">RestTemplate</code> from the package <code class="language-plaintext highlighter-rouge">spring-boot-starter-web</code> for consuming Rest services. 
Spring also has a <code class="language-plaintext highlighter-rouge">WebClient</code> in its reactive package called <code class="language-plaintext highlighter-rouge">spring-boot-starter-webflux</code>. This post will help you decide whether you should make the switch from <code class="language-plaintext highlighter-rouge">RestTemplate</code> to <code class="language-plaintext highlighter-rouge">WebClient</code>. 
Since <code class="language-plaintext highlighter-rouge">WebClient</code> is supposed to be the successor of <code class="language-plaintext highlighter-rouge">RestTemplate</code>, we will be looking into it a bit deeper.</p>

<h2 id="comparison-of-resttemplate-and-webclient">Comparison of RestTemplate and <code class="language-plaintext highlighter-rouge">WebClient</code></h2>

<p>First off, let us assume we have a Recipe Rest service which we will consume in the following examples.</p>

<h3 id="resttemplate">RestTemplate</h3>

<p><code class="language-plaintext highlighter-rouge">RestTemplate</code> provides a synchronous way of consuming Rest services, which means it will block the thread until it receives a response. 
<code class="language-plaintext highlighter-rouge">RestTemplate</code> is deprecated since Spring 5 which means it’s not really that future proof.</p>

<p>First, we create a Spring Boot project with the <code class="language-plaintext highlighter-rouge">spring-boot-starter-web</code> dependency.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>We can now inject the default <code class="language-plaintext highlighter-rouge">RestTemplateBuilder</code> bean (provided by Spring) in our service and build our <code class="language-plaintext highlighter-rouge">RestTemplate</code> with a base URL, 
or we could create a configured <code class="language-plaintext highlighter-rouge">RestTemplate</code> bean in a <code class="language-plaintext highlighter-rouge">@Configuration</code> file. 
With this builder we can also configure things like: maximum data size, message converters for SOAP, etc.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RecipeRestTemplate</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">RestTemplate</span> <span class="n">restTemplate</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">public</span> <span class="nf">RecipeRestTemplate</span><span class="o">(</span><span class="nc">RestTemplateBuilder</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">restTemplate</span> <span class="o">=</span> <span class="n">builder</span>
                <span class="o">.</span><span class="na">rootUri</span><span class="o">(</span><span class="s">"http://localhost:8080"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Now, let’s move on to some example basic methods we can use on the <code class="language-plaintext highlighter-rouge">RestTemplate</code> class to communicate with our Recipe Rest service. 
We apply CRUD operations, specify our return object’s class, some parameters, body, header, etc.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Recipe</span><span class="o">&gt;</span> <span class="nf">getRecipes</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">restTemplate</span><span class="o">.</span><span class="na">exchange</span><span class="o">(</span><span class="s">"/recipe"</span><span class="o">,</span> <span class="nc">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ParameterizedTypeReference</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Recipe</span><span class="o">&gt;&gt;()</span> <span class="o">{})</span>
            <span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nc">Recipe</span> <span class="nf">getRecipeById</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">restTemplate</span><span class="o">.</span><span class="na">getForObject</span><span class="o">(</span><span class="s">"/recipe"</span><span class="o">,</span> <span class="nc">Recipe</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nc">Recipe</span> <span class="nf">createRecipe</span><span class="o">(</span><span class="nc">Recipe</span> <span class="n">recipe</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">restTemplate</span><span class="o">.</span><span class="na">postForObject</span><span class="o">(</span><span class="s">"/recipe"</span><span class="o">,</span> <span class="n">recipe</span><span class="o">,</span> <span class="nc">Recipe</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteRecipe</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">restTemplate</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="s">"/recipe"</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nc">Recipe</span> <span class="nf">getRecipeByTitle</span><span class="o">(</span><span class="nc">String</span> <span class="n">title</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">requestParameters</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
    <span class="n">requestParameters</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"title"</span><span class="o">,</span> <span class="n">title</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">restTemplate</span><span class="o">.</span><span class="na">getForObject</span><span class="o">(</span><span class="s">"/recipe"</span><span class="o">,</span> <span class="nc">Recipe</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">requestParameters</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="webclient">WebClient</h3>

<p><code class="language-plaintext highlighter-rouge">WebClient</code> exists since Spring 5 and provides an asynchronous way of consuming Rest services, which means it operates in a non-blocking way. 
<code class="language-plaintext highlighter-rouge">WebClient</code> is in the reactive WebFlux library and thus it uses the reactive streams approach. 
However, to really benefit from this, the entire throughput should be reactive end-to-end. 
Let me first show you an example before diving into more details.</p>

<p>So, we create a Spring Boot project with the <code class="language-plaintext highlighter-rouge">spring-boot-starter-webflux</code> dependency.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-webflux<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>We can inject a builder similarly, configure it if necessary and build our <code class="language-plaintext highlighter-rouge">WebClient</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RecipeWebService</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">WebClient</span> <span class="n">webClient</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">public</span> <span class="nf">RecipeWebService</span><span class="o">(</span><span class="nc">WebClient</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">webClient</span> <span class="o">=</span> <span class="n">builder</span>
                <span class="o">.</span><span class="na">baseUrl</span><span class="o">(</span><span class="s">"http://localhost:8080"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Here is an example similar to our <code class="language-plaintext highlighter-rouge">RestTemplate</code> example. 
Note that this wraps our objects in <code class="language-plaintext highlighter-rouge">Mono</code> (a stream of 0 or 1 object) and <code class="language-plaintext highlighter-rouge">Flux</code> (a stream of 0 or multiple objects) wrappers. 
These are reactive types, and we should keep them in these wrappers if we want to keep the reactive stream open and non-blocking. 
Let’s assume for this example that our Recipe Rest service which we are consuming is reactive.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Recipe</span><span class="o">&gt;</span> <span class="nf">getRecipes</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">webClient</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">uri</span><span class="o">(</span><span class="s">"/recipe"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">retrieve</span><span class="o">()</span>
            <span class="o">.</span><span class="na">bodyToFlux</span><span class="o">(</span><span class="nc">Recipe</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">Recipe</span><span class="o">&gt;</span> <span class="nf">getRecipeById</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">webClient</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">uri</span><span class="o">(</span><span class="s">"/recipe/{id}"</span><span class="o">,</span> <span class="n">id</span><span class="o">)</span>
            <span class="o">.</span><span class="na">retrieve</span><span class="o">()</span>
            <span class="o">.</span><span class="na">bodyToMono</span><span class="o">(</span><span class="nc">Recipe</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">Recipe</span><span class="o">&gt;</span> <span class="nf">createRecipe</span><span class="o">(</span><span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">Recipe</span><span class="o">&gt;</span> <span class="n">recipe</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">webClient</span><span class="o">.</span><span class="na">post</span><span class="o">().</span><span class="na">uri</span><span class="o">(</span><span class="s">"/recipe"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">recipe</span><span class="o">,</span> <span class="nc">Recipe</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">retrieve</span><span class="o">()</span>
            <span class="o">.</span><span class="na">bodyToMono</span><span class="o">(</span><span class="nc">Recipe</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="nf">deleteRecipe</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">webClient</span><span class="o">.</span><span class="na">delete</span><span class="o">().</span><span class="na">uri</span><span class="o">(</span><span class="s">"/recipe/{id}"</span><span class="o">,</span> <span class="n">id</span><span class="o">)</span>
            <span class="o">.</span><span class="na">retrieve</span><span class="o">()</span>
            <span class="o">.</span><span class="na">bodyToMono</span><span class="o">(</span><span class="nc">Void</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">Recipe</span><span class="o">&gt;</span> <span class="nf">getRecipeByTitle</span><span class="o">(</span><span class="nc">String</span> <span class="n">title</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">requestParameters</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
    <span class="n">requestParameters</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"title"</span><span class="o">,</span> <span class="n">title</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">webClient</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">uri</span><span class="o">(</span><span class="s">"/recipe"</span><span class="o">,</span> <span class="n">requestParameters</span><span class="o">)</span>
            <span class="o">.</span><span class="na">retrieve</span><span class="o">()</span>
            <span class="o">.</span><span class="na">bodyToMono</span><span class="o">(</span><span class="nc">Recipe</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Another benefit of working with <code class="language-plaintext highlighter-rouge">Flux</code> and <code class="language-plaintext highlighter-rouge">Mono</code> is that you can do mappings, filtering, transformations on your data as it is passing through the stream.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getRecipes</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Recipe</span><span class="o">&gt;</span> <span class="n">recipeStream</span> <span class="o">=</span> <span class="n">webClient</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">uri</span><span class="o">(</span><span class="s">"/recipe"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">retrieve</span><span class="o">()</span>
            <span class="o">.</span><span class="na">bodyToFlux</span><span class="o">(</span><span class="nc">Recipe</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">recipeTitleStream</span> <span class="o">=</span> <span class="n">recipeStream</span>
            <span class="o">.</span><span class="na">log</span><span class="o">()</span>
            <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">recipe</span> <span class="o">-&gt;</span> <span class="o">!</span><span class="n">recipe</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">isBlank</span><span class="o">())</span>
            <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="n">recipe</span> <span class="o">-&gt;</span> <span class="nc">Mono</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="n">recipe</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">toUpperCase</span><span class="o">()));</span>

    <span class="k">return</span> <span class="n">recipeTitleStream</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Let’s say our services, databases, etc <strong>are not reactive</strong>, but we want to use <code class="language-plaintext highlighter-rouge">WebClient</code> anyway. 
Then <code class="language-plaintext highlighter-rouge">Flux</code> and <code class="language-plaintext highlighter-rouge">Mono</code> are not much use to us, so we will have to unwrap them. 
Since our Recipe Rest service doesn’t provide reactive streams, we receive a <code class="language-plaintext highlighter-rouge">List</code> of recipes in one response, which <code class="language-plaintext highlighter-rouge">WebClient</code> wraps in <code class="language-plaintext highlighter-rouge">Mono</code>. 
We can use <code class="language-plaintext highlighter-rouge">block()</code> to block the stream and get the data out of it. Note that this shouldn’t be used in a reactive environment.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Recipe</span><span class="o">&gt;</span> <span class="nf">getRecipes</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Recipe</span><span class="o">&gt;&gt;</span> <span class="n">recipeListStream</span> <span class="o">=</span> <span class="n">webClient</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">uri</span><span class="o">(</span><span class="s">"/recipe"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">retrieve</span><span class="o">()</span>
            <span class="o">.</span><span class="na">bodyToMono</span><span class="o">(</span><span class="k">new</span> <span class="nc">ParameterizedTypeReference</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Recipe</span><span class="o">&gt;&gt;()</span> <span class="o">{});</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Recipe</span><span class="o">&gt;</span> <span class="n">recipeList</span> <span class="o">=</span> <span class="n">recipeListStream</span><span class="o">.</span><span class="na">block</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">recipeList</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Now let’s say, the Recipe service <strong>IS reactive</strong> and returns a stream of Recipe objects (<code class="language-plaintext highlighter-rouge">Flux</code>) instead of a <code class="language-plaintext highlighter-rouge">List</code>, but we still want to block the reactive stream. 
Because we can only call <code class="language-plaintext highlighter-rouge">blockFirst()</code> or <code class="language-plaintext highlighter-rouge">blockLast()</code> on <code class="language-plaintext highlighter-rouge">Flux</code>, we should collect the data from the <code class="language-plaintext highlighter-rouge">Flux</code> stream into <code class="language-plaintext highlighter-rouge">List</code>. 
Now this <code class="language-plaintext highlighter-rouge">List</code> is wrapped inside a <code class="language-plaintext highlighter-rouge">Mono</code> stream. We can then block the stream to unwrap the data.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Recipe</span><span class="o">&gt;</span> <span class="nf">getRecipes</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Recipe</span><span class="o">&gt;</span> <span class="n">recipeStream</span> <span class="o">=</span> <span class="n">webClient</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">uri</span><span class="o">(</span><span class="s">"/recipe"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">retrieve</span><span class="o">()</span>
            <span class="o">.</span><span class="na">bodyToFlux</span><span class="o">(</span><span class="nc">Recipe</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">Mono</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Recipe</span><span class="o">&gt;&gt;</span> <span class="n">collectedRecipesStream</span> <span class="o">=</span> <span class="n">recipeStream</span><span class="o">.</span><span class="na">collectList</span><span class="o">();</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Recipe</span><span class="o">&gt;</span> <span class="n">recipeList</span> <span class="o">=</span> <span class="n">collectedRecipesStream</span><span class="o">.</span><span class="na">block</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">recipeList</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="comparison-conclusion">Comparison Conclusion</h3>

<p>We have learned that <code class="language-plaintext highlighter-rouge">RestTemplate</code> is in maintenance mode and probably will not be supported in future versions. 
Even on the official Spring documentation, they advise to use <code class="language-plaintext highlighter-rouge">WebClient</code> instead. <code class="language-plaintext highlighter-rouge">WebClient</code> can basically do what <code class="language-plaintext highlighter-rouge">RestTemplate</code> does, making synchronous blocking calls. 
But it also has asynchronous capabilities, which makes it interesting. It has a functional way of programming, which makes it easy to read as well. 
If you are working in legacy Spring (&lt; 5.0) applications, you will have to upgrade to Spring 5.0 to be able to use <code class="language-plaintext highlighter-rouge">WebClient</code>.</p>

<p>Let’s list both clients’ properties to have a better overview.</p>

<h5 id="resttemplate-summary">RestTemplate Summary</h5>
<ul>
  <li>In maintenance mode since Spring 5.0</li>
  <li>Synchronous (blocking)</li>
  <li>In spring-boot-starter-web library</li>
  <li>Built on Servlet stack</li>
</ul>

<h5 id="webclient-summary">WebClient Summary</h5>
<ul>
  <li>Synchronous &amp; asynchronous (non-blocking) capabilities</li>
  <li>Reactive streaming</li>
  <li>Mono and Flux: both implement CorePublisher which extends Publisher</li>
  <li>From Spring 5.0</li>
  <li>Functional programming</li>
  <li>In spring-boot-starter-webflux library</li>
  <li>Built on Reactive stack</li>
</ul>

<p>Next, we will look more into the <code class="language-plaintext highlighter-rouge">WebClient</code>’s reactive streaming capabilities.</p>

<h2 id="reactive-approach-with-webclient">Reactive Approach with WebClient</h2>

<h3 id="introduction-to-reactive-streams">Introduction to Reactive Streams</h3>

<p>Reactive streaming works a bit different under the hood than traditional request-response communication. 
Data only passes through these streams when we block or subscribe them. Calling one of these methods we saw earlier, only creates a connection to the stream. 
Data only starts passing through the entire stream when there is a ‘subscription’ or ‘block’.<br />
<strong>Note that you should never block a reactive stream if you want your services to be reactive end-to-end.</strong></p>

<p>In the next sections, we will see how we can consume it.</p>

<h3 id="legacy-services-in-your-reactive-environment">Legacy Services in your Reactive Environment</h3>

<p>To use <code class="language-plaintext highlighter-rouge">WebClient</code> to its full potential, you should create end-to-end reactive streams. 
This might be a problem when working with legacy services. 
If you are creating fully new services, back-to-front, and only a small portion of the services you consume are legacy. 
Then you can still create your new services reactive and wrap the responses of your legacy services in <code class="language-plaintext highlighter-rouge">Flux</code> and <code class="language-plaintext highlighter-rouge">Mono</code> wrappers as close to the source as possible.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Recipe</span><span class="o">&gt;</span> <span class="nf">getRecipes</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Recipe</span><span class="o">&gt;</span> <span class="n">recipeList</span> <span class="o">=</span> <span class="n">webClient</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">uri</span><span class="o">(</span><span class="s">"/recipe"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">retrieve</span><span class="o">()</span>
            <span class="o">.</span><span class="na">bodyToMono</span><span class="o">(</span><span class="k">new</span> <span class="nc">ParameterizedTypeReference</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Recipe</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
            <span class="o">})</span>
            <span class="o">.</span><span class="na">block</span><span class="o">();</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Recipe</span><span class="o">&gt;</span> <span class="n">recipeStream</span> <span class="o">=</span> <span class="nc">Flux</span><span class="o">.</span><span class="na">fromIterable</span><span class="o">(</span><span class="n">recipeList</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">recipeStream</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>This way, you can still partly have a reactive setup and maybe when these services will be upgraded or replaced in the future, they might become reactive as well, and you can easily implement the necessary changes on your side as well.</p>

<h3 id="reactive-database-connections">Reactive Database Connections</h3>

<p>There have been supporting libraries for reactive NoSQL connectivity for a while, which can retrieve data from the database in a reactive manner. 
Which means they start returning data as the database is querying, and not when the entire database has been queried. So you are good to go. 
But, with Relational databases (which you are probably using as well), there weren’t any in Spring until recently. 
Before, you could wrap your database response in <code class="language-plaintext highlighter-rouge">Flux</code> and <code class="language-plaintext highlighter-rouge">Mono</code> wrappers as soon as possible when calling your database, but if these databases are the major sources of your data and not just a small portion, it kind of ruins the appeal and benefit.</p>

<h3 id="r2dbc-2-steps-forward-1-step-back">R2DBC: 2 steps forward 1 step back</h3>

<p>Not until very recently (December 2019), <code class="language-plaintext highlighter-rouge">spring-data-r2dbc</code> dependency got released. It basically is JDBC’s reactive counterpart. 
R2DBC stands for <strong>Reactive Relational DataBase Connectivity</strong>. This does not offer a lot of features of ORM (Object-Relational Mapping) frameworks at the moment of writing. 
For now, it is not yet capable of mapping relations (eg: <code class="language-plaintext highlighter-rouge">@OneToMany</code>, <code class="language-plaintext highlighter-rouge">@ManyToOne</code>, …), lazy loading, etc. 
You would have to manage this yourself. However, with this connector, we can query data as streams.</p>

<h2 id="end-to-end-reactive-example">End-to-end Reactive example</h2>

<p>We’ve learned about <code class="language-plaintext highlighter-rouge">WebClient</code>, reactive streams and R2DBC. Let’s use these in an example to really see how it works. 
We are going to create a 2 microservices with a R2DBC connecting to MySQL databases and a Rest API. 
Then we’ll create another microservice which consumes both of these Rest API’s. 
Finally, an Angular frontend that consumes that microservice to display the data.</p>

<h3 id="recipe-service-reactive-r2dbc">Recipe Service (Reactive R2DBC)</h3>

<p>Let’s dive into our Recipe Rest service and see how we can create a reactive rest service. 
We add the following dependencies.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependencies&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-webflux<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-r2dbc<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>dev.miku<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>r2dbc-mysql<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
</code></pre></div></div>

<p>We configure the database connection and enable R2DBC. The <code class="language-plaintext highlighter-rouge">ConnectionFactory</code> comes from the package <code class="language-plaintext highlighter-rouge">io.r2dbc.spi</code>. 
Since we are connecting to a MySQL database, we enter <code class="language-plaintext highlighter-rouge">mysql</code> as the Driver. This will create the following connection url <code class="language-plaintext highlighter-rouge">r2dbc:mysql://root:password@127.0.0.1/recipe</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">io.r2dbc.spi.ConnectionFactories</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.r2dbc.spi.ConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.r2dbc.spi.ConnectionFactoryOptions</span><span class="o">;</span>
<span class="c1">// Other imports are omitted</span>

<span class="nd">@Configuration</span>
<span class="nd">@EnableR2dbcRepositories</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReactiveDatabaseConfig</span> <span class="kd">extends</span> <span class="nc">AbstractR2dbcConfiguration</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">ConnectionFactory</span> <span class="nf">connectionFactory</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">ConnectionFactories</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="nc">ConnectionFactoryOptions</span>
                <span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="no">DRIVER</span><span class="o">,</span> <span class="s">"mysql"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="no">HOST</span><span class="o">,</span> <span class="s">"127.0.0.1"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="no">USER</span><span class="o">,</span> <span class="s">"root"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="no">PASSWORD</span><span class="o">,</span> <span class="no">SUPER_SAFE_PASSWORD</span><span class="o">)</span>
                <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="no">DATABASE</span><span class="o">,</span> <span class="s">"recipe"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>For simplicity of the example, a Recipe contains only an <code class="language-plaintext highlighter-rouge">id</code>, <code class="language-plaintext highlighter-rouge">title</code> and <code class="language-plaintext highlighter-rouge">description</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Recipe</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">title</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">description</span><span class="o">;</span>
<span class="cm">/* Constructors, Getters and Setters not displayed for simplicity */</span>
<span class="o">}</span>
</code></pre></div></div>

<p>We create a Repository which extends a <code class="language-plaintext highlighter-rouge">ReactiveCrudRepository</code> with a query that retrieves all recipes in a random order.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RecipeRepository</span> <span class="kd">extends</span> <span class="nc">ReactiveCrudRepository</span><span class="o">&lt;</span><span class="nc">Recipe</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Query</span><span class="o">(</span><span class="s">"SELECT * FROM recipe ORDER BY RAND()"</span><span class="o">)</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Recipe</span><span class="o">&gt;</span> <span class="nf">findAllRandomized</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>We add a <code class="language-plaintext highlighter-rouge">RestController</code> with a method that provides a <code class="language-plaintext highlighter-rouge">text/event-stream</code> of all the recipes. 
I have added a <strong>delay of 1 second</strong> between each element to give you a better visualization later.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/recipe"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RecipeController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">RecipeRepository</span> <span class="n">recipeRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">public</span> <span class="nf">RecipeController</span><span class="o">(</span><span class="nc">RecipeRepository</span> <span class="n">recipeRepository</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">recipeRepository</span> <span class="o">=</span> <span class="n">recipeRepository</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">produces</span> <span class="o">=</span> <span class="nc">MediaType</span><span class="o">.</span><span class="na">TEXT_EVENT_STREAM_VALUE</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Recipe</span><span class="o">&gt;</span> <span class="nf">getAllRecipesRandomized</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">recipeRepository</span><span class="o">.</span><span class="na">findAllRandomized</span><span class="o">().</span><span class="na">delayElements</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>When we <code class="language-plaintext highlighter-rouge">cURL -N</code> our Recipe service, it displays a random recipe every second (because of the added delay).</p>

<p><img alt="curl recipe service" src="/img/2020-09-11-resttemplate-vs-webclient/curl-recipe-service.gif" class="image fit" style="margin:0px auto; max-width: 1000px;" /></p>

<h3 id="ingredient-service-reactive-r2dbc">Ingredient Service (Reactive R2DBC)</h3>

<p>We create another microservice Ingredient Service, which is similar to our Recipe Service, but queries an ingredient database that provides us a stream of Ingredients in a random order.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Ingredient</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
<span class="cm">/* Constructors, Getters and Setters not displayed for simplicity */</span>
<span class="o">}</span>
</code></pre></div></div>

<p>As you can see, the Ingredient controller works almost the same, but without a delay.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/ingredient"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IngredientController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">IngredientRepository</span> <span class="n">ingredientRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">public</span> <span class="nf">IngredientController</span><span class="o">(</span><span class="nc">IngredientRepository</span> <span class="n">ingredientRepository</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">ingredientRepository</span> <span class="o">=</span> <span class="n">ingredientRepository</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">produces</span> <span class="o">=</span> <span class="nc">MediaType</span><span class="o">.</span><span class="na">TEXT_EVENT_STREAM_VALUE</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Ingredient</span><span class="o">&gt;</span> <span class="nf">getAllIngredientsRandomized</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ingredientRepository</span><span class="o">.</span><span class="na">findAllRandomized</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="bestmenuevergenerator-service-reactive-rest">BestMenuEverGenerator Service (Reactive Rest)</h3>

<p>Our BestMenuEverGenerator service is going to put together our menu for a given amount of days. 
What makes our BestMenuEverGenerator the best, is because it adds a random special ingredient to every recipe.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Menu</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Recipe</span> <span class="n">recipe</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Ingredient</span> <span class="n">specialIngredient</span><span class="o">;</span>
<span class="cm">/* Constructors, Getters and Setters not displayed for simplicity */</span>
<span class="o">}</span>
</code></pre></div></div>

<p>We have a <code class="language-plaintext highlighter-rouge">RestController</code> that consumes both our services, Recipe and Ingredient. 
Even though it calls <strong>all</strong> Recipes, it is <strong>not</strong> going to retrieve and load all recipes in memory, as would be the case in a non-reactive environment. 
However, it limits the number of objects it receives, before completing the stream. 
The ´zipWith()´ method waits for one element of both streams and combines these elements in a <code class="language-plaintext highlighter-rouge">BiFunction</code> and returns its results in in new stream. 
It continues to zip until one of the streams completes. In this case, the results of the <code class="language-plaintext highlighter-rouge">BiFunction</code> are <code class="language-plaintext highlighter-rouge">Menu</code> objects. 
There are plenty of other interesting methods to use for combining or transforming streams.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/menu"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MenuReactiveController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">RecipeWebService</span> <span class="n">recipeWebService</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">IngredientWebService</span> <span class="n">ingredientWebService</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">public</span> <span class="nf">MenuReactiveController</span><span class="o">(</span><span class="nc">RecipeWebService</span> <span class="n">recipeWebService</span><span class="o">,</span> <span class="nc">IngredientWebService</span> <span class="n">ingredientWebService</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">recipeWebService</span> <span class="o">=</span> <span class="n">recipeWebService</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">ingredientWebService</span> <span class="o">=</span> <span class="n">ingredientWebService</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">produces</span> <span class="o">=</span> <span class="nc">MediaType</span><span class="o">.</span><span class="na">TEXT_EVENT_STREAM_VALUE</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Menu</span><span class="o">&gt;</span> <span class="nf">getMenusForGivenDays</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"amountOfDays"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">amountOfDays</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Ingredient</span><span class="o">&gt;</span> <span class="n">ingredients</span> <span class="o">=</span> <span class="n">ingredientWebService</span><span class="o">.</span><span class="na">getAllIngredientsRandomized</span><span class="o">();</span>
        <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">Recipe</span><span class="o">&gt;</span> <span class="n">recipes</span> <span class="o">=</span> <span class="n">recipeWebService</span><span class="o">.</span><span class="na">getAllRecipesRandomized</span><span class="o">().</span><span class="na">take</span><span class="o">(</span><span class="n">amountOfDays</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">recipes</span><span class="o">.</span><span class="na">zipWith</span><span class="o">(</span><span class="n">ingredients</span><span class="o">,</span> <span class="o">(</span><span class="n">recipe</span><span class="o">,</span> <span class="n">ingredient</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">Menu</span><span class="o">(</span><span class="n">recipe</span><span class="o">,</span> <span class="n">ingredient</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="angular-webapp-consumer">Angular Webapp Consumer</h3>

<p>I built a simple Angular web application, which consumes our BestMenuEverGenerator service.</p>

<p><img alt="recipe web application" src="/img/2020-09-11-resttemplate-vs-webclient/recipe-webapp.png" class="image fit" style="max-width: 400px;" /></p>

<p>Instead of using a <code class="language-plaintext highlighter-rouge">HttpClient</code>, I use an <code class="language-plaintext highlighter-rouge">EventSource</code> to call our service. 
 Every time an event is received, it is parsed and pushed onto the <code class="language-plaintext highlighter-rouge">Observable</code>.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">getMenusForGivenAmountOfDays</span><span class="p">(</span><span class="nx">amountOfDays</span><span class="p">:</span> <span class="kr">number</span><span class="p">):</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">Menu</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">Menu</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">menuSubscriber</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">eventSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventSource</span><span class="p">(</span><span class="dl">'</span><span class="s1">http://localhost:8081/menu?amountOfDays=</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">amountOfDays</span><span class="p">);</span>
      <span class="nx">eventSource</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="na">event</span><span class="p">:</span> <span class="kr">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">menuSubscriber</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span> <span class="o">!==</span> <span class="kc">null</span> <span class="p">?</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span> <span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="nx">eventSource</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">eventSource</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
        <span class="nx">menuSubscriber</span><span class="p">.</span><span class="nx">complete</span><span class="p">();</span>
      <span class="p">};</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We enter the amount of days we want to retrieve a menu for and when we push the button, the following method is triggered. 
 It subscribes the <code class="language-plaintext highlighter-rouge">Observable</code> we created in the previous example from the <code class="language-plaintext highlighter-rouge">EventSource</code>. 
 We push each element in an array which is displayed on our webpage.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">class</span> <span class="nx">RecipesComponent</span> <span class="k">implements</span> <span class="nx">OnInit</span> <span class="p">{</span>
  <span class="nl">menuArray</span><span class="p">:</span> <span class="nx">Menu</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="nl">amountOfDays</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">recipeService</span><span class="p">:</span> <span class="nx">RecipeService</span><span class="p">)</span> <span class="p">{}</span>

  <span class="nx">ngOnInit</span><span class="p">():</span> <span class="k">void</span> <span class="p">{}</span>

  <span class="nx">generateMenu</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">amountOfDays</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">menuArray</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">recipeService</span><span class="p">.</span><span class="nx">getMenusForGivenAmountOfDays</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">amountOfDays</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">subscribe</span><span class="p">({</span>
          <span class="na">next</span><span class="p">:</span> <span class="nx">menu</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">menuArray</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">menu</span><span class="p">),</span>
          <span class="na">complete</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">complete</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The delay of 1 second we added in the Recipe service earlier offers us a good visualization of the data passing through the stream. 
 We immediately receive each Recipe with its special Ingredient and see it in the webpage when it arrives, even if the rest of the data has not even been processed in the controller.</p>

<p><img alt="recipes streaming" src="/img/2020-09-11-resttemplate-vs-webclient/recipes-streaming.gif" class="image fit" style="margin:0px auto; max-width: 1000px;" /></p>

<h2 id="conclusion">Conclusion</h2>

<p>Hopefully, this gives you a basic understanding of <code class="language-plaintext highlighter-rouge">RestTemplate</code> and <code class="language-plaintext highlighter-rouge">WebClient</code> and its capabilities. 
To summarize, we have learned that <code class="language-plaintext highlighter-rouge">RestTemplate</code> is in maintenance mode and Spring advises us to use <code class="language-plaintext highlighter-rouge">WebClient</code> instead. 
<code class="language-plaintext highlighter-rouge">WebClient</code> offers the same synchronous way of working as <code class="language-plaintext highlighter-rouge">RestTemplate</code> does, but using functional programming. 
Besides that, it also offers asynchronous reactive streams, which works in a non-blocking way.</p>

<p>We have looked into R2DBC, which supports reactive connections with relational databases. 
Bear in mind that this does not offer a lot of features of ORM frameworks at the moment.</p>

        </div>
    </div>
    <div class="share-page" >
        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://ordina-jworks.github.io/rest/2020/10/12/RestTemplate-vs-WebClient.html&title=Switching from RestTemplate to WebClient: A Reactive Tale&source=https://ordina-jworks.github.io" rel="nofollow" target="_blank" title="Share on LinkedIN">
            <img src="/img/social-media/LinkedIn.png"
                 alt="Share on LinkedIn" />
        </a>
        <a href="https://twitter.com/intent/tweet?text=Switching from RestTemplate to WebClient: A Reactive Tale&url=https://ordina-jworks.github.io/rest/2020/10/12/RestTemplate-vs-WebClient.html&via=lifeatordinabe&related=lifeatordinabe" rel="nofollow" target="_blank" title="Share on Twitter">
            <img src="/img/social-media/Twitter.png"
                 alt="Share on Twitter" />
        </a>
        <a href="https://facebook.com/sharer.php?u=https://ordina-jworks.github.io/rest/2020/10/12/RestTemplate-vs-WebClient.html" rel="nofollow" target="_blank" title="Share on Facebook">
            <img src="/img/social-media/Facebook.png"
                 alt="Share on Facebook" />
        </a>
    </div>
        
</section>


<section id="two" class="wrapper alt spotlight style2">
    
    <div class="inner">
        <a href="/author/lowie_cuypers" class="image spotlight-image" title="">
            <img src="/img/author/lowie-cuypers.jpg"
                 alt="" class="p-image"/>
        </a>

        <div class="content">
            
            <p><p>Lowie is a Java back-end developer who also knows his way around Angular. He is a Spring Boot enthusiast and loves cloud-native development.</p>
</p>
            
        </div>
    </div>
    
</section>

        </div>
    </section>
</div>



<footer>
    <div class="contact">
        <div class="address">
            <div class="icon"><i class="fa fa-fw fa-home"></i></div>
            <div class="text">Ordina Belgium<br/>Blarenberglaan 3B,<br/>2800 Mechelen, Belgium</div>
        </div>
        <div class="phone">
            <div class="icon"><i class="fa fa-fw fa-phone"></i></div>
            <div class="text"><a href="tel:003215295858">+32 15 29 58 58</a></div>
        </div>
        <div class="email">
            <div class="icon"><i class="fa fa-fw fa-envelope-o"></i></div>
            <div class="text"><a href="mailto:jworks@ordina.be">jworks@ordina.be</a></div>
        </div>
    </div>
    <ul class="social">
        <li>
            <a href="https://twitter.com/lifeatordinabe" target="_blank">
                <i class="fa fa-fw fa-twitter"></i><span>Twitter</span>
            </a>
        </li>
        <li>
            <a href="https://www.facebook.com/lifeatordinabe" target="_blank">
                <i class=" fa fa-fw fa-facebook"></i><span>Facebook</span>
            </a>
        </li>
        <li>
            <a href="https://www.linkedin.com/company/ordinabelgium" target="_blank">
                <i class=" fa fa-fw fa-linkedin"></i><span>LinkedIn</span>
            </a>
        </li>
        <li>
            <a href="/youtube" target="_blank">
                <i class=" fa fa-fw fa-youtube"></i><span>YouTube</span>
            </a>
        </li>
        <li>
            <a href="/github" target="_blank">
                <i class=" fa fa-fw fa-github"></i><span>GitHub</span>
            </a>
        </li>
        <li>
            <a href="/feed.xml" target="_blank">
                <i class=" fa fa-fw fa-rss"></i><span>RSS Feed</span>
            </a>
        </li>
    </ul>
    <div class="copyright">
        &copy; 2022 Ordina JWorks. All rights reserved.
        <br /> Disclaimer: Opinions expressed on this blog reflect the writer's views and not the position of Ordina
        <img id="analyticsImg" src="" width="1" height="1" style="border: 0px"/>
    </div>
</footer>
<!-- Scripts -->
<script src="/js/jquery.min.js"></script>
<script src="/js/jquery.scrollex.min.js"></script>
<script src="/js/jquery.magnific-popup.min.js"></script>
<script src="/js/owl.carousel.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/skel.min.js"></script>
<script src="/js/jquery.pin.min.js"></script>
<script src="/js/util.js"></script>
<!--[if lte IE 8]>
<script src="/js/ie/respond.min.js"></script><![endif]-->


<script>
    var imageHref = "/img/2020-09-11-resttemplate-vs-webclient/banner.jpg";
    $(function () {
        $('body').addClass('toggle');
    });
</script>


<script src="/js/main.js"></script>

<!-- Google Analytics -->
<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o);
        m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m);
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'UA-70040502-1', 'auto');
    ga('send', 'pageview');
</script>
<script type="text/javascript">
    window.addEventListener('load', function () {
        if (window.ga && ga.create) {
            console.log('GA loaded correctly');
        } else {
            console.log('GA is blocked or failed to load - tracking manually...')
            document.getElementById('analyticsImg').src = 'https://jworks-techblog-analytics.cfapps.io/collect?title=' + document.title;
        }
    }, false);
</script>

<!-- Vertical timeline -->
<script src="/js/vertical-timeline/modernizr.js"></script>
<script src="/js/vertical-timeline/main.js"></script>


</body>
</html>
