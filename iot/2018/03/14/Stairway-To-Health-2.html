<!DOCTYPE html>
<!--suppress ALL -->
<html>
<head>
        <meta charset="utf-8">
    <meta name="description" content="We build innovative solutions with Java and JavaScript. To support this mission, we have several Competence Centers. From within those Competence Centers, we provide coaching to the employee and expert advice towards our customer. In order to keep in sync with the latest technologies and the latest trends, we frequently visit conferences around the globe.
">
    <meta name="keywords" content="Ordina,ORAJ,JWorks,Blog,Java,JavaScript,TypeScript,Angular,DevOps">
    <meta name="author" content="Ordina Belgium">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/img/favicons/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/img/favicons/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/img/favicons/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/favicons/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="/img/favicons/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/img/favicons/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/img/favicons/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/img/favicons/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-128.png" sizes="128x128" />

    

    <!-- Twitter Card data -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Stairway to Health 2.0 (the Ordina version) - Michael Vervloet and Axel Bergmans">
    <meta name="twitter:description" content="Ordina JWorks Tech Blog">
    <meta name="twitter:image" content="http://ordina-jworks.github.io/img/stairwaytohealth2/banner.jpg"/>

    <!-- Facebook Open Graph -->
    <meta property="og:url" content="http://ordina-jworks.github.io/iot/2018/03/14/Stairway-To-Health-2.html"/>
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Stairway to Health 2.0 (the Ordina version) - Michael Vervloet and Axel Bergmans"/>
    <meta property="og:description" content="Ordina JWorks Tech Blog"/>
    <meta property="og:image" content="http://ordina-jworks.github.io/img/stairwaytohealth2/banner.jpg"/>

    
    <title>Stairway to Health 2.0 (the Ordina version) - Michael Vervloet and Axel Bergmans &mdash; Ordina JWorks Tech Blog</title>
    

        <!-- Styles -->
    <!-- Font awesome CSS -->
    <link href="/css/font-awesome.min.css" rel="stylesheet">
    <!-- Magnific Popup -->
    <link href="/css/magnific-popup.css" rel="stylesheet">
    <!-- Owl carousel -->
    <link href="/css/owl.carousel.css" rel="stylesheet">

    <!-- CSS for this page -->

    <!-- Syntax highlighting -->
    <link href="/css/syntax.css" rel="stylesheet">


    <!--[if lte IE 8]>
    <script src="/js/ie/html5shiv.js"></script><![endif]-->
    <link rel="stylesheet" href="/css/main.css"/>
    <!--[if lte IE 9]>
    <link rel="stylesheet" href="/css/ie9.css"/><![endif]-->
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="/css/ie8.css"/><![endif]-->

    <!-- Custom CSS. Type your CSS code in custom.css file -->
    <link href="/css/custom.css" rel="stylesheet">

    <!-- Vertical timeline -->
	<link rel="stylesheet" href="/css/vertical-timeline/style.css"> <!-- Resource style -->

    <!-- Favicon -->
    <link rel="shortcut icon" href="#">

    <script src="https://use.typekit.net/gzh0mbm.js"></script>
    <script>
        try {
            Typekit.load({async: true});
        } catch (e) {
        }
    </script>
</head>

<body>
<div id="header-image"></div>


<!-- Page Wrapper -->
<div id="page-wrapper">

        <!-- Header -->
    <header id="header">
        <h1>
            <a href="/">
                JWorks Tech Blog
            </a>
        </h1>

        <nav>
            <a href="#menu">Menu</a>
            <form action="/search/" method="get" class="header-search search-form">
                <input type="text" id="search-box-header" name="query" placeholder="Search &hellip;">
            </form>
        </nav>
    </header>

    <!-- Menu -->
    <nav id="menu">
        <div class="inner">
            <h2>Menu</h2>
            <ul class="links">
                <li class="menu-item"><a href="/">Home</a></li>
                <li class="menu-item"><a href="/about">About Us</a></li>
                <li class="menu-item"><a href="/jobs">Jobs</a></li>
                <li class="menu-item"><a href="/launch-your-career">Career</a></li>
                <li class="menu-item"><a href="/tech-radar">Tech Radar</a></li>
                <li class="menu-item"><a href="/search">Search</a></li>
                <li class="menu-item"><a href="/contact">Contact Us</a></li>
            </ul>
            <a href="#" class="close">Close</a>
        </div>
    </nav>

    <section id="banner">
        <header>
            <div class="inner">
                

                <h2>Stairway to Health 2.0 (the Ordina version)</h2>
                

                
                    Posted Mar 14, 2018


    in <a href="/categories/iot/">IoT</a>



    by
    
        <a href="/author/michael-vervloet/">Michael Vervloet</a>
        
            
                 and 
        
        
    
        <a href="/author/axel-bergmans/">Axel Bergmans</a>
        
    



    <br/>
    <i class="fa fa-tags"></i>
    
        <a href="/tags/nodejs/">NodeJS</a>, 
    
        <a href="/tags/nestjs/">nestJs</a>, 
    
        <a href="/tags/mongodb/">MongoDB</a>, 
    
        <a href="/tags/angular/">Angular</a>, 
    
        <a href="/tags/expressjs/">ExpressJS</a>, 
    
        <a href="/tags/express/">Express</a>, 
    
        <a href="/tags/typescript/">TypeScript</a>, 
    
        <a href="/tags/angular-cli/">Angular-CLI</a>, 
    
        <a href="/tags/internet-of-things/">Internet of Things</a>, 
    
        <a href="/tags/iot/">IoT</a>, 
    
        <a href="/tags/lora/">LoRa</a>
    

                

                

            </div>
        </header>
    </section>

    <section id="wrapper">
        <div class="inner">
            <section id="one" class="wrapper spotlight style1 post-body">
    <div class="inner" style="text-align: left;">
        <div class="content">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.9.0/css/lightbox.css" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-grid-only@1.0.0/bootstrap.css" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.9.0/js/lightbox.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap-grid-only@1.0.0/index.min.js"></script>

<h2>Harder, Better, Faster, Stronger</h2>
<p>Here we are again, another blog post about <a href="https://stairwayto.health/dashboard">Stairway to Health</a>.</p>

<p>Why? Well, we’ve created our own Ordina version of the <a href="https://stairwayto.health/dashboard">Stairway to Health</a> application.
There are quite a few interesting bells and whistles, among others, here are a few of the new features:</p>
<ul>
  <li>New (and awesome) frontend design, with Ordina theming obviously</li>
  <li>Upgraded from Angular 4 to Angular 5</li>
  <li>Material Design</li>
  <li>Nest.js in stead of Express.js (still Express underneath, but cleaner code!)</li>
  <li>Backend e2e tests with Mockgoose</li>
  <li>Deployed on OpenShift</li>
  <li>New type of sensors</li>
  <li>Cheers feature, users can motivate and support each other</li>
</ul>

<h2>Stairway to Health @ Ordina</h2>
<p>As you might have read in our <a href="https://ordina-jworks.github.io/iot/2017/10/12/Stairway-To-Health.html">previous post</a> about Stairway to Health, the purpose of the application is to improve worker health in a fun and engaging way. 
With the app we try to encourage employees to take the stairs instead of the elevator.
We’ve put up some sensors that can detect how much the stairs are used on a per floor basis and how many people take the elevator.
In the app they can see the results and thus they can do an extra effort if they are falling behind.
New in the Ordina version is that employees can now also cheer and motivate each other since we’ve added a chat feature to the application.</p>

<h2>Internet of Things</h2>
<p>The <a href="https://stairwayto.health/dashboard">Stairway to Health</a> project is a simple yet great example to show what the Internet of Things can do:</p>
<ul>
  <li>LoRa sensors detect door openings, these are installed on the doors of the staircases</li>
  <li>These sensors communicate via the LoRa network to report their status</li>
  <li>In our case, sensor data is sent to the Proximus MyThings platform which processes the data</li>
  <li>The data gets sent to the Stairway to Health application</li>
  <li>The Stairway to Health application interprets and visualises the data</li>
</ul>

<p>In summary: We install sensors on the doors (things) to measure usage and we analyse the data to persuade people to move more.
The result is a good example of how IoT can influence our daily lives.</p>

<p>For more on this topic, check the application’s <a href="https://stairwayto.health/about">About page</a></p>

<h2>Dive into the technical details</h2>
<p>The reason of us writing this blog post is mainly because we want to explain some of the technical changes and improvements we’ve made
since we’ve updated (pretty much rewritten) the application. 
So let’s get started.</p>

<h3>The API</h3>
<p>ExpressJs to Nest.js: The main difference here is that we’ve rewritten the application to use the new framework inf favour of the old implementation with ExpressJs.
Migrating from Express to Nest is not that difficult, since Nest is a wrapper on top of the Express framework.
It provides you with some nice TypeScript decorators which makes your code a lot cleaner, more compact and easier to read.</p>

<h4>ExpressJs example</h4>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">class</span> <span class="nx">EntityApi</span> <span class="kd">extends</span> <span class="nx">CoreApi</span> <span class="p">{</span>
    <span class="kr">private</span> <span class="nx">entityController</span><span class="p">:</span> <span class="nx">EntityController</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EntityController</span><span class="p">();</span>
    <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// the create function would that have to be executed by the main server while bootstrapping the application</span>
    <span class="kr">public</span> <span class="nx">create</span><span class="p">(</span><span class="nx">router</span><span class="p">:</span> <span class="nx">Router</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span> <span class="dl">'</span><span class="s1">/auth/entities</span><span class="dl">'</span><span class="p">,</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">,</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">requireAdmin</span><span class="p">,</span>
                    <span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">,</span> <span class="nx">next</span><span class="p">:</span> <span class="nx">NextFunction</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">entityController</span><span class="p">.</span><span class="nx">getEntityList</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
                    <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4>NestJs example</h4>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// automatically registered to the server by nest</span>
<span class="c1">// all /auth routes require user to be logged in (doesn't come standard with Nest)</span>
<span class="p">@</span><span class="nd">Controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">/auth/entities</span><span class="dl">'</span><span class="p">)</span>
<span class="p">@</span><span class="nd">UseGuards</span><span class="p">(</span><span class="nx">RolesGuard</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">EntitiesController</span> <span class="p">{</span>
    <span class="kd">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">readonly</span> <span class="nx">entitiesService</span><span class="p">:</span> <span class="nx">EntitiesService</span><span class="p">)</span> <span class="p">{}</span>
    <span class="p">@</span><span class="nd">Get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">@</span><span class="nd">Roles</span><span class="p">(</span><span class="dl">'</span><span class="s1">admin</span><span class="dl">'</span><span class="p">)</span>
    <span class="k">async</span> <span class="nx">findAll</span><span class="p">():</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">IEntity</span><span class="p">[]</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">entitiesService</span><span class="p">.</span><span class="nx">findAll</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3>Websockets with NestJs</h3>
<p>Working with sockets is also a lot easier and cleaner when using Nest.
We can utilise the <code class="highlighter-rouge">@WebSocketGateway</code> to create a new route/gateway, <code class="highlighter-rouge">@SubscribeMessage</code> to listen for certain events and <code class="highlighter-rouge">@OnGatewayConnection</code> or <code class="highlighter-rouge">@OnGatewayDisconnect</code> to know when users connect or disconnect to the server.
There wasn’t any straight forward solution for broadcasting to all clients. 
Once a user sends a message, we want to update the messages for everyone that has the client open. 
So we solved this by pushing all connected clients to an array and when we receive a ‘cheer-created’ event, we loop over the array of clients and emit an event to them one by one.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span>
	<span class="nx">WebSocketGateway</span><span class="p">,</span> <span class="nx">SubscribeMessage</span><span class="p">,</span> <span class="nx">OnGatewayConnection</span><span class="p">,</span> <span class="nx">OnGatewayDisconnect</span><span class="p">,</span>
	<span class="nx">WsResponse</span>
<span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@nestjs/websockets</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">WebSocketGateway</span><span class="p">({</span><span class="na">namespace</span><span class="p">:</span> <span class="dl">'</span><span class="s1">events/cheers</span><span class="dl">'</span><span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">CheerEventsComponent</span> <span class="kr">implements</span> <span class="nx">OnGatewayConnection</span><span class="p">,</span> <span class="nx">OnGatewayDisconnect</span> <span class="p">{</span>
	<span class="kr">public</span> <span class="nx">clients</span> <span class="o">=</span> <span class="p">[];</span>

	<span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span>

	<span class="p">}</span>

	<span class="nx">handleConnection</span><span class="p">(</span><span class="nx">client</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">client</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="nx">handleDisconnect</span><span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">client</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="p">@</span><span class="nd">SubscribeMessage</span><span class="p">(</span><span class="dl">'</span><span class="s1">cheer-created</span><span class="dl">'</span><span class="p">)</span>
	<span class="nx">onEvent</span><span class="p">():</span> <span class="nx">WsResponse</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">(</span><span class="dl">'</span><span class="s1">cheer</span><span class="dl">'</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="kr">private</span> <span class="nx">broadcast</span><span class="p">(</span><span class="na">message</span><span class="p">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">c</span> <span class="k">of</span> <span class="k">this</span><span class="p">.</span><span class="nx">clients</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">c</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3>Optimising chart data and counts</h3>
<p>On Stairway to Health we used mongo aggregations to get our chart data from the database. 
Once we hit 1.5 million logs, these calls put a lot of stress on our servers and took a long time to load, so in stead we now keep track of daily, weekly, monthly, yearly and total logs in their own collection.
Whenever we receive a log from the MyThings stream we update all these collections. 
For example the daily logs collection contains documents that look like this:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
</span><span class="s2">"date"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"$date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2017-12-20T21:49:15.532Z"</span><span class="w">
</span><span class="p">},</span><span class="w">
</span><span class="s2">"friendlyName1"</span><span class="p">:</span><span class="w"> </span><span class="s2">"C"</span><span class="p">,</span><span class="w">
</span><span class="s2">"friendlyName2"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
</span><span class="s2">"hour"</span><span class="p">:</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span><span class="w">
</span><span class="s2">"identifier"</span><span class="p">:</span><span class="w"> </span><span class="s2">"20-12-2017"</span><span class="p">,</span><span class="w">
</span><span class="s2">"counts"</span><span class="p">:</span><span class="w"> </span><span class="mi">55</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>So when we want the hourly data from a certain day, we query the collection for the date we want and and simply return an array with all the different hours, if an hour doesn’t exist, we assume it didn’t send any logs/counts.
When we receive a log, we check if there is an entry that has “date” and “hour” equal to the log’s date. 
If so, we update, otherwise we create a new entry (upsert).
We still store the log in a “logs” collection, so that if ever our daily, weekly, … collections get corrupted, we can run a script that populates these collections with the correct data.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="nx">create</span><span class="p">(</span><span class="nx">log</span><span class="p">:</span> <span class="nx">ILog</span><span class="p">,</span> <span class="nx">stream</span><span class="p">?:</span> <span class="nx">boolean</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ILog</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>

        <span class="c1">// We insert the log into our logs collection</span>
        <span class="kd">let</span> <span class="nx">item</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">logModel</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">log</span><span class="p">);</span>

        <span class="c1">// the identifiers so we can easily query for them</span>
        <span class="kd">let</span> <span class="nx">dailyIdentifier</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">item</span><span class="p">.</span><span class="nx">day</span><span class="p">}</span><span class="s2">-</span><span class="p">${</span><span class="nx">item</span><span class="p">.</span><span class="nx">month</span><span class="p">}</span><span class="s2">-</span><span class="p">${</span><span class="nx">item</span><span class="p">.</span><span class="nx">year</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
        <span class="kd">let</span> <span class="nx">weeklyIdentifier</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">item</span><span class="p">.</span><span class="nx">week</span><span class="p">}</span><span class="s2">-</span><span class="p">${</span><span class="nx">item</span><span class="p">.</span><span class="nx">year</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
        <span class="kd">let</span> <span class="nx">monthlyIdentifier</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">item</span><span class="p">.</span><span class="nx">month</span><span class="p">}</span><span class="s2">-</span><span class="p">${</span><span class="nx">item</span><span class="p">.</span><span class="nx">year</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
        <span class="kd">let</span> <span class="nx">yearlyIdentifier</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">item</span><span class="p">.</span><span class="nx">year</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>

        <span class="c1">// sensors send all their containers to us, we only need to update the collections</span>
        <span class="c1">// if they are 'counters' and they have a numeric value</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">container</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">counter</span><span class="dl">'</span> <span class="o">&amp;&amp;</span> <span class="nx">item</span><span class="p">.</span><span class="nx">numericValue</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">// update all collections</span>
            <span class="c1">// by putting them in a variable, they all get executed without having to wait for each one to complete,</span>
            <span class="c1">// and we have no 'callback hell', below te do a Promise.all so that we know when they are all done.</span>

            <span class="kd">let</span> <span class="nx">dailyCountPromise</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">dailyCountsModel</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>
                <span class="na">identifier</span><span class="p">:</span> <span class="nx">dailyIdentifier</span><span class="p">,</span>
                <span class="na">friendlyName1</span><span class="p">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">friendlyName1</span><span class="p">,</span>
                <span class="na">friendlyName2</span><span class="p">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">friendlyName2</span><span class="p">,</span>
                <span class="na">hour</span><span class="p">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">hour</span>
            <span class="p">},</span> <span class="p">{</span>
                <span class="c1">// increment, not overwrite the counts</span>
                <span class="na">$inc</span><span class="p">:</span> <span class="p">{</span><span class="na">counts</span><span class="p">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">numericValue</span><span class="p">}</span>
            <span class="p">},</span> <span class="p">{</span>
                <span class="c1">// upsert makes sure that if the entry we try to update doesn't exist, we create one</span>
                <span class="na">upsert</span><span class="p">:</span> <span class="kc">true</span>
            <span class="p">});</span>
            <span class="kd">let</span> <span class="nx">weeklyCountPromise</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">weeklyCountsModel</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>
                <span class="na">identifier</span><span class="p">:</span> <span class="nx">weeklyIdentifier</span><span class="p">,</span>
                <span class="na">friendlyName1</span><span class="p">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">friendlyName1</span><span class="p">,</span>
                <span class="na">friendlyName2</span><span class="p">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">friendlyName2</span><span class="p">,</span>
                <span class="na">day</span><span class="p">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">day</span>
            <span class="p">},</span> <span class="p">{</span>
                <span class="na">$inc</span><span class="p">:</span> <span class="p">{</span><span class="na">counts</span><span class="p">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">numericValue</span><span class="p">}</span>
            <span class="p">},</span> <span class="p">{</span><span class="na">upsert</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
            <span class="kd">let</span> <span class="nx">totalCountPromise</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">totalCountsModel</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>
                <span class="na">friendlyName1</span><span class="p">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">friendlyName1</span><span class="p">,</span>
                <span class="na">friendlyName2</span><span class="p">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">friendlyName2</span>
            <span class="p">},</span> <span class="p">{</span>
                <span class="na">$inc</span><span class="p">:</span> <span class="p">{</span><span class="na">counts</span><span class="p">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">numericValue</span><span class="p">}</span>
            <span class="p">},</span> <span class="p">{</span><span class="na">upsert</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
            <span class="kd">let</span> <span class="nx">yearlyCountPromise</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">yearlyCountsModel</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>
                <span class="na">friendlyName1</span><span class="p">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">friendlyName1</span><span class="p">,</span>
                <span class="na">friendlyName2</span><span class="p">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">friendlyName2</span><span class="p">,</span>
                <span class="na">month</span><span class="p">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">month</span><span class="p">,</span>
                <span class="na">identifier</span><span class="p">:</span> <span class="nx">yearlyIdentifier</span>
            <span class="p">},</span> <span class="p">{</span>
                <span class="na">$inc</span><span class="p">:</span> <span class="p">{</span><span class="na">counts</span><span class="p">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">numericValue</span><span class="p">}</span>
            <span class="p">},</span> <span class="p">{</span><span class="na">upsert</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
            <span class="kd">let</span> <span class="nx">monthlyCountPromise</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">monthlyCountsModel</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>
                <span class="na">friendlyName1</span><span class="p">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">friendlyName1</span><span class="p">,</span>
                <span class="na">friendlyName2</span><span class="p">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">friendlyName2</span><span class="p">,</span>
                <span class="na">week</span><span class="p">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">week</span><span class="p">,</span>
                <span class="na">identifier</span><span class="p">:</span> <span class="nx">monthlyIdentifier</span>
            <span class="p">},</span> <span class="p">{</span>
                <span class="na">$inc</span><span class="p">:</span> <span class="p">{</span><span class="na">counts</span><span class="p">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">numericValue</span><span class="p">}</span>
            <span class="p">},</span> <span class="p">{</span><span class="na">upsert</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>

            <span class="c1">// once all collections are updated, we emit a 'stream-received' event,</span>
            <span class="c1">// which will reload the charts on the client application</span>
            <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span> <span class="nx">dailyCountPromise</span><span class="p">,</span>
                          <span class="nx">weeklyCountPromise</span><span class="p">,</span>
                          <span class="nx">totalCountPromise</span><span class="p">,</span>
                          <span class="nx">yearlyCountPromise</span><span class="p">,</span>
                          <span class="nx">monthlyCountPromise</span><span class="p">]).</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
                              <span class="k">if</span> <span class="p">(</span><span class="nx">stream</span><span class="p">)</span> <span class="p">{</span>
                                  <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">stream-received</span><span class="dl">'</span><span class="p">);</span>
                              <span class="p">}</span>
                          <span class="p">},</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
                          <span class="p">});</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">item</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">HttpException</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">HttpStatus</span><span class="p">.</span><span class="nx">BAD_REQUEST</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3>The Visible parts</h3>
<p>The main changes we’ve made on the frontend are:</p>
<ul>
  <li>Changing the colours, we created a dark theme with Ordina branding</li>
  <li>Used material design for a smoother user experience</li>
  <li>Replaced Highcharts library with <code class="highlighter-rouge">@swimlane/ngx-charts</code></li>
  <li>Migrated to Angular 5</li>
</ul>

<div class="row">
    <div class="col-md-4">
        <a href="/img/stairwaytohealth2/frontend1.png" data-lightbox="results" data-title="">
            <img alt="frontend 1" src="/img/stairwaytohealth2/frontend1.png" class="image fit" />
        </a>
    </div>
    <div class="col-md-4">
        <a href="/img/stairwaytohealth2/frontend2.png" data-lightbox="results" data-title="">
            <img alt="frontend 2" src="/img/stairwaytohealth2/frontend2.png" class="image fit" />
        </a>
    </div>
    <div class="col-md-4">
        <a href="/img/stairwaytohealth2/frontend3.png" data-lightbox="results" data-title="">
            <img alt="frontend 3" src="/img/stairwaytohealth2/frontend3.png" class="image fit" />
        </a>
    </div>
</div>

<p>Since users should now be able to register to the application to cheer for and motivate each other we added these new screens and functionality.</p>

<div class="row">
    <div class="col-md-6">
        <a href="/img/stairwaytohealth2/register.png" data-lightbox="results" data-title="">
            <img alt="register" src="/img/stairwaytohealth2/register.png" class="image fit" />
        </a>
    </div>
    <div class="col-md-6">
        <a href="/img/stairwaytohealth2/cheer.png" data-lightbox="results" data-title="">
            <img alt="cheers" src="/img/stairwaytohealth2/cheer.png" class="image fit" />
        </a>
    </div>
</div>

<h3>Deploy on OpenShift</h3>
<p>Since we’ve separated our frontend and backend code we used 2 separate Git repositories. 
The nice thing about deploying to OpenShift is that we can add a webhook to GitHub so that every time we merge a pull request from our develop branch to our
master branch to our Git remote, it builds and deploys the new code immediately.</p>

<p><a href="/img/stairwaytohealth2/stack.png" data-lightbox="results" data-title="">
    <img alt="stack" src="/img/stairwaytohealth2/stack.png" class="image fit" />
</a></p>

<h3>The new sensors: Proximus MySense</h3>
<p>For the previous version of Stairway to Health we used Magnetic door sensors,
these use a magnet mounted on the door frame and the sensor mounted on the door itself, when the door is closed the magnet
makes contact with the sensor and the sensor detects the door is closed. This means you need to mount at two places,
and it needs to be carefully placed to align. This makes it not an ideal solution.</p>

<p>A solution for this is the MySense sensor. This is a LoRa sensor programmable with JavaScript.</p>

<p>The MySense is a small LoRa device containing multiple sensors.
It contains a temperature sensor, a button, …
But the most important sensor for our case is the accelerometer.
Using the accelerometer we can detect when the door is moving. After detecting a motion we will blackout the sensor
for 30 seconds to allow the door to be closed again and not count multiple motions.</p>

<p>To save battery we do not send on every motion,
but count the amount of motions for 15 minutes and then send the counter,
also when the counter is 0 we will not send to save battery.</p>

<h3>Conclusion</h3>
<p>We made some major improvements when it comes to performance, maintainability and functionality.
By deploying our application to OpenShift, we also improved our workflow and made it a lot easier to deploy our changes.
By using the MySense as our sensor we only have to mount one piece per door. An extra advantage is that this sensor is a lot cheaper.</p>

<h3>Interesting Links</h3>
<ul>
  <li><a href="https://stairwayto.health/dashboard">Stairway to Health 2.0</a></li>
  <li><a href="https://ordina-jworks.github.io/iot/2017/10/12/Stairway-To-Health.html">Blogpost Stairway to Health 1</a></li>
  <li><a href="https://nestjs.com/">Nest.js</a></li>
  <li><a href="https://www.openshift.com/">OpenShift</a></li>
</ul>

        </div>
    </div>
    <div class="share-page" >
        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://ordina-jworks.github.io/iot/2018/03/14/Stairway-To-Health-2.html&title=Stairway to Health 2.0 (the Ordina version)&source=https://ordina-jworks.github.io" rel="nofollow" target="_blank" title="Share on LinkedIN">
            <img src="/img/social-media/LinkedIn.png"
                 alt="Share on LinkedIn" />
        </a>
        <a href="https://twitter.com/intent/tweet?text=Stairway to Health 2.0 (the Ordina version)&url=https://ordina-jworks.github.io/iot/2018/03/14/Stairway-To-Health-2.html&via=lifeatordinabe&related=lifeatordinabe" rel="nofollow" target="_blank" title="Share on Twitter">
            <img src="/img/social-media/Twitter.png"
                 alt="Share on Twitter" />
        </a>
        <a href="https://facebook.com/sharer.php?u=https://ordina-jworks.github.io/iot/2018/03/14/Stairway-To-Health-2.html" rel="nofollow" target="_blank" title="Share on Facebook">
            <img src="/img/social-media/Facebook.png"
                 alt="Share on Facebook" />
        </a>
    </div>
        
</section>


<section id="two" class="wrapper alt spotlight style2">
    
    <div class="inner">
        <a href="/author/michael-vervloet/" class="image spotlight-image" title="">
            <img src="/img/author/michael-vervloet.jpg"
                 alt="" class="p-image"/>
        </a>

        <div class="content">
            
            <p><p>Michael is a full stack JavaScript/TypeScript developer specialising himself in backend development with NodeJs and Express and has a solid background in frontend/hybrid mobile development. As a member of Ordina’s core ‘Internet of Things’ team he has collaborated on some challenging and innovative IoT applications.</p>
</p>
            
        </div>
    </div>
    
    <div class="inner">
        <a href="/author/axel-bergmans/" class="image spotlight-image" title="">
            <img src="/img/author/axel-bergmans.jpg"
                 alt="" class="p-image"/>
        </a>

        <div class="content">
            
            <p><p>Axel is a Java Developer at Ordina Belgium. He enjoys learning new things and discovering new methods of working. At the moment he is focused on IoT projects and technologies.</p>
</p>
            
        </div>
    </div>
    
</section>

        </div>
    </section>
</div>



<footer>
    <div class="contact">
        <div class="address">
            <div class="icon"><i class="fa fa-fw fa-home"></i></div>
            <div class="text">Ordina Belgium<br/>Blarenberglaan 3B,<br/>2800 Mechelen, Belgium</div>
        </div>
        <div class="phone">
            <div class="icon"><i class="fa fa-fw fa-phone"></i></div>
            <div class="text"><a href="tel:003215295858">+32 15 29 58 58</a></div>
        </div>
        <div class="email">
            <div class="icon"><i class="fa fa-fw fa-envelope-o"></i></div>
            <div class="text"><a href="mailto:jworks@ordina.be">jworks@ordina.be</a></div>
        </div>
    </div>
    <ul class="social">
        <li>
            <a href="https://twitter.com/lifeatordinabe" target="_blank">
                <i class="fa fa-fw fa-twitter"></i><span>Twitter</span>
            </a>
        </li>
        <li>
            <a href="https://www.facebook.com/lifeatordinabe" target="_blank">
                <i class=" fa fa-fw fa-facebook"></i><span>Facebook</span>
            </a>
        </li>
        <li>
            <a href="https://www.linkedin.com/company/ordina-belgium" target="_blank">
                <i class=" fa fa-fw fa-linkedin"></i><span>LinkedIn</span>
            </a>
        </li>
        <li>
            <a href="https://plus.google.com/113222464071666722451" target="_blank">
                <i class=" fa fa-fw fa-google-plus"></i><span>Google+</span>
            </a>
        </li>
        <li>
            <a href="/youtube" target="_blank">
                <i class=" fa fa-fw fa-youtube"></i><span>YouTube</span>
            </a>
        </li>
        <li>
            <a href="/github" target="_blank">
                <i class=" fa fa-fw fa-github"></i><span>GitHub</span>
            </a>
        </li>
        <li>
            <a href="/feed.xml" target="_blank">
                <i class=" fa fa-fw fa-rss"></i><span>RSS Feed</span>
            </a>
        </li>
    </ul>
    <div class="copyright">
        &copy; 2019 Ordina JWorks. All rights reserved.
        <br /> Disclaimer: Opinions expressed on this blog reflect the writer's views and not the position of Ordina
        <img id="analyticsImg" src="" width="1" height="1" style="border: 0px"/>
    </div>
</footer>
<!-- Scripts -->
<script src="/js/jquery.min.js"></script>
<script src="/js/jquery.scrollex.min.js"></script>
<script src="/js/jquery.magnific-popup.min.js"></script>
<script src="/js/owl.carousel.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/skel.min.js"></script>
<script src="/js/jquery.pin.min.js"></script>
<script src="/js/util.js"></script>
<!--[if lte IE 8]>
<script src="/js/ie/respond.min.js"></script><![endif]-->


<script>
    var imageHref = "/img/stairwaytohealth2/banner.jpg";
    $(function () {
        $('body').addClass('toggle');
    });
</script>


<script src="/js/main.js"></script>

<!-- Google Analytics -->
<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o);
        m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m);
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'UA-70040502-1', 'auto');
    ga('send', 'pageview');
</script>
<script type="text/javascript">
    window.addEventListener('load', function () {
        if (window.ga && ga.create) {
            console.log('GA loaded correctly');
        } else {
            console.log('GA is blocked or failed to load - tracking manually...')
            document.getElementById('analyticsImg').src = 'https://jworks-techblog-analytics.cfapps.io/collect?title=' + document.title;
        }
    }, false);
</script>

<!-- Vertical timeline -->
<script src="/js/vertical-timeline/modernizr.js"></script>
<script src="/js/vertical-timeline/main.js"></script>


</body>
</html>
