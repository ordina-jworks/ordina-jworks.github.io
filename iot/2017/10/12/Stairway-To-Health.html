<!DOCTYPE html>
<!--suppress ALL -->
<html>
<head>
        <meta charset="utf-8">
    <meta name="description" content="We build innovative solutions with Java and JavaScript. To support this mission, we have several Competence Centers. From within those Competence Centers, we provide coaching to the employee and expert advice towards our customer. In order to keep in sync with the latest technologies and the latest trends, we frequently visit conferences around the globe.
">
    <meta name="keywords" content="Ordina,ORAJ,JWorks,Blog,Java,JavaScript,TypeScript,Angular,DevOps">
    <meta name="author" content="Ordina Belgium">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/img/favicons/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/img/favicons/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/img/favicons/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/favicons/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="/img/favicons/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/img/favicons/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/img/favicons/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/img/favicons/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-128.png" sizes="128x128" />

    

    <!-- Twitter Card data -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Stairway to Health with IoT and the MEAN stack - Michael Vervloet, Ines Van Stappen and Kevin Van den Abeele">
    <meta name="twitter:description" content="Ordina JWorks Tech Blog">
    <meta name="twitter:image" content="http://ordina-jworks.github.io/img/stairwaytohealth/stairway-to-health.jpg"/>

    <!-- Facebook Open Graph -->
    <meta property="og:url" content="http://ordina-jworks.github.io/iot/2017/10/12/Stairway-To-Health.html"/>
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Stairway to Health with IoT and the MEAN stack - Michael Vervloet, Ines Van Stappen and Kevin Van den Abeele"/>
    <meta property="og:description" content="Ordina JWorks Tech Blog"/>
    <meta property="og:image" content="http://ordina-jworks.github.io/img/stairwaytohealth/stairway-to-health.jpg"/>

    
    <title>Stairway to Health with IoT and the MEAN stack - Michael Vervloet, Ines Van Stappen and Kevin Van den Abeele &mdash; Ordina JWorks Tech Blog</title>
    

        <!-- Styles -->
    <!-- Font awesome CSS -->
    <link href="/css/font-awesome.min.css" rel="stylesheet">
    <!-- Magnific Popup -->
    <link href="/css/magnific-popup.css" rel="stylesheet">
    <!-- Owl carousel -->
    <link href="/css/owl.carousel.css" rel="stylesheet">

    <!-- CSS for this page -->

    <!-- Syntax highlighting -->
    <link href="/css/syntax.css" rel="stylesheet">


    <!--[if lte IE 8]>
    <script src="/js/ie/html5shiv.js"></script><![endif]-->
    <link rel="stylesheet" href="/css/main.css"/>
    <!--[if lte IE 9]>
    <link rel="stylesheet" href="/css/ie9.css"/><![endif]-->
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="/css/ie8.css"/><![endif]-->

    <!-- Custom CSS. Type your CSS code in custom.css file -->
    <link href="/css/custom.css" rel="stylesheet">

    <!-- Vertical timeline -->
	<link rel="stylesheet" href="/css/vertical-timeline/style.css"> <!-- Resource style -->

    <!-- Favicon -->
    <link rel="shortcut icon" href="#">

    <script src="https://use.typekit.net/gzh0mbm.js"></script>
    <script>
        try {
            Typekit.load({async: true});
        } catch (e) {
        }
    </script>
</head>

<body>
<div id="header-image"></div>


<!-- Page Wrapper -->
<div id="page-wrapper">

        <!-- Header -->
    <header id="header">
        <h1>
            <a href="/">
                JWorks Tech Blog
            </a>
        </h1>

        <nav>
            <a href="#menu">Menu</a>
            <form action="/search/" method="get" class="header-search search-form">
                <input type="text" id="search-box-header" name="query" placeholder="Search &hellip;">
            </form>
        </nav>
    </header>

    <!-- Menu -->
    <nav id="menu">
        <div class="inner">
            <h2>Menu</h2>
            <ul class="links">
                <li class="menu-item"><a href="/">Home</a></li>
                <li class="menu-item"><a href="/about">About Us</a></li>
                <li class="menu-item"><a href="/meet-the-team">Meet the team</a></li>
                <li class="menu-item"><a href="/jobs">Jobs</a></li>
                <li class="menu-item"><a href="/search">Search</a></li>
                <li class="menu-item"><a href="https://join.ordina-jworks.io/">JOIN</a></li>
                <li class="menu-item"><a href="/contact">Contact Us</a></li>
            </ul>
            <a href="#" class="close">Close</a>
        </div>
    </nav>

    <section id="banner">
        <header>
            <div class="inner">
                

                <h2>Stairway to Health with IoT and the MEAN stack</h2>
                

                
                    Posted Oct 12, 2017


    in <a href="/categories/iot/">IoT</a>



    by
    
        <a href="/author/michael-vervloet/">Michael Vervloet</a>
        
            
                , 
            
        
    
        <a href="/author/ines-van-stappen/">Ines Van Stappen</a>
        
            
                 and 
        
        
    
        <a href="/author/kevin-van-den-abeele/">Kevin Van den Abeele</a>
        
    



    <br/>
    <i class="fa fa-tags"></i>
    
        <a href="/tags/node.js/">Node.js</a>, 
    
        <a href="/tags/mongodb/">MongoDB</a>, 
    
        <a href="/tags/angular/">Angular</a>, 
    
        <a href="/tags/express/">Express</a>, 
    
        <a href="/tags/typescript/">TypeScript</a>, 
    
        <a href="/tags/angular-cli/">Angular-CLI</a>, 
    
        <a href="/tags/gulp/">Gulp</a>, 
    
        <a href="/tags/internet-of-things/">Internet of Things</a>, 
    
        <a href="/tags/lora/">LoRa</a>, 
    
        <a href="/tags/proximus/">Proximus</a>
    

                

                

            </div>
        </header>
    </section>


    <section id="wrapper">
        <div class="inner">
            <section id="one" class="wrapper spotlight style1 post-body">
    <div class="inner" style="text-align: left;">
        <div class="content">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.9.0/css/lightbox.css" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.9.0/js/lightbox.min.js"></script>

<blockquote>
  <p>Healthier at the office with the ‘Internet of Things’.</p>
</blockquote>

<h2 id="what-is-stairway-to-health">What is Stairway to Health</h2>
<p>In an effort to improve worker health in a fun and engaging way, Proximus wanted to encourage their employees to take the stairs instead of the elevator.
This is when the idea of a little game between the three towers came along. 
On different dashboards across Proximus and on the Stairway to Health website, the employees could see which tower had the most employees taking the stairs.</p>

<p><img alt="buildings" src="/img/stairwaytohealth/buildings.jpg" class="image fit" />
<img alt="overview" src="/img/stairwaytohealth/overview.jpg" class="image fit" /></p>

<p>They can also get a more detailed look of how many people taking the stairs where and when, with drilldown views for monthly, weekly, daily, and even hourly statistics.</p>

<p><img alt="details" src="/img/stairwaytohealth/details.png" class="image fit" style="margin:0px auto;" /></p>

<p><img alt="weekly" src="/img/stairwaytohealth/weekly.jpg" class="image fit" style="margin:0px auto;" /></p>

<p><img alt="daily" src="/img/stairwaytohealth/daily.jpg" class="image fit" style="margin:0px auto;" /></p>

<h2 id="what-does-it-do">What does it do?</h2>
<p>The Stairway to Health project is a simple yet great example to show what the Internet of Things can do:</p>
<ul>
  <li>LoRa sensors detect door openings, these are installed on the doors of the staircases</li>
  <li>These sensors communicate via the Proximus LoRa network to report their status</li>
  <li>Sensor data is sent to the Proximus MyThings platform which processes the data</li>
  <li>The data gets sent to the Stairway to Health application</li>
  <li>The Stairway to Health application interprets and visualizes the data</li>
</ul>

<p>In summary: 
We install sensors on the doors (things) to measure usage and we analyse the data to persuade people to move more. 
The result is a good example of how IoT can influence our daily lives. 
Proximus was able to provide us with all the necessary building blocks to offer a complete end-to-end solution!</p>

<p><img alt="dataflow" src="/img/stairwaytohealth/dataflow.jpg" class="image fit" style="margin:0px auto;" /></p>

<h2 id="mythings-and-stairway-to-health">MyThings and Stairway to Health</h2>
<p>MyThings is the Proximus IoT platform for onboarding, managing, configuring and monitoring IoT sensors. By registering (onboarding) our sensors to the platform, we can let MyThings take care of decoding the messages and set up a stream to our application.
This way every time a log comes in from the sensor, we get the decoded data posted to our designated endpoint.</p>

<h2 id="the-requirements">The Requirements</h2>
<ul>
  <li>The usage of the stairways is measured and the results should be visualized on large screens in the towers.</li>
  <li>These screens should have a QR code so that employees can easily visit the application on their mobile devices.</li>
  <li>When visiting the website, they should be able to click on the results to get a more detailed view of the data.</li>
  <li>The frontend application should be available in Dutch and French and the dashboard should switch between these languages every minute when viewing it on the large screens.</li>
  <li>Admins should be able to manage locations (towers) and chart timespans.</li>
  <li>It should have an info page with some information about the project and its purpose.</li>
</ul>

<p>So technically this translates to build an application that:</p>
<ul>
  <li>Has an endpoint to receive logs from the MyThings Application,</li>
  <li>Stores the data to its own database,</li>
  <li>Show the data in charts that have multiple layers to see more/less details,</li>
  <li>Shows the ratio of the results per tower,</li>
  <li>The frontend dashboard data has to reload automatically (since it is shown on some big screens @ Proximus),</li>
  <li>Add multi-language (automatically switch languages when viewing on tower’s large screens),</li>
  <li>Is performant (able to handle many logs coming in and calculate the data to be displayed in the graphs),</li>
  <li>CRUDs for managing timespans and locations,</li>
  <li>Use the timespans / locations when displaying data.</li>
</ul>

<p>Oh, and did we mention we were only given four weeks to complete this mission…</p>

<h2 id="the-ingredients">The Ingredients</h2>
<p>So given all the requirements listed above and the fact we didn’t have a lot of time to waste, 
we chose to use a <strong>MEAN (TypeScript)</strong> stack. 
MEAN stands for MongoDB Express Angular and NodeJS. 
It’s possible to use the mean stack with plain JavaScript, 
we chose to implement it with TypeScript since we wanted some strong typings on the backend application and we were going to use Angular 4 on the frontend which comes with TypeScript as well.</p>

<h3 id="nodejs">NodeJs:</h3>
<p>Write event driven applications with asynchronous I/O powered by the ultra fast Google V8 Engine. 
Mostly known for running your local dev environment and automating build tasks for frontend developers. 
NodeJS is probably one of the best and easiest options out there for real-time applications (with socket.io), 
which is exactly what we needed for our application.</p>

<h3 id="mongodb">MongoDB:</h3>
<p>Great to work with when dealing with JavaScript Objects. Good driver support with Mongoose for NodeJs. 
Document based structure, which makes it really flexible when it comes to modelling and it’s extremely scalable. 
We also took advantage of the very performant aggregation functionality for dealing with large amounts of data.</p>

<h3 id="expressjs">ExpressJS:</h3>
<p>A node framework that comes with some great functionality for setting up your node server and makes it easy to create routes, 
middleware, handling requests/responses, serving files from the filesystem, configuring static files, easy connections to the database, 
and much more.</p>

<h3 id="angular4">Angular(4):</h3>
<p>A TypeScript-based open-source frontend web application platform led by the Angular Team at Google and by a community of individuals and corporations to address all of the parts of the developer’s workflow while building complex web applications.</p>

<h3 id="socketio">Socket.IO:</h3>
<p>Socket.IO enables real-time bidirectional event-based communication. It works on every platform, browser or device, focusing equally on reliability and speed. To trigger events on our frontend application we used this great library to be able to detect when new data has been received and refresh the dashboard.</p>

<h3 id="highcharts">Highcharts:</h3>
<p>Interactive JavaScript library for creating dynamic charts. Highcharts is based on native browser technologies and not reinvent the wheel. Thousands of developers have contributed their work for us to use in our own projects. Also backwards compatible for IE.</p>

<h2 id="javascript-across-the-stack">JavaScript across the stack</h2>
<p>Not only does it make development quite a bit faster and easier by having a large community with lots of reusable code for your application (npm), it also lowers the barriers between frontend and backend developers by using the same programming language over the entire stack, so more efficiency and faster, leaner development which in turn means lower development costs. 
Also worth noting is that JavaScript currently is THE most popular programming language, so more developers will be able to easily understand and contribute to the application if needed. 
And probably the most important criteria: when it comes to cloud hosting, RAM is probably the main influencing factor when it comes to pricing. NodeJs uses less RAM than comparable Java applications.</p>

<p><img alt="performance" src="/img/stairwaytohealth/performance.png" class="image fit" style="margin:0px auto; max-width:800px;" />
<small style="font-size: 70%;"><a target="_blank" href="https://www.ibm.com/developerworks/library/mo-nodejs-1/index.html">Source and more about these tests</a></small></p>

<p>Now that I’ve listed some of the pros of full-stack JS, I should also mention that it might not be the best solution for computation-heavy backend applications.
For projects like machine learning or heavy mathematical calculations the single CPU core and having only one thread that processes one request at a time might be easily blocked by a single compute-intensive task. 
Yet, there are numerous ways to overcome this limitation. 
By simply creating child processes or breaking complex tasks into smaller independent microservices.</p>

<p>Let me just note that the comparison with Java above here is not because we are claiming that one is better than the other, it’s just to demonstrate that they both have their use cases and can be equally worth considering when choosing a technology for your application.</p>

<p>Some great use cases for JavaScript across the stack are:</p>
<ul>
  <li>real-time chat,</li>
  <li>Internet of Things,</li>
  <li>real-time finance (stocks),</li>
  <li>monitoring applications,</li>
  <li>event-driven applications,</li>
  <li>server-side proxies,</li>
  <li>many more…</li>
</ul>

<h3 id="blocking-vs-non-blocking">Blocking vs. Non-Blocking</h3>
<p>In NodeJs you can take advantage of JavaScript promises. 
One of the benefits of this is that we can write non-blocking code.
To demonstrate how this works, I’ll give you an example in pseudo code for reading a file from the filesystem.</p>

<h3 id="blocking">Blocking:</h3>
<p><code>read file from filesystem, set equal to "contents"</code><br /> 
<code>print content</code><br /> 
<code>do something else</code></p>

<h3 id="non-blocking">Non-Blocking:</h3>
<p><code>read file from filesystem</code><br /> 
<code>&nbsp;&nbsp;&nbsp;&nbsp;Whenever we're complete print contents <span style="color:#e7904b;">(callback)</span> 
</code> 
<br /> 
<code>do something else</code></p>

<p><img alt="blocking-vs-non-blocking" src="/img/stairwaytohealth/blocking-vs-non-blocking.png" class="image fit" style="margin:0px auto; max-width:800px;" /></p>

<h2 id="setting-up-our-dev-environment--build">Setting up our dev environment / build</h2>
<p>The frontend part of this was really easy. 
We used angular-cli to generate a new project. 
In the future this also gave us the advantage of generating new components, services, pipes, testing and much more. 
Also for the charts and translations we choose for easy to use libraries like Highcharts and ngx-translate (previous ng2-translate).</p>

<p>For the backend we decided to go with gulp. 
We added some tasks to transpile our server site TypeScript files to JavaScript so that node can execute it. 
For local serving we created a sequence task that combines running <code class="language-plaintext highlighter-rouge">ng build</code> from the angular-cli and a gulp task to use <code class="language-plaintext highlighter-rouge">nodemon</code> for running our server and restarting on changes. 
When working on the frontend, doing an ‘ng build’ was a bit too slow, therefore we added a <code class="language-plaintext highlighter-rouge">--standalone</code> flag, to the serve task so that we could just build the backend application and do the frontend serve with <code class="language-plaintext highlighter-rouge">ng serve</code> which is a lot more performant than having to do a ‘ng build’ on every change.
Since we are using TypeScript throughout the application, it only felt right to use the TypeScript version of gulp as well. 
It takes a little effort to get used to, but once you get the hang of it, it makes writing gulp tasks a lot more fun and less error prone.
Using the provided decorators, our gulp tasks look something like the following:</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">Task</span><span class="p">()</span>
    <span class="k">public</span> <span class="nf">environment</span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nf">src</span><span class="p">(</span><span class="dl">'</span><span class="s1">./dist/app/server/config/mongo.connection.js</span><span class="dl">'</span><span class="p">)</span>
                   <span class="p">.</span><span class="nf">pipe</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nf">if</span><span class="p">((</span><span class="nx">yargs</span><span class="p">.</span><span class="nx">env</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">prod</span><span class="dl">'</span><span class="p">),</span> <span class="nx">$</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="dl">'</span><span class="s1">mongodb://localhost:27017/stairway</span><span class="dl">'</span><span class="p">,</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./secrets</span><span class="dl">'</span><span class="p">).</span><span class="nx">mongoUrl</span><span class="p">)))</span>
                   <span class="p">.</span><span class="nf">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nf">dest</span><span class="p">(</span><span class="dl">'</span><span class="s1">./dist/app/server/config</span><span class="dl">'</span><span class="p">));</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>and create sequence tasks with:</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">SequenceTask</span><span class="p">()</span>
    <span class="k">public</span> <span class="nf">mocha</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span><span class="dl">'</span><span class="s1">buildApp</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">runMochaTests</span><span class="dl">'</span><span class="p">];</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>Now that we have a <code class="language-plaintext highlighter-rouge">gulpfile.ts</code> file, we need to ensure that the gulpfile gets transpiled as well, we did this by adding an npm script, so that we can use TypeScript compiler with the <code class="language-plaintext highlighter-rouge">tsc</code> command to transpile the file and make sure we are using the latest changes every time we use gulp.
(to get the tsc command, install typescript globally with npm)</p>

<h2 id="building-stairway-to-health">Building Stairway to Health</h2>
<p>After setting up our dev environment, database and getting a simple application up and running it’s time to start implementing our first features.</p>

<p><strong>Receiving data from MyThings</strong><br />
So first things first, on MyThings we took a look at how we were going to structure the data that was going to be streamed to the Stairway to Health application.</p>

<p><img alt="stream.png" src="/img/stairwaytohealth/stream.png" class="image fit" style="margin:0px auto; max-width:800px;" /></p>

<p>In the MyThings application every sensor can have a <code class="language-plaintext highlighter-rouge">friendlyName1</code> and <code class="language-plaintext highlighter-rouge">friendlyName2</code>, we used these to specify which tower and which floor they represent. 
The sensors send a lot more data than just the magnetic pulse counts, therefore we needed the <code class="language-plaintext highlighter-rouge">container</code> field, to be able to filter on <code class="language-plaintext highlighter-rouge">counter</code> logs only (however, we store the other messages as well, maybe for future use). 
The <code class="language-plaintext highlighter-rouge">value</code> field is the amount of times the sensor was triggered, in other words, the actual counts. And of course a <code class="language-plaintext highlighter-rouge">timestamp</code> since we will show the data in time based graphs.</p>

<p>The <code class="language-plaintext highlighter-rouge">timestamp</code> represents the time that the sensor has sent its message to the MyThings application, we also wanted to keep track of when our application has received the log, so before saving we added one extra field to store this in our database.</p>

<p>After we defined our model/schema of our logs, it was simply adding an endpoint to our express router and our first feature was ready. 
Well not exactly, we needed to trigger an event to refresh the data on our dashboard, but we’ll get back to this later.</p>

<p><strong>The Dashboard</strong><br />
Since we created an Angular(4) application, we took advantage of the great features of angular-cli which makes it really easy to get a new project up and running and generate new components, services, tests and much more. 
We started by adding all the components needed for the application and adding the Proximus styling to the project. 
After that we imported the Highcharts library from npm to first make the charts on the homepage and later making the charts for the detailed views. 
All the charts were first made with mock data so that we could perfectly say from the backend what data we needed and in which format. 
From now on we knew how our JSON for the charts had to be made and we could implement the api endpoints for the dashboard and the details page. 
Finally after adding all the charts we started on adding the different languages to the application. Here we got our biggest ‘lesson learned’, it is much faster to start with I18N then to end with it, this is because you have to find all the normal text in the HTML files and copy them to the JSON-files. 
ALso we had to quickly create a translation list that the business could translate for us.</p>

<p><strong>Mongo Aggregates</strong><br />
As for displaying the daily, weekly and total counts below the buildings, we had to get this data from the database, keeping in mind that we would have to iterate over millions of sensor logs (at the time of writing this blog post, 1.4 million over 4 months). We had to make sure it was performant. This is where the Mongo aggregates come in handy. Instead of looping over the results and adding them up, we let Mongo take care of this with the <code class="language-plaintext highlighter-rouge">$sum</code> operator which in code looks like the following:</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">sensorLogModel</span><span class="p">.</span><span class="nf">aggregate</span><span class="p">([</span>
                <span class="p">{</span><span class="na">$match</span><span class="p">:</span> <span class="p">{</span><span class="na">container</span><span class="p">:</span> <span class="dl">'</span><span class="s1">counter</span><span class="dl">'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="p">{</span><span class="na">$ne</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}},</span>
                <span class="c1">// group them by fn1 (tower) and add up all 'value' fields</span>
                <span class="p">{</span><span class="na">$group</span><span class="p">:</span> <span class="p">{</span><span class="na">_id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">$friendlyName1</span><span class="dl">'</span><span class="p">,</span> <span class="na">total</span><span class="p">:</span> <span class="p">{</span><span class="na">$sum</span><span class="p">:</span> <span class="dl">'</span><span class="s1">$value</span><span class="dl">'</span><span class="p">}}}</span>
            <span class="p">]);</span>
</code></pre></div></div>
<p><em>Remember, we store all the logs, but we only need counter logs. So for a little more performance, we leave out the ones with value 0 (a lot of them in the weekends), that’s what the <code class="language-plaintext highlighter-rouge">$match</code> is for</em>
The result: an array with objects that have an <code class="language-plaintext highlighter-rouge">_id</code> field with <code class="language-plaintext highlighter-rouge">friendlyName1</code> as value and a <code class="language-plaintext highlighter-rouge">total</code> field with the sum of all (counter) values per tower. We repeat this for daily and weekly, but add a start and end date (which we simply create with TypeScript). <code class="language-plaintext highlighter-rouge">$match</code> then looks something like this:</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">$match</span><span class="p">:</span> <span class="p">{</span><span class="na">container</span><span class="p">:</span> <span class="dl">'</span><span class="s1">counter</span><span class="dl">'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="p">{</span><span class="na">$ne</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="na">timestamp</span><span class="p">:</span> <span class="p">{</span><span class="na">$gt</span><span class="p">:</span> <span class="nx">start</span><span class="p">,</span> <span class="na">$lt</span><span class="p">:</span> <span class="nx">end</span><span class="p">}}}</span>
</code></pre></div></div>
<p>Later on we added some more calls to get the data by time span and location for the more detailed chart data, but you get the idea, we simply edit the timestamps or <code class="language-plaintext highlighter-rouge">friendlyName1</code> (also by <code class="language-plaintext highlighter-rouge">friendlyName2</code> on the hourly chart, which displays the hourly data per floor).</p>

<p><strong>Socket.IO</strong><br />
Now that we have data that can be retrieved and displayed on the frontend, time to implement some way to let our frontend application know when we receive some new data, so that it in turn can do a request for that new data.</p>

<p>For this one to be clear we’re going to skip ahead in time and show a high level scheme of how the application is made up.</p>

<p><a href="/img/stairwaytohealth/folder-structure.png" data-lightbox="structure" data-title="Structure">
    <img alt="folder-structure" src="/img/stairwaytohealth/folder-structure.png" class="image fit" style="margin:0px auto; max-width:800px;" />
</a></p>

<p>The bin (js) file is where we create our http, https and socket servers. To communicate between them, we use the node event emitter. 
The <code class="language-plaintext highlighter-rouge">server.ts</code> file (let’s call it the app) gets bootstrapped onto these servers and when creating the app, we pass the created event emitter to it. 
This enables us to listen and broadcast events back and forward. 
The event emitter emits events between the backend services and the socket.io server emits events to our frontend application.</p>

<p>So in our case, to let the frontend know when the sensor-log endpoint has received a message, we emit a <code class="language-plaintext highlighter-rouge">log-received</code> event on the node event emitter. 
In the socket IO server we are listening on this event and we broadcast a <code class="language-plaintext highlighter-rouge">data</code> event to every connected frontend application. 
The frontend applications are listening for this <code class="language-plaintext highlighter-rouge">data</code> event and refresh their data by calling the dashboard endpoints.
However, since we have about 60 sensors sending data, this event was triggering quite a lot and with the chart rendering animations on our frontend application we had to wrap the <code class="language-plaintext highlighter-rouge">log-received</code> in a timeout so that we would only refresh it once every 30 seconds (if a log was received).</p>

<p>I’ve picked a few lines of code from our bin file to demonstrate how we pass the <code class="language-plaintext highlighter-rouge">eventEmitter</code> when bootstrapping our application on to the http and https services from node.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../dist/app/server</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">http</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">http</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">https</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">https</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">events</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">events</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">eventEmitter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">events</span><span class="p">.</span><span class="nc">EventEmitter</span><span class="p">();</span>

<span class="kd">const</span> <span class="nx">httpServer</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">createServer</span><span class="p">(</span><span class="nx">server</span><span class="p">.</span><span class="nx">Server</span><span class="p">.</span><span class="nf">bootstrap</span><span class="p">(</span><span class="nx">eventEmitter</span><span class="p">).</span><span class="nx">app</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">httpsServer</span> <span class="o">=</span> <span class="nx">https</span><span class="p">.</span><span class="nf">createServer</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">Server</span><span class="p">.</span><span class="nf">bootstrap</span><span class="p">(</span><span class="nx">eventEmitter</span><span class="p">).</span><span class="nx">app</span><span class="p">);</span>
</code></pre></div></div>

<p>After that, we bootstrap the created https server on to the socket.io application. It too gets the same <code class="language-plaintext highlighter-rouge">EventEmitter</code> instance passed into its constructor.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">io</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">socket.io</span><span class="dl">'</span><span class="p">)(</span><span class="nx">httpsServer</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">sockets</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../dist/app/sockets</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">ioApp</span> <span class="o">=</span> <span class="nx">sockets</span><span class="p">.</span><span class="nx">Sockets</span><span class="p">.</span><span class="nf">bootstrap</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span> <span class="nx">eventEmitter</span><span class="p">).</span><span class="nx">io</span><span class="p">;</span>
</code></pre></div></div>

<p>In our sockets file, the method that gets executed will listen on the <code class="language-plaintext highlighter-rouge">logsReceived</code> from our passed EventEmitter, and emits a <code class="language-plaintext highlighter-rouge">data</code> event on our <code class="language-plaintext highlighter-rouge">io</code> instance.</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="nf">sockets</span><span class="p">(</span><span class="nx">eventEmitter</span><span class="p">,</span> <span class="nx">io</span><span class="p">){</span>
    <span class="nx">eventEmitter</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">logsReceived</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">logs</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">io</span><span class="p">.</span><span class="nf">of</span><span class="p">(</span><span class="dl">'</span><span class="s1">/socket/</span><span class="dl">'</span><span class="p">).</span><span class="nf">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">data</span><span class="dl">'</span><span class="p">,</span> <span class="nx">logs</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="configuration-crud">Configuration CRUD</h2>
<p>Since we did not want our configuration to be hard coded, we added some configuration screens to be able to change the time spans and entities (towers).</p>

<div style="text-align: center; margin:0px auto;">
    <a href="/img/stairwaytohealth/crud1.png" data-lightbox="crud" data-title="Entities CRUD">
        <img alt="crud1" src="/img/stairwaytohealth/crud1.png" class="image fit" style="width: 48%; display: inline-block;" />
    </a>
    <a href="/img/stairwaytohealth/crud2.png" data-lightbox="crud" data-title="Timespans CRUD">
        <img alt="crud2" src="/img/stairwaytohealth/crud2.png" class="image fit" style="width: 48%; display: inline-block;" />
    </a>
    <br />
</div>

<p>By the way, ‘gewicht’ in the first image stands for weight. 
To make sure the ratios are fair, we made sure that every tower has a ‘weight’ to multiply its log values by. 
These weights are calculated by the amount of employees/tower, with the largest tower having a weight of 1.</p>

<p>Let’s take a look at how we set up our backend structure for creating crud endpoints.
In our <code class="language-plaintext highlighter-rouge">/routes</code> directory we keep all files that define the urls and methods of every endpoint, and tell it which controller and method to use:<br />
<em>timespan.route.ts</em></p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">router</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/timespan/</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">,</span> <span class="nx">next</span><span class="p">:</span> <span class="nx">NextFunction</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">timespanController</span><span class="p">.</span><span class="nf">getTimespanList</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">router</span><span class="p">.</span><span class="nf">post</span><span class="p">((</span><span class="dl">'</span><span class="s1">/timespan/</span><span class="dl">'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">,</span> <span class="nx">next</span><span class="p">:</span> <span class="nx">NextFunction</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">timespanController</span><span class="p">.</span><span class="nf">createTimespan</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>next under our <code class="language-plaintext highlighter-rouge">/controllers</code> directory we have our controllers where all our functionality/logic is<br />
<em>timespan.controller.ts</em></p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="nf">getTimespanList</span><span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">,</span> <span class="nx">next</span><span class="p">:</span> <span class="nx">NextFunction</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">timespanModel</span><span class="p">.</span><span class="nf">find</span><span class="p">({},</span> <span class="p">[],</span> <span class="p">{</span><span class="na">sort</span><span class="p">:</span> <span class="p">{</span><span class="na">start</span><span class="p">:</span> <span class="mi">1</span><span class="p">}})</span>
    <span class="p">.</span><span class="nf">then</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nf">json</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nf">status</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
    <span class="p">},</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">statusMessage</span> <span class="o">=</span> <span class="nx">err</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nf">send</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="authentication">Authentication</h2>
<p>To prevent everyone from changing these configurations of course we had to add some authentication functionality. 
As you can see in the router code above, we created an authentication middleware so that on every route that we want the user to be authenticated, we can simply add <code class="language-plaintext highlighter-rouge">this.authenticate()</code> to the route. 
This checks a JWT token in the headers. 
We check the token to be valid. 
If it’s not valid, we send an <code class="language-plaintext highlighter-rouge">unauthorized</code> response, and if it is valid, we decode it and add it as a user object on the request. 
This way we can access it in the controller and do some logic depending on its role, etc.
<code class="language-plaintext highlighter-rouge">this.authenticate</code> is a method we added to the <code class="language-plaintext highlighter-rouge">core.route.ts</code>.
Every route extends this super class so that we can put common code and middleware in this file.</p>

<p>JWT stands for JSON Web Token and is a JSON-based open standard for creating access tokens that assert some number of claims. 
For example, a server could generate a token that has the claim <code class="language-plaintext highlighter-rouge">logged in as admin</code> and provide that to a client. 
The client could then use that token to prove that he is logged in as admin.</p>

<h2 id="deploy">Deploy</h2>
<p>Finally we deployed it to the Proximus data center and watched the Proximus employees take on the challenge.</p>

<div style="text-align: center; margin: 0px auto;">
    <a href="/img/stairwaytohealth/result1.jpg" data-lightbox="results" data-title="Large screen @ Proximus towers">
        <img alt="result1" src="/img/stairwaytohealth/result1.jpg" class="image fit" style="width: 61.45%; display: inline-block;" />
    </a>
    <a href="/img/stairwaytohealth/result2.jpg" data-lightbox="results" data-title="Informing the employees">
        <img alt="result2" src="/img/stairwaytohealth/result2.jpg" class="image fit" style="width: 34.55%; display: inline-block;" />
    </a>
</div>

<h2 id="conclusion">Conclusion</h2>
<p>After four hard weeks of working and writing many lines of code, we delivered our project to Proximus and the contest could start.
 Things we would have done differently:</p>
<ul>
  <li>Use mongo indexes and aggregation for large amounts of data</li>
  <li>Use javascript date in stead of timestamps in mongo, easier to create aggregate with dates</li>
  <li>Dockerize! So far, the most work has gone into getting the application deployed</li>
  <li>Implement I18N translations at the beginning, as it is better to add translations while working on the component</li>
  <li>Also we learned how complicated it can be to have one component with multiple switching charts. Instead of switching components.</li>
</ul>


        </div>
    </div>
    <div class="share-page" >
        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://ordina-jworks.github.io/iot/2017/10/12/Stairway-To-Health.html&title=Stairway to Health with IoT and the MEAN stack&source=https://ordina-jworks.github.io" rel="nofollow" target="_blank" title="Share on LinkedIN">
            <img src="/img/social-media/LinkedIn.png"
                 alt="Share on LinkedIn" />
        </a>
        <a href="https://twitter.com/intent/tweet?text=Stairway to Health with IoT and the MEAN stack&url=https://ordina-jworks.github.io/iot/2017/10/12/Stairway-To-Health.html&via=lifeatordinabe&related=lifeatordinabe" rel="nofollow" target="_blank" title="Share on Twitter">
            <img src="/img/social-media/Twitter.png"
                 alt="Share on Twitter" />
        </a>
        <a href="https://facebook.com/sharer.php?u=https://ordina-jworks.github.io/iot/2017/10/12/Stairway-To-Health.html" rel="nofollow" target="_blank" title="Share on Facebook">
            <img src="/img/social-media/Facebook.png"
                 alt="Share on Facebook" />
        </a>
    </div>
        
</section>


<section id="two" class="wrapper alt spotlight style2">
    
    <div class="inner">
        <a href="/author/michael-vervloet/" class="image spotlight-image" title="">
            <img src="/img/author/michael-vervloet.jpg"
                 alt="" class="p-image"/>
        </a>

        <div class="content">
            
            <p><p>Michael is a full stack JavaScript/TypeScript developer specialising himself in backend development with NodeJs and Express and has a solid background in frontend/hybrid mobile development. As a member of Ordina’s core ‘Internet of Things’ team he has collaborated on some challenging and innovative IoT applications.</p>
</p>
            
        </div>
    </div>
    
    <div class="inner">
        <a href="/author/ines-van-stappen/" class="image spotlight-image" title="">
            <img src="/img/author/ines-van-stappen.jpg"
                 alt="" class="p-image"/>
        </a>

        <div class="content">
            
            <p><p>Ines is a frontend developer, passionate about creating Angular applications. She is always open for trying new technologies or trying things in new and exciting ways.</p>
</p>
            
        </div>
    </div>
    
    <div class="inner">
        <a href="/author/kevin-van-den-abeele/" class="image spotlight-image" title="">
            <img src="/img/author/kevin-van-den-abeele.jpg"
                 alt="" class="p-image"/>
        </a>

        <div class="content">
            
            <p><p>Kevin is a senior consultant at Ordina, passionate about all modern web applications and smart tech. In his role as Competence Leader Smart Technologies he uses his knowledge of building custom software to build innovative solutions using new technologies. Loves to tinker with gadgets and electronics.</p>
</p>
            
        </div>
    </div>
    
</section>

        </div>
    </section>
</div>



<footer>
    <div class="contact">
        <div class="address">
            <div class="icon"><i class="fa fa-fw fa-home"></i></div>
            <div class="text">Ordina Belgium<br/>Blarenberglaan 3B,<br/>2800 Mechelen, Belgium</div>
        </div>
        <div class="phone">
            <div class="icon"><i class="fa fa-fw fa-phone"></i></div>
            <div class="text"><a href="tel:003215295858">+32 15 29 58 58</a></div>
        </div>
        <div class="email">
            <div class="icon"><i class="fa fa-fw fa-envelope-o"></i></div>
            <div class="text"><a href="mailto:jworks@ordina.be">jworks@ordina.be</a></div>
        </div>
    </div>
    <ul class="social">
        <li>
            <a href="https://www.facebook.com/lifeatordinabe" target="_blank">
                <i class=" fa fa-fw fa-facebook"></i><span>Facebook</span>
            </a>
        </li>
        <li>
            <a href="https://www.linkedin.com/company/ordinabelgium" target="_blank">
                <i class=" fa fa-fw fa-linkedin"></i><span>LinkedIn</span>
            </a>
        </li>
        <li>
            <a href="/youtube" target="_blank">
                <i class=" fa fa-fw fa-youtube"></i><span>YouTube</span>
            </a>
        </li>
        <li>
            <a href="/github" target="_blank">
                <i class=" fa fa-fw fa-github"></i><span>GitHub</span>
            </a>
        </li>
        <li>
            <a href="/feed.xml" target="_blank">
                <i class=" fa fa-fw fa-rss"></i><span>RSS Feed</span>
            </a>
        </li>
    </ul>
    <div class="copyright">
        &copy; 2023 Ordina JWorks. All rights reserved.
        <br /> Disclaimer: Opinions expressed on this blog reflect the writer's views and not the position of Ordina
        <img id="analyticsImg" src="" width="1" height="1" style="border: 0px"/>
    </div>
</footer>
<!-- Scripts -->
<script src="/js/jquery.min.js"></script>
<script src="/js/jquery.scrollex.min.js"></script>
<script src="/js/jquery.magnific-popup.min.js"></script>
<script src="/js/owl.carousel.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/skel.min.js"></script>
<script src="/js/jquery.pin.min.js"></script>
<script src="/js/util.js"></script>
<!--[if lte IE 8]>
<script src="/js/ie/respond.min.js"></script><![endif]-->


<script>
    var imageHref = "/img/stairwaytohealth/stairway-to-health.jpg";
    $(function () {
        $('body').addClass('toggle');
    });
</script>


<script src="/js/main.js"></script>

<!-- Google Analytics -->
<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o);
        m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m);
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'UA-70040502-1', 'auto');
    ga('send', 'pageview');
</script>
<script type="text/javascript">
    window.addEventListener('load', function () {
        if (window.ga && ga.create) {
            console.log('GA loaded correctly');
        } else {
            console.log('GA is blocked or failed to load - tracking manually...')
            document.getElementById('analyticsImg').src = 'https://jworks-techblog-analytics.cfapps.io/collect?title=' + document.title;
        }
    }, false);
</script>

<!-- Vertical timeline -->
<script src="/js/vertical-timeline/modernizr.js"></script>
<script src="/js/vertical-timeline/main.js"></script>


</body>
</html>
