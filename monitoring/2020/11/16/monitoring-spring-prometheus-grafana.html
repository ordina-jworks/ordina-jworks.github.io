<!DOCTYPE html>
<!--suppress ALL -->
<html>
<head>
        <meta charset="utf-8">
    <meta name="description" content="We build innovative solutions with Java and JavaScript. To support this mission, we have several Competence Centers. From within those Competence Centers, we provide coaching to the employee and expert advice towards our customer. In order to keep in sync with the latest technologies and the latest trends, we frequently visit conferences around the globe.
">
    <meta name="keywords" content="Ordina,ORAJ,JWorks,Blog,Java,JavaScript,TypeScript,Angular,DevOps">
    <meta name="author" content="Ordina Belgium">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/img/favicons/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/img/favicons/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/img/favicons/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/favicons/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="/img/favicons/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/img/favicons/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/img/favicons/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/img/favicons/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="/img/favicons/favicon-128.png" sizes="128x128" />

    

    <!-- Twitter Card data -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Monitoring Spring Boot with Prometheus and Grafana - Kevin Govaerts">
    <meta name="twitter:description" content="Ordina JWorks Tech Blog">
    <meta name="twitter:image" content="http://ordina-jworks.github.io/img/2020-11-16-monitoring-spring-prometheus-grafana/thumbnail.jpg"/>

    <!-- Facebook Open Graph -->
    <meta property="og:url" content="http://ordina-jworks.github.io/monitoring/2020/11/16/monitoring-spring-prometheus-grafana.html"/>
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Monitoring Spring Boot with Prometheus and Grafana - Kevin Govaerts"/>
    <meta property="og:description" content="Ordina JWorks Tech Blog"/>
    <meta property="og:image" content="http://ordina-jworks.github.io/img/2020-11-16-monitoring-spring-prometheus-grafana/thumbnail.jpg"/>

    
    <title>Monitoring Spring Boot with Prometheus and Grafana - Kevin Govaerts &mdash; Ordina JWorks Tech Blog</title>
    

        <!-- Styles -->
    <!-- Font awesome CSS -->
    <link href="/css/font-awesome.min.css" rel="stylesheet">
    <!-- Magnific Popup -->
    <link href="/css/magnific-popup.css" rel="stylesheet">
    <!-- Owl carousel -->
    <link href="/css/owl.carousel.css" rel="stylesheet">

    <!-- CSS for this page -->

    <!-- Syntax highlighting -->
    <link href="/css/syntax.css" rel="stylesheet">


    <!--[if lte IE 8]>
    <script src="/js/ie/html5shiv.js"></script><![endif]-->
    <link rel="stylesheet" href="/css/main.css"/>
    <!--[if lte IE 9]>
    <link rel="stylesheet" href="/css/ie9.css"/><![endif]-->
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="/css/ie8.css"/><![endif]-->

    <!-- Custom CSS. Type your CSS code in custom.css file -->
    <link href="/css/custom.css" rel="stylesheet">

    <!-- Vertical timeline -->
	<link rel="stylesheet" href="/css/vertical-timeline/style.css"> <!-- Resource style -->

    <!-- Favicon -->
    <link rel="shortcut icon" href="#">

    <script src="https://use.typekit.net/gzh0mbm.js"></script>
    <script>
        try {
            Typekit.load({async: true});
        } catch (e) {
        }
    </script>
</head>

<body>
<div id="header-image"></div>


<!-- Page Wrapper -->
<div id="page-wrapper">

        <!-- Header -->
    <header id="header">
        <h1>
            <a href="/">
                JWorks Tech Blog
            </a>
        </h1>

        <nav>
            <a href="#menu">Menu</a>
            <form action="/search/" method="get" class="header-search search-form">
                <input type="text" id="search-box-header" name="query" placeholder="Search &hellip;">
            </form>
        </nav>
    </header>

    <!-- Menu -->
    <nav id="menu">
        <div class="inner">
            <h2>Menu</h2>
            <ul class="links">
                <li class="menu-item"><a href="/">Home</a></li>
                <li class="menu-item"><a href="/about">About Us</a></li>
                <li class="menu-item"><a href="/meet-the-team">Meet the team</a></li>
                <li class="menu-item"><a href="/jobs">Jobs</a></li>
                <li class="menu-item"><a href="/search">Search</a></li>
                <li class="menu-item"><a href="https://join.ordina-jworks.io/">JOIN</a></li>
                <li class="menu-item"><a href="/contact">Contact Us</a></li>
            </ul>
            <a href="#" class="close">Close</a>
        </div>
    </nav>

    <section id="banner">
        <header>
            <div class="inner">
                

                <h2>Monitoring Spring Boot with Prometheus and Grafana</h2>
                

                
                    Posted Nov 16, 2020


    in <a href="/categories/monitoring/">Monitoring</a>



    by
    
        <a href="/author/kevin-govaerts/">Kevin Govaerts</a>
        
    



    <br/>
    <i class="fa fa-tags"></i>
    
        <a href="/tags/spring/">Spring</a>, 
    
        <a href="/tags/prometheus/">Prometheus</a>, 
    
        <a href="/tags/grafana/">Grafana</a>, 
    
        <a href="/tags/docker/">Docker</a>
    

                

                

            </div>
        </header>
    </section>


    <section id="wrapper">
        <div class="inner">
            <section id="one" class="wrapper spotlight style1 post-body">
    <div class="inner" style="text-align: left;">
        <div class="content">
            <h1 class="no_toc" id="table-of-contents">Table of contents</h1>

<ul id="markdown-toc">
  <li><a href="#introduction" id="markdown-toc-introduction">Introduction</a></li>
  <li><a href="#prometheus" id="markdown-toc-prometheus">Prometheus</a>    <ul>
      <li><a href="#what-is-prometheus" id="markdown-toc-what-is-prometheus">What is Prometheus?</a></li>
      <li><a href="#why-do-we-need-prometheus" id="markdown-toc-why-do-we-need-prometheus">Why do we need Prometheus?</a></li>
      <li><a href="#how-it-works" id="markdown-toc-how-it-works">How it works</a>        <ul>
          <li><a href="#prometheus-server" id="markdown-toc-prometheus-server">Prometheus server</a></li>
          <li><a href="#prometheus-targets" id="markdown-toc-prometheus-targets">Prometheus targets</a></li>
          <li><a href="#micrometer" id="markdown-toc-micrometer">Micrometer</a></li>
        </ul>
      </li>
      <li><a href="#configuring-prometheus" id="markdown-toc-configuring-prometheus">Configuring Prometheus</a></li>
    </ul>
  </li>
  <li><a href="#grafana" id="markdown-toc-grafana">Grafana</a>    <ul>
      <li><a href="#what-is-grafana" id="markdown-toc-what-is-grafana">What is Grafana</a></li>
      <li><a href="#why-grafana" id="markdown-toc-why-grafana">Why Grafana</a></li>
    </ul>
  </li>
  <li><a href="#demo-project" id="markdown-toc-demo-project">Demo project</a>    <ul>
      <li><a href="#setup-spring-boot" id="markdown-toc-setup-spring-boot">Setup Spring Boot</a>        <ul>
          <li><a href="#adding-our-own-custom-metrics" id="markdown-toc-adding-our-own-custom-metrics">Adding our own custom metrics</a>            <ul>
              <li><a href="#demometrics-class" id="markdown-toc-demometrics-class">DemoMetrics class</a></li>
              <li><a href="#demometricsscheduler-class" id="markdown-toc-demometricsscheduler-class">DemoMetricsScheduler class</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#setup-prometheus" id="markdown-toc-setup-prometheus">Setup Prometheus</a></li>
      <li><a href="#setup-grafana" id="markdown-toc-setup-grafana">Setup Grafana</a>        <ul>
          <li><a href="#adding-a-custom-metric-panel" id="markdown-toc-adding-a-custom-metric-panel">Adding a custom metric panel</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
</ul>

<hr />

<h1 id="introduction">Introduction</h1>

<p>In a distributed landscape where we are working with microservices, serverless applications, or just event-driven architecture as a whole, observability, which comprises monitoring, logging, tracing, and alerting, is an important architectural concern.</p>

<p>There are a few reasons why we want visibility in our highly distributed systems:</p>
<ul>
  <li>Issues will occur, even when our best employees have built it.</li>
  <li>Distributed systems generate distributed failures, which can be devastating when we are not prepared in advance.</li>
  <li>Reveal mistakes early, which is great for improvement and learning.</li>
  <li>It keeps us accountable.</li>
  <li>Reduce the mean time to resolution (MTTR).</li>
</ul>

<p>In this blogpost I will explain the core concepts of Prometheus and Grafana.<br />
In the last section I set up a demo project, so you can follow along and implement monitoring in your own applications.</p>

<h1 id="prometheus">Prometheus</h1>

<h2 id="what-is-prometheus">What is Prometheus?</h2>

<p>Prometheus, originally developed by SoundCloud is an open source and community-driven project that graduated from the Cloud Native Computing Foundation.
It can aggregate data from almost everything:</p>
<ul>
  <li>Microservices</li>
  <li>Multiple languages</li>
  <li>Linux servers</li>
  <li>Windows servers</li>
</ul>

<h2 id="why-do-we-need-prometheus">Why do we need Prometheus?</h2>

<p>In our modern times of microservices, DevOps is becoming more and more complex and therefore needs automation.<br />
We have hundreds of processes running over multiple servers, and they are all interconnected.</p>

<p>If we would not monitor these services then we have no clue about what is happening on hardware level or application level.<br />
There are many things which we want to be notified about, like:</p>
<ul>
  <li>Errors</li>
  <li>Response latency</li>
  <li>System overload</li>
  <li>Resources</li>
</ul>

<p>When we are working with so many moving pieces, we want to be able to quickly identify a problem when something goes wrong inside one of our services.<br />
If we wouldn’t monitor, it could be very time-consuming, since we have no idea where to look.</p>

<h3 class="no_toc" id="an-example-of-a-failing-service">An example of a failing service</h3>

<p>Imagine that one server ran out of memory and therefore knocked off a running service container, which syncs two databases.<br />
One of those databases gets used by the authentication service, which now also stops working, because the database is unavailable.</p>

<div style="text-align: center;">
  <img alt="prometheus server" src="/img/2020-11-16-monitoring-spring-prometheus-grafana/failing-servers.jpg" width="auto" height="auto" target="_blank" class="image" />
</div>

<p>How do you know what went wrong, when your application that depends on the authentication service, now can’t authenticate users anymore?<br />
The only thing we would see is an error message: <code class="language-plaintext highlighter-rouge">ERROR: Authentication failed</code>.<br />
We would need to work backwards over every service, all the way back to the stopped container, to find out what is causing the problem.</p>

<p>A better way would be to have a tool which:</p>
<ul>
  <li>Constantly monitors all services</li>
  <li>Alerts system admins when something crashes</li>
  <li>Identifies problems before they occur</li>
</ul>

<p>Prometheus is exactly that tool, it can identify memory usage, CPU usage, available disk space, etc.<br />
We can predefine certain thresholds about which we want to get notified.</p>

<p>In our example it could have been that the memory of our failing server would have reached 70% memory usage for more than one hour, and could’ve sent an alert to our admins before the crash happened.</p>

<h2 id="how-it-works">How it works</h2>

<h3 id="prometheus-server">Prometheus server</h3>

<p>The server does the actual monitoring work, and it consists of three main parts:</p>
<ul>
  <li>Storage, which is a time series database.</li>
  <li>Data retrieval worker, which is pulling the data from our target services.</li>
  <li>Webserver, which accepts <a href="https://prometheus.io/docs/prometheus/latest/querying/basics/" target="_blank" rel="noopener noreferrer">PromQL</a> queries to get data from our DB.</li>
</ul>

<div style="text-align: center;">
  <img alt="prometheus server" src="/img/2020-11-16-monitoring-spring-prometheus-grafana/prom-server.jpg" style="max-width: 100%; height:auto" target="_blank" class="image" />
</div>

<p>Even though Prometheus has its own UI to show graphs and metrics, we will be using Grafana as an extra layer on top of this webserver, to query and visualize our database.</p>

<h3 id="prometheus-targets">Prometheus targets</h3>

<h4 class="no_toc" id="what-does-it-monitor">What does it monitor?</h4>

<p>Prometheus monitors nearly anything. It could be a Linux/windows server, Apache server, single applications, services, etc.<br />
It monitors <strong>units</strong> on those targets like:</p>
<ul>
  <li>CPU usage</li>
  <li>Memory/ Disk usage</li>
  <li>Request count</li>
  <li>Request durations</li>
  <li>Exceptions count</li>
</ul>

<p>The units that we monitor are called metrics, which get saved into the Prometheus time-series database.<br />
Prometheus’ metrics are formatted like a human-readable text file.</p>

<div style="text-align: center;">
  <img alt="Prometheus endpoint actuator" src="/img/2020-11-16-monitoring-spring-prometheus-grafana/prometheus-endpoint.PNG" width="auto" height="auto" target="_blank" class="image fit" />
</div>

<p>In this file we can see that there is a “HELP” comment which describes what the metric is, and we have a “TYPE” which can be one of four metric-types:</p>
<ul>
  <li>Counter: how many times X happened (exceptions)</li>
  <li>Gauge: what is the current value of X now ? (disk usage, cpu etc)</li>
  <li>Histogram: how long or how big?</li>
  <li>Summary: similar to histogram it monitors request durations and response sizes</li>
</ul>

<h4 class="no_toc" id="collecting-metrics-from-targets">Collecting metrics from targets</h4>

<p>There are basically two ways of ingesting metrics into a monitoring system. <br />
We can either push the data from our clients to our monitoring system, or we pull the data from the monitoring system.</p>

<p>Prometheus is a service which polls a set of configured targets to intermittently fetch their metric values.<br />
In Prometheus terminology, this polling is called scraping.</p>

<p>There is no clear-cut answer about which one is the best, they both have their pros and cons, but some big disadvantages for pushing data are:</p>
<ul>
  <li>possibility of flooding the network.</li>
  <li>risk of package loss.</li>
</ul>

<div style="text-align: center;">
  <img alt="pull data image" src="/img/2020-11-16-monitoring-spring-prometheus-grafana/pull-data.jpg" style="max-width: 100%; height:auto" target="_blank" class="image" />
</div>

<p>The data which gets exposed on the endpoint needs to be in the correct format, one which Prometheus can understand.</p>

<p>As stated before, Prometheus can monitor a lot of different things, servers, services, databases, etc.<br />
Some servers even have a metrics endpoint enabled by default, so for those we don’t have to change anything.<br />
For the ones who don’t have an endpoint enabled by default, we need an exporter.</p>

<h4 class="no_toc" id="exporters">Exporters</h4>

<p>There are a number of libraries and servers which help in exporting existing metrics from third-party systems as Prometheus metrics.
You can have a look at the <a href="https://prometheus.io/docs/instrumenting/exporters/" target="_blank" rel="noopener noreferrer">exporters and integration tools</a> here.</p>

<p>On a side note, these tools are also available as Docker images, so we can use them inside Kubernetes clusters.<br />
We can run an exporter docker image for a MySQL database as a side container inside the MySQL pod, connect to it and start translating data, to expose it on the metrics endpoint.</p>

<h4 class="no_toc" id="monitoring-our-own-application">Monitoring our own application</h4>

<p>If we want to add our own instrumentation to our code, to know how many server resources our own application is using, how many requests it is handling or how many exceptions occurred, then we need to use one of the <a href="https://prometheus.io/docs/instrumenting/clientlibs/" target="_blank" rel="noopener noreferrer">client libraries</a>.
These libraries will enable us to declare all the metrics we deem important in our application, and expose them on the metrics endpoint.</p>

<h3 id="micrometer">Micrometer</h3>

<p>To monitor our Spring Boot application we will be using an exporter named Micrometer.<br />
Micrometer is an open-source project and provides a metric facade that exposes metric data in a vendor-neutral format which Prometheus can ingest.</p>

<blockquote>
  <p>Micrometer provides a simple facade over the instrumentation clients for the most popular monitoring systems, allowing you to instrument your JVM-based application code without vendor lock-in. Think SLF4J, but for metrics.</p>
</blockquote>

<p>Micrometer is not part of the Spring ecosystem and needs to be added as a dependency. In our demo application we will add this to our <code class="language-plaintext highlighter-rouge">pom.xml</code> file.
For a deeper understanding, check out our <a href="https://ordina-jworks.github.io/microservices/2017/09/17/monitoring-your-microservices-with-micrometer.html" target="_blank" rel="noopener noreferrer">blog post</a> about Micrometer.</p>

<h2 id="configuring-prometheus">Configuring Prometheus</h2>

<p>To instruct Prometheus on what it needs to scrape, we create a <strong>prometheus.yml</strong> configuration file.</p>

<div style="text-align: center;">
  <img alt="Prometheus configuration file" src="/img/2020-11-16-monitoring-spring-prometheus-grafana/promyml.PNG" width="auto" height="auto" target="_blank" class="image fit" />
</div>

<p>In this configuration file we declare a few things:</p>
<ol>
  <li>global configs, like how often it will scrape its targets.</li>
  <li>we can declare <a href="https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/" target="_blank" rel="noopener noreferrer">rule files</a>, so when we meet a certain condition, we get an alert.</li>
  <li>which services it needs to monitor.</li>
</ol>

<p>In this example you can see that Prometheus will monitor two things:</p>
<ul>
  <li>Our Spring Boot application</li>
  <li>Its own health</li>
</ul>

<p>Prometheus expects the data of our targets to be exposed on the <code class="language-plaintext highlighter-rouge">/metrics</code> endpoint, unless otherwise declared in the <code class="language-plaintext highlighter-rouge">metrics_path</code> field.</p>

<h3 class="no_toc" id="alerts">Alerts</h3>

<p>With Prometheus, we have the possibility to get notified when metrics have reached a certain point, which we can declare in the <code class="language-plaintext highlighter-rouge">.rules</code> files. 
Prometheus has a component which is called the “Alertmanager”, and it can send notifications over various channels like emails, Slack, PagerDuty, etc.</p>

<h3 class="no_toc" id="querying-our-data">Querying our data</h3>

<p>Since Prometheus saves all our data in a time series database, which is located on disk in a custom timeseries format, we need to use PromQL query language, if we want to query this database.</p>

<p>We can do this via the Prometheus WebUI, or we can use some more powerful visualization tools like Grafana.</p>

<h1 id="grafana">Grafana</h1>

<h2 id="what-is-grafana">What is Grafana</h2>

<p>Grafana is an open-source metric analytics &amp; visualization application.</p>
<ul>
  <li>It is used for visualizing time series data for infrastructure and application analytics.</li>
  <li>It is also a web application which can be deployed anywhere users want.</li>
  <li>It can target a data source from Prometheus and use its customizable panels to give users powerful visualization of the data from any infrastructure under management.</li>
</ul>

<h2 id="why-grafana">Why Grafana</h2>

<p>One of the significant advantages of Grafana are its customization possibilities.<br />
It’s effortless to customize the visualization for vast amounts of data.<br />
We can choose a linear graph, a single number panel, a gauge, a table, or a heatmap to display our data.<br />
We can also sort all our data with various labels so data with different labels will go to different panels.</p>

<p>Last but not least, there are a ton of <a href="https://grafana.com/grafana/dashboards" target="_blank" rel="noopener noreferrer">premade dashboard-templates</a> ready to be imported, so we don’t have to create everything manually.</p>

<h1 id="demo-project">Demo project</h1>

<h2 id="setup-spring-boot">Setup Spring Boot</h2>

<p>To demonstrate how to implement Prometheus and Grafana in your own projects, I will go through the steps to set up a basic Spring Boot application which we monitor by using Docker images of Prometheus and Grafana.</p>

<ol>
  <li>
    <p>Set up a regular Spring Boot application by using <a href="https://start.spring.io/" target="_blank" rel="noopener noreferrer">Spring Initializr</a>.</p>
  </li>
  <li>Add dependency for Actuator
    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     <span class="nt">&lt;dependency&gt;</span>
         <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
         <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
     <span class="nt">&lt;/dependency&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>Add dependency for Micrometer
    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     <span class="nt">&lt;dependency&gt;</span>
         <span class="nt">&lt;groupId&gt;</span>io.micrometer<span class="nt">&lt;/groupId&gt;</span>
         <span class="nt">&lt;artifactId&gt;</span>micrometer-registry-prometheus<span class="nt">&lt;/artifactId&gt;</span>
         <span class="nt">&lt;version&gt;</span>1.5.5<span class="nt">&lt;/version&gt;</span>
     <span class="nt">&lt;/dependency&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>Expose our needed Prometheus endpoint in the application.properties file
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>management.endpoints.web.exposure.include=prometheus
management.endpoint.health.show-details=always
management.metrics.tags.application= MonitoringSpringDemoProject
</code></pre></div>    </div>
  </li>
  <li>After this we can run the application and browse to <code class="language-plaintext highlighter-rouge">localhost:8080/actuator</code>, where we can see all the available endpoints. The one we need and will use to monitor this application, is <code class="language-plaintext highlighter-rouge">localhost:8080/actuator/prometheus</code>.</li>
</ol>

<div style="text-align: center;">
  <img alt="Prometheus endpoint actuator" src="/img/2020-11-16-monitoring-spring-prometheus-grafana/prometheus-endpoint.PNG" width="auto" height="auto" target="_blank" class="image fit" />
</div>

<h3 id="adding-our-own-custom-metrics">Adding our own custom metrics</h3>

<p>We can also define some custom metrics, which I will briefly demonstrate in this section.</p>

<p>To be able to monitor custom metrics we need to import <code class="language-plaintext highlighter-rouge">MeterRegistry</code> from the Micrometer library and inject it into our class. 
This gives us the possibility to use <a href="https://github.com/micrometer-metrics/micrometer/blob/master/micrometer-core/src/main/java/io/micrometer/core/instrument/Counter.java#L25" target="_blank" rel="noopener noreferrer">counters</a>, <a href="https://github.com/micrometer-metrics/micrometer/blob/master/micrometer-core/src/main/java/io/micrometer/core/instrument/Gauge.java#L23" target="_blank" rel="noopener noreferrer">gauges</a>, <a href="https://github.com/micrometer-metrics/micrometer/blob/master/micrometer-core/src/main/java/io/micrometer/core/instrument/Timer.java#L34" target="_blank" rel="noopener noreferrer">timers</a> and more.</p>

<p>To demonstrate how we can use this, I added two classes in our basic Spring application.<br />
DemoMetrics has a custom Counter and Gauge, which will get updated every second through our DemoMetricsScheduler class.<br />
The counter gets incremented by one, and the gauge will get a random number between 1 and 100.</p>

<h5 id="demometrics-class">DemoMetrics class</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DemoMetrics</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Counter</span> <span class="n">demoCounter</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AtomicInteger</span> <span class="n">demoGauge</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">DemoMetrics</span><span class="o">(</span><span class="nc">MeterRegistry</span> <span class="n">meterRegistry</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">demoCounter</span> <span class="o">=</span> <span class="n">meterRegistry</span><span class="o">.</span><span class="na">counter</span><span class="o">(</span><span class="s">"demo_counter"</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">demoGauge</span> <span class="o">=</span> <span class="n">meterRegistry</span><span class="o">.</span><span class="na">gauge</span><span class="o">(</span><span class="s">"demo_gauge"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">getRandomMetricsData</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">demoGauge</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">getRandomNumberInRange</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">100</span><span class="o">));</span>
        <span class="n">demoCounter</span><span class="o">.</span><span class="na">increment</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">getRandomNumberInRange</span><span class="o">(</span><span class="kt">int</span> <span class="n">min</span><span class="o">,</span> <span class="kt">int</span> <span class="n">max</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">min</span> <span class="o">&gt;=</span> <span class="n">max</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"max must be greater than min"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">Random</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="na">nextInt</span><span class="o">((</span><span class="n">max</span> <span class="o">-</span> <span class="n">min</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="n">min</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="demometricsscheduler-class">DemoMetricsScheduler class</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DemoMetricsScheduler</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">DemoMetrics</span> <span class="n">demoMetrics</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">DemoMetricsScheduler</span><span class="o">(</span><span class="nc">DemoMetrics</span> <span class="n">demoMetrics</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">demoMetrics</span> <span class="o">=</span> <span class="n">demoMetrics</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Scheduled</span><span class="o">(</span><span class="n">fixedRate</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">triggerCustomMetrics</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">demoMetrics</span><span class="o">.</span><span class="na">getRandomMetricsData</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Now we are able to see our custom metrics on the <code class="language-plaintext highlighter-rouge">/actuator/prometheus</code> endpoint, as you can see below.</p>

<div style="text-align: center;">
  <img alt="Prometheus custom metrics text" src="/img/2020-11-16-monitoring-spring-prometheus-grafana/custom_metrics.PNG" width="auto" height="auto" target="_blank" class="image fit" />
</div>

<h2 id="setup-prometheus">Setup Prometheus</h2>

<p>The easiest way to run Prometheus is via a Docker image which we can get by running:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull prom/prometheus
</code></pre></div></div>

<p>After we download the image, we need to configure our <code class="language-plaintext highlighter-rouge">prometheus.yml</code> file. 
Since I want to demonstrate how to monitor a Spring Boot application, as well as Prometheus itself, it should look like this:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">global</span><span class="pi">:</span>
    <span class="na">scrape_interval</span><span class="pi">:</span>     <span class="s">15s</span>

<span class="na">scrape_configs</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">prometheus'</span>
  <span class="na">scrape_interval</span><span class="pi">:</span> <span class="s">5s</span>

  <span class="na">static_configs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">localhost:9090'</span><span class="pi">]</span>

<span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">spring-actuator'</span>
  <span class="na">metrics_path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/actuator/prometheus'</span>
  <span class="na">scrape_interval</span><span class="pi">:</span> <span class="s">5s</span>
  <span class="na">static_configs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">192.168.0.9:8080'</span><span class="pi">]</span>
</code></pre></div></div>
<p>We define two targets which it needs to monitor, our Spring application and Prometheus.<br />
Since we run Prometheus from inside Docker we need to enter the host-ip which is in my case <code class="language-plaintext highlighter-rouge">192.168.0.9</code>.</p>

<p>Afterwards we can run the Prometheus image by running the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run -d -p 9090:9090 -v &lt;PATH_TO_prometheus.yml_FILE&gt;:/etc/prometheus/prometheus.yml prom/prometheus 
</code></pre></div></div>
<p>We mount the <code class="language-plaintext highlighter-rouge">prometheus.yml</code> config file into the Prometheus image and expose port 9090, to the outside of Docker.</p>

<p>When this is up and running we can access the Prometheus webUI on <code class="language-plaintext highlighter-rouge">localhost:9090</code>.</p>

<div style="text-align: center;">
  <img alt="Prometheus UI" src="/img/2020-11-16-monitoring-spring-prometheus-grafana/prometheusUI.PNG" width="auto" height="auto" target="_blank" class="image fit" />
</div>

<p>When we navigate to Status &gt; Targets, we can check if our connections are up and are correctly configured.</p>

<div style="text-align: center;">
  <img alt="Prometheus target tab" src="/img/2020-11-16-monitoring-spring-prometheus-grafana/prometheus-target.PNG" width="auto" height="auto" target="_blank" class="image fit" />
</div>

<p>Yet again, we can check our custom metrics in the Prometheus UI, by selecting the <code class="language-plaintext highlighter-rouge">demo_gauge</code> and inspecting our graph.</p>

<div style="text-align: center;">
  <img alt="Prometheus custom metrics graph" src="/img/2020-11-16-monitoring-spring-prometheus-grafana/custom-graph.PNG" width="auto" height="auto" target="_blank" class="image fit" />
</div>

<h2 id="setup-grafana">Setup Grafana</h2>

<p>To run Grafana we will use the same approach as with Prometheus.</p>

<p>We download and run the image from Docker Hub.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run -d -p 3000:3000 grafana/grafana
</code></pre></div></div>

<p>Now we can access the Grafana UI from <code class="language-plaintext highlighter-rouge">localhost:3000</code>, where you can enter “admin” as login and password.</p>
<div style="text-align: center;">
  <img alt="Grafana UI" src="/img/2020-11-16-monitoring-spring-prometheus-grafana/grafana-ui.PNG" width="auto" height="auto" target="_blank" class="image fit" />
</div>

<p>After we arrive at the landing page, we need to set up a data source for Grafana.<br />
Navigate to Configuration &gt; Data Sources, add a Prometheus data source and configure it like the example below.</p>

<div style="text-align: center;">
  <img alt="Grafana data source" src="/img/2020-11-16-monitoring-spring-prometheus-grafana/grafana-datasource.PNG" width="auto" height="auto" target="_blank" class="image fit" />
</div>

<p>For this example I used one of the premade dashboards which you can find on the <a href="https://grafana.com/grafana/dashboards" target="_blank" rel="noopener noreferrer">Grafana Dashboards</a> page.<br />
The dashboard I used to monitor our application is the JVM Micrometer dashboard with import id: 4701.</p>

<div style="text-align: center;">
  <img alt="Grafana data source" src="/img/2020-11-16-monitoring-spring-prometheus-grafana/grafana-import.PNG" width="650" height="auto" target="_blank" class="image fit" />
</div>

<p>Give your dashboard a custom name and select the prometheus data source we configured in step 3.<br />
Now we have a fully pre-configured dashboard, with some important metrics showcased, out of the box.</p>

<div style="text-align: center;">
  <img alt="Grafana dashboard" src="/img/2020-11-16-monitoring-spring-prometheus-grafana/graf-done.png" width="650" height="auto" target="_blank" class="image fit" />
</div>

<h3 id="adding-a-custom-metric-panel">Adding a custom metric panel</h3>

<p>To demonstrate how we can create a panel for one of our own custom metrics, I will list the required steps below.</p>

<p>First we need to add a panel by clicking on “add panel” on the top of the page, and yet again on “add new panel” in the center.</p>

<div style="text-align: center;">
   <img alt="Grafana add extra panel" src="/img/2020-11-16-monitoring-spring-prometheus-grafana/graf-add-panel.PNG" width="auto" height="auto" target="_blank" class="image fit" />
 </div>

<p>Then we need to configure our panel, which we do by selecting <code class="language-plaintext highlighter-rouge">demo_gauge</code> in the metrics field.<br />
To display our graph in a prettier way, we can choose the “stat” type under the visualization tab.</p>

<div style="text-align: center;">
   <img alt="Grafana add extra panel" src="/img/2020-11-16-monitoring-spring-prometheus-grafana/graf-custom-panel-gauge.PNG" width="auto" height="auto" target="_blank" class="image fit" />
 </div>

<p>When we click on <code class="language-plaintext highlighter-rouge">Apply</code> in the top right corner, our new panel gets added to the dashboard.</p>

<p>Afterwards, we can do the same thing for our <code class="language-plaintext highlighter-rouge">demo_counter</code> metric.</p>

<div style="text-align: center;">
   <img alt="Grafana add another extra panel" src="/img/2020-11-16-monitoring-spring-prometheus-grafana/graf-custom-panel-counter.PNG" width="auto" height="auto" target="_blank" class="image fit" />
 </div>

<p>After going through all of these steps, we now have an operational dashboard which monitors our Spring Boot application, with our own custom metrics.</p>

<div style="text-align: center;">
  <img alt="Grafana data source" src="/img/2020-11-16-monitoring-spring-prometheus-grafana/graf-dash.png" width="auto" height="auto" target="_blank" class="image fit" />
</div>

<h1 id="conclusion">Conclusion</h1>

<p>After reading this blogpost I hope you can see that using Prometheus as a data aggregator in a distributed system is not really all that hard.<br />
It has a lot of client libraries which integrate seamlessly with our infrastructure, services and applications.</p>

<p>Using Grafana on top of his to visualize our data, feels like a breeze when we use pre-existing dashboards to quickly get things up and running.</p>

        </div>
    </div>
    <div class="share-page" >
        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://ordina-jworks.github.io/monitoring/2020/11/16/monitoring-spring-prometheus-grafana.html&title=Monitoring Spring Boot with Prometheus and Grafana&source=https://ordina-jworks.github.io" rel="nofollow" target="_blank" title="Share on LinkedIN">
            <img src="/img/social-media/LinkedIn.png"
                 alt="Share on LinkedIn" />
        </a>
        <a href="https://twitter.com/intent/tweet?text=Monitoring Spring Boot with Prometheus and Grafana&url=https://ordina-jworks.github.io/monitoring/2020/11/16/monitoring-spring-prometheus-grafana.html&via=lifeatordinabe&related=lifeatordinabe" rel="nofollow" target="_blank" title="Share on Twitter">
            <img src="/img/social-media/Twitter.png"
                 alt="Share on Twitter" />
        </a>
        <a href="https://facebook.com/sharer.php?u=https://ordina-jworks.github.io/monitoring/2020/11/16/monitoring-spring-prometheus-grafana.html" rel="nofollow" target="_blank" title="Share on Facebook">
            <img src="/img/social-media/Facebook.png"
                 alt="Share on Facebook" />
        </a>
    </div>
        
</section>


<section id="two" class="wrapper alt spotlight style2">
    
    <div class="inner">
        <a href="/author/kevin-govaerts/" class="image spotlight-image" title="">
            <img src="/img/author/kevin-govaerts.jpg"
                 alt="" class="p-image"/>
        </a>

        <div class="content">
            
            <p><p>Kevin works as a back-end developer for Ordina Belgium, focussing mainly on Spring boot, Angular and AWS-technologies.</p>
</p>
            
        </div>
    </div>
    
</section>

        </div>
    </section>
</div>



<footer>
    <div class="contact">
        <div class="address">
            <div class="icon"><i class="fa fa-fw fa-home"></i></div>
            <div class="text">Ordina Belgium<br/>Blarenberglaan 3B,<br/>2800 Mechelen, Belgium</div>
        </div>
        <div class="phone">
            <div class="icon"><i class="fa fa-fw fa-phone"></i></div>
            <div class="text"><a href="tel:003215295858">+32 15 29 58 58</a></div>
        </div>
        <div class="email">
            <div class="icon"><i class="fa fa-fw fa-envelope-o"></i></div>
            <div class="text"><a href="mailto:jworks@ordina.be">jworks@ordina.be</a></div>
        </div>
    </div>
    <ul class="social">
        <li>
            <a href="https://www.facebook.com/lifeatordinabe" target="_blank">
                <i class=" fa fa-fw fa-facebook"></i><span>Facebook</span>
            </a>
        </li>
        <li>
            <a href="https://www.linkedin.com/company/ordinabelgium" target="_blank">
                <i class=" fa fa-fw fa-linkedin"></i><span>LinkedIn</span>
            </a>
        </li>
        <li>
            <a href="/youtube" target="_blank">
                <i class=" fa fa-fw fa-youtube"></i><span>YouTube</span>
            </a>
        </li>
        <li>
            <a href="/github" target="_blank">
                <i class=" fa fa-fw fa-github"></i><span>GitHub</span>
            </a>
        </li>
        <li>
            <a href="/feed.xml" target="_blank">
                <i class=" fa fa-fw fa-rss"></i><span>RSS Feed</span>
            </a>
        </li>
    </ul>
    <div class="copyright">
        &copy; 2023 Ordina JWorks. All rights reserved.
        <br /> Disclaimer: Opinions expressed on this blog reflect the writer's views and not the position of Ordina
        <img id="analyticsImg" src="" width="1" height="1" style="border: 0px"/>
    </div>
</footer>
<!-- Scripts -->
<script src="/js/jquery.min.js"></script>
<script src="/js/jquery.scrollex.min.js"></script>
<script src="/js/jquery.magnific-popup.min.js"></script>
<script src="/js/owl.carousel.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/skel.min.js"></script>
<script src="/js/jquery.pin.min.js"></script>
<script src="/js/util.js"></script>
<!--[if lte IE 8]>
<script src="/js/ie/respond.min.js"></script><![endif]-->


<script>
    var imageHref = "/img/2020-11-16-monitoring-spring-prometheus-grafana/thumbnail.jpg";
    $(function () {
        $('body').addClass('toggle');
    });
</script>


<script src="/js/main.js"></script>

<!-- Google Analytics -->
<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o);
        m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m);
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'UA-70040502-1', 'auto');
    ga('send', 'pageview');
</script>
<script type="text/javascript">
    window.addEventListener('load', function () {
        if (window.ga && ga.create) {
            console.log('GA loaded correctly');
        } else {
            console.log('GA is blocked or failed to load - tracking manually...')
            document.getElementById('analyticsImg').src = 'https://jworks-techblog-analytics.cfapps.io/collect?title=' + document.title;
        }
    }, false);
</script>

<!-- Vertical timeline -->
<script src="/js/vertical-timeline/modernizr.js"></script>
<script src="/js/vertical-timeline/main.js"></script>


</body>
</html>
